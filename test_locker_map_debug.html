<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯„å­˜ç‚¹åˆ†å¸ƒå›¾è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
        }
        .error {
            border-left: 4px solid #dc3545;
        }
        .warning {
            border-left: 4px solid #ffc107;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        .input-group input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 150px;
        }
        .status-bar {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ å¯„å­˜ç‚¹åˆ†å¸ƒå›¾è°ƒè¯•å·¥å…·</h1>
        
        <div class="status-bar">
            <div>è°ƒè¯•æ—¶é—´: <span id="debugTime"></span></div>
            <div>APIçŠ¶æ€: <span id="apiStatus">æœªæµ‹è¯•</span></div>
            <div>æ•°æ®åº“çŠ¶æ€: <span id="dbStatus">æœªçŸ¥</span></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” é—®é¢˜è¯Šæ–­</h3>
            <p>è¯Šæ–­å¯„å­˜ç‚¹åˆ†å¸ƒå›¾APIçš„500é”™è¯¯</p>
            
            <div class="input-group">
                <label>åŸå¸‚åç§°:</label>
                <input type="text" id="cityName" value="éƒ‘å·">
            </div>
            <div class="input-group">
                <label>åŒ—çº¬åº¦:</label>
                <input type="number" id="northLat" value="34.8466" step="0.0001">
            </div>
            <div class="input-group">
                <label>å—çº¬åº¦:</label>
                <input type="number" id="southLat" value="34.6466" step="0.0001">
            </div>
            <div class="input-group">
                <label>ä¸œç»åº¦:</label>
                <input type="number" id="eastLng" value="113.7253" step="0.0001">
            </div>
            <div class="input-group">
                <label>è¥¿ç»åº¦:</label>
                <input type="number" id="westLng" value="113.5253" step="0.0001">
            </div>
            
            <button class="test-button" onclick="testMapAPI()">ğŸ—ºï¸ æµ‹è¯•åˆ†å¸ƒå›¾API</button>
            <button class="test-button" onclick="testCityAPI()">ğŸ™ï¸ æµ‹è¯•åŸå¸‚API</button>
            <button class="test-button" onclick="testNearbyAPI()">ğŸ“ æµ‹è¯•é™„è¿‘API</button>
            <button class="test-button danger" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            
            <div id="testResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ æ•°æ®åº“æ£€æŸ¥</h3>
            <p>æ£€æŸ¥åç«¯æ•°æ®åº“ä¸­çš„æ•°æ®</p>
            
            <button class="test-button" onclick="checkCityData()">ğŸ™ï¸ æ£€æŸ¥åŸå¸‚æ•°æ®</button>
            <button class="test-button" onclick="checkLockerData()">ğŸª æ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®</button>
            <button class="test-button" onclick="suggestFix()">ğŸ’¡ ä¿®å¤å»ºè®®</button>
            
            <div id="dbResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ å¿«é€Ÿä¿®å¤</h3>
            <p>å°è¯•ä¿®å¤å¸¸è§é—®é¢˜</p>
            
            <button class="test-button" onclick="initTestData()">ğŸ“Š åˆå§‹åŒ–æµ‹è¯•æ•°æ®</button>
            <button class="test-button" onclick="testWithDifferentParams()">ğŸ”„ æµ‹è¯•ä¸åŒå‚æ•°</button>
            <button class="test-button" onclick="generateReport()">ğŸ“‹ ç”ŸæˆæŠ¥å‘Š</button>
            
            <div id="fixResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // æ›´æ–°è°ƒè¯•æ—¶é—´
        document.getElementById('debugTime').textContent = new Date().toLocaleString();
        
        // æµ‹è¯•åˆ†å¸ƒå›¾API
        async function testMapAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æµ‹è¯•å¯„å­˜ç‚¹åˆ†å¸ƒå›¾API...\n\n';
            
            const cityName = document.getElementById('cityName').value;
            const northLat = document.getElementById('northLat').value;
            const southLat = document.getElementById('southLat').value;
            const eastLng = document.getElementById('eastLng').value;
            const westLng = document.getElementById('westLng').value;
            
            const params = new URLSearchParams({
                city_name: cityName,
                north_lat: northLat,
                south_lat: southLat,
                east_lng: eastLng,
                west_lng: westLng,
                zoom_level: '12',
                enable_cluster: 'false'
            });
            
            const url = `${API_BASE_URL}/api/nearby/city/map?${params}`;
            resultDiv.textContent += `è¯·æ±‚URL: ${url}\n\n`;
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                resultDiv.textContent += `HTTPçŠ¶æ€ç : ${response.status} ${response.statusText}\n`;
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.textContent += 'âœ… APIè°ƒç”¨æˆåŠŸ\n\n';
                    resultDiv.textContent += `å“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`;
                    resultDiv.className = 'result success';
                    document.getElementById('apiStatus').textContent = 'æ­£å¸¸';
                } else {
                    const errorText = await response.text();
                    resultDiv.textContent += `âŒ APIè°ƒç”¨å¤±è´¥\n\n`;
                    resultDiv.textContent += `é”™è¯¯å“åº”:\n${errorText}`;
                    resultDiv.className = 'result error';
                    document.getElementById('apiStatus').textContent = 'é”™è¯¯';
                    
                    // åˆ†æé”™è¯¯åŸå› 
                    analyzeError(response.status, errorText);
                }
                
            } catch (error) {
                resultDiv.textContent += `âŒ ç½‘ç»œé”™è¯¯: ${error.message}\n`;
                resultDiv.className = 'result error';
                document.getElementById('apiStatus').textContent = 'ç½‘ç»œé”™è¯¯';
            }
        }
        
        // åˆ†æé”™è¯¯åŸå› 
        function analyzeError(status, errorText) {
            const resultDiv = document.getElementById('testResult');
            resultDiv.textContent += '\n=== é”™è¯¯åˆ†æ ===\n';
            
            if (status === 500) {
                resultDiv.textContent += 'ğŸ” HTTP 500é”™è¯¯é€šå¸¸è¡¨ç¤º:\n';
                resultDiv.textContent += '1. æ•°æ®åº“è¿æ¥é—®é¢˜\n';
                resultDiv.textContent += '2. åŸå¸‚æ•°æ®ä¸å­˜åœ¨\n';
                resultDiv.textContent += '3. å¯„å­˜ç‚¹æ•°æ®ä¸å­˜åœ¨\n';
                resultDiv.textContent += '4. åç«¯ä»£ç é€»è¾‘é”™è¯¯\n';
                resultDiv.textContent += '5. å‚æ•°éªŒè¯å¤±è´¥\n\n';
                
                if (errorText.includes('åŸå¸‚')) {
                    resultDiv.textContent += 'ğŸ’¡ å»ºè®®: æ£€æŸ¥åŸå¸‚æ•°æ®æ˜¯å¦å­˜åœ¨\n';
                } else if (errorText.includes('å¯„å­˜ç‚¹')) {
                    resultDiv.textContent += 'ğŸ’¡ å»ºè®®: æ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®æ˜¯å¦å­˜åœ¨\n';
                } else if (errorText.includes('æ•°æ®åº“')) {
                    resultDiv.textContent += 'ğŸ’¡ å»ºè®®: æ£€æŸ¥æ•°æ®åº“è¿æ¥\n';
                } else {
                    resultDiv.textContent += 'ğŸ’¡ å»ºè®®: æ£€æŸ¥åç«¯æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯\n';
                }
            } else if (status === 404) {
                resultDiv.textContent += 'ğŸ” HTTP 404é”™è¯¯è¡¨ç¤ºAPIç«¯ç‚¹ä¸å­˜åœ¨\n';
                resultDiv.textContent += 'ğŸ’¡ å»ºè®®: æ£€æŸ¥APIè·¯å¾„æ˜¯å¦æ­£ç¡®\n';
            } else if (status === 400) {
                resultDiv.textContent += 'ğŸ” HTTP 400é”™è¯¯è¡¨ç¤ºè¯·æ±‚å‚æ•°æœ‰é—®é¢˜\n';
                resultDiv.textContent += 'ğŸ’¡ å»ºè®®: æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼\n';
            }
        }
        
        // æµ‹è¯•åŸå¸‚API
        async function testCityAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æµ‹è¯•åŸå¸‚API...\n\n';
            
            const cityName = document.getElementById('cityName').value;
            
            try {
                // æµ‹è¯•åŸå¸‚åˆ—è¡¨API
                const listUrl = `${API_BASE_URL}/api/cities/list?page=1&page_size=10`;
                resultDiv.textContent += `1. æµ‹è¯•åŸå¸‚åˆ—è¡¨API: ${listUrl}\n`;
                
                const listResponse = await fetch(listUrl);
                resultDiv.textContent += `   çŠ¶æ€ç : ${listResponse.status}\n`;
                
                if (listResponse.ok) {
                    const listData = await listResponse.json();
                    resultDiv.textContent += `   âœ… åŸå¸‚åˆ—è¡¨è·å–æˆåŠŸï¼Œå…±${listData.cities ? listData.cities.length : 0}ä¸ªåŸå¸‚\n`;
                    
                    // æ£€æŸ¥ç›®æ ‡åŸå¸‚æ˜¯å¦å­˜åœ¨
                    if (listData.cities) {
                        const targetCity = listData.cities.find(city => city.name === cityName);
                        if (targetCity) {
                            resultDiv.textContent += `   âœ… æ‰¾åˆ°ç›®æ ‡åŸå¸‚: ${cityName}\n`;
                            resultDiv.textContent += `      åŸå¸‚ID: ${targetCity.id}\n`;
                            resultDiv.textContent += `      åæ ‡: (${targetCity.longitude}, ${targetCity.latitude})\n`;
                        } else {
                            resultDiv.textContent += `   âŒ æœªæ‰¾åˆ°ç›®æ ‡åŸå¸‚: ${cityName}\n`;
                            resultDiv.textContent += `   å¯ç”¨åŸå¸‚: ${listData.cities.map(c => c.name).join(', ')}\n`;
                        }
                    }
                } else {
                    resultDiv.textContent += `   âŒ åŸå¸‚åˆ—è¡¨è·å–å¤±è´¥\n`;
                }
                
                resultDiv.textContent += '\n';
                
                // æµ‹è¯•åŸå¸‚çƒ­ç‚¹API
                const hotspotUrl = `${API_BASE_URL}/api/cities/hotspots?city_name=${encodeURIComponent(cityName)}`;
                resultDiv.textContent += `2. æµ‹è¯•åŸå¸‚çƒ­ç‚¹API: ${hotspotUrl}\n`;
                
                const hotspotResponse = await fetch(hotspotUrl);
                resultDiv.textContent += `   çŠ¶æ€ç : ${hotspotResponse.status}\n`;
                
                if (hotspotResponse.ok) {
                    const hotspotData = await hotspotResponse.json();
                    resultDiv.textContent += `   âœ… åŸå¸‚çƒ­ç‚¹è·å–æˆåŠŸ\n`;
                } else {
                    resultDiv.textContent += `   âŒ åŸå¸‚çƒ­ç‚¹è·å–å¤±è´¥\n`;
                }
                
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.textContent += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // æµ‹è¯•é™„è¿‘API
        async function testNearbyAPI() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æµ‹è¯•é™„è¿‘API...\n\n';
            
            try {
                // æµ‹è¯•æˆ‘çš„é™„è¿‘API
                const nearbyUrl = `${API_BASE_URL}/api/nearby/my-nearby?longitude=113.6253&latitude=34.7466&radius=5&limit=10`;
                resultDiv.textContent += `æµ‹è¯•æˆ‘çš„é™„è¿‘API: ${nearbyUrl}\n`;
                
                const nearbyResponse = await fetch(nearbyUrl);
                resultDiv.textContent += `çŠ¶æ€ç : ${nearbyResponse.status}\n`;
                
                if (nearbyResponse.ok) {
                    const nearbyData = await nearbyResponse.json();
                    resultDiv.textContent += `âœ… é™„è¿‘APIè°ƒç”¨æˆåŠŸ\n`;
                    resultDiv.textContent += `æ‰¾åˆ°å¯„å­˜ç‚¹: ${nearbyData.nearby_points ? nearbyData.nearby_points.length : 0}ä¸ª\n`;
                    
                    if (nearbyData.nearby_points && nearbyData.nearby_points.length > 0) {
                        resultDiv.textContent += '\nå¯„å­˜ç‚¹ç¤ºä¾‹:\n';
                        const sample = nearbyData.nearby_points[0];
                        resultDiv.textContent += `- åç§°: ${sample.name}\n`;
                        resultDiv.textContent += `- åœ°å€: ${sample.address}\n`;
                        resultDiv.textContent += `- åæ ‡: (${sample.longitude}, ${sample.latitude})\n`;
                        document.getElementById('dbStatus').textContent = 'æœ‰æ•°æ®';
                    } else {
                        resultDiv.textContent += 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯„å­˜ç‚¹æ•°æ®\n';
                        document.getElementById('dbStatus').textContent = 'æ— æ•°æ®';
                    }
                } else {
                    resultDiv.textContent += `âŒ é™„è¿‘APIè°ƒç”¨å¤±è´¥\n`;
                    document.getElementById('dbStatus').textContent = 'é”™è¯¯';
                }
                
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.textContent += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // æ£€æŸ¥åŸå¸‚æ•°æ®
        async function checkCityData() {
            const resultDiv = document.getElementById('dbResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ£€æŸ¥åŸå¸‚æ•°æ®...\n\n';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/cities/list?page=1&page_size=50`);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.textContent += `âœ… åŸå¸‚æ•°æ®æ£€æŸ¥å®Œæˆ\n`;
                    resultDiv.textContent += `æ€»åŸå¸‚æ•°: ${data.total || 0}\n`;
                    resultDiv.textContent += `å½“å‰é¡µåŸå¸‚æ•°: ${data.cities ? data.cities.length : 0}\n\n`;
                    
                    if (data.cities && data.cities.length > 0) {
                        resultDiv.textContent += 'åŸå¸‚åˆ—è¡¨:\n';
                        data.cities.forEach((city, index) => {
                            resultDiv.textContent += `${index + 1}. ${city.name} (${city.longitude}, ${city.latitude})\n`;
                        });
                        
                        // æ£€æŸ¥ç›®æ ‡åŸå¸‚
                        const targetCity = document.getElementById('cityName').value;
                        const found = data.cities.find(city => city.name === targetCity);
                        if (found) {
                            resultDiv.textContent += `\nâœ… ç›®æ ‡åŸå¸‚ "${targetCity}" å­˜åœ¨äºæ•°æ®åº“ä¸­\n`;
                        } else {
                            resultDiv.textContent += `\nâŒ ç›®æ ‡åŸå¸‚ "${targetCity}" ä¸å­˜åœ¨äºæ•°æ®åº“ä¸­\n`;
                            resultDiv.textContent += `å»ºè®®ä½¿ç”¨ä»¥ä¸‹åŸå¸‚ä¹‹ä¸€: ${data.cities.slice(0, 5).map(c => c.name).join(', ')}\n`;
                        }
                    } else {
                        resultDiv.textContent += 'âŒ æ•°æ®åº“ä¸­æ²¡æœ‰åŸå¸‚æ•°æ®\n';
                    }
                    
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent += `âŒ æ— æ³•è·å–åŸå¸‚æ•°æ®ï¼ŒçŠ¶æ€ç : ${response.status}\n`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                resultDiv.textContent += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // æ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®
        async function checkLockerData() {
            const resultDiv = document.getElementById('dbResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®...\n\n';
            
            try {
                // ä½¿ç”¨é™„è¿‘APIæ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®
                const response = await fetch(`${API_BASE_URL}/api/nearby/my-nearby?longitude=113.6253&latitude=34.7466&radius=50&limit=100`);
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.textContent += `âœ… å¯„å­˜ç‚¹æ•°æ®æ£€æŸ¥å®Œæˆ\n`;
                    resultDiv.textContent += `æ‰¾åˆ°å¯„å­˜ç‚¹: ${data.nearby_points ? data.nearby_points.length : 0}ä¸ª\n`;
                    resultDiv.textContent += `æœç´¢åŠå¾„: ${data.search_radius || 'N/A'}km\n\n`;
                    
                    if (data.nearby_points && data.nearby_points.length > 0) {
                        resultDiv.textContent += 'å¯„å­˜ç‚¹ç¤ºä¾‹:\n';
                        data.nearby_points.slice(0, 5).forEach((point, index) => {
                            resultDiv.textContent += `${index + 1}. ${point.name}\n`;
                            resultDiv.textContent += `   åœ°å€: ${point.address}\n`;
                            resultDiv.textContent += `   åæ ‡: (${point.longitude}, ${point.latitude})\n`;
                            resultDiv.textContent += `   å¯ç”¨: å¤§${point.large_count || 0} ä¸­${point.medium_count || 0} å°${point.small_count || 0}\n\n`;
                        });
                        
                        if (data.nearby_points.length > 5) {
                            resultDiv.textContent += `... è¿˜æœ‰ ${data.nearby_points.length - 5} ä¸ªå¯„å­˜ç‚¹\n`;
                        }
                    } else {
                        resultDiv.textContent += 'âŒ æ•°æ®åº“ä¸­æ²¡æœ‰å¯„å­˜ç‚¹æ•°æ®\n';
                        resultDiv.textContent += 'è¿™å¯èƒ½æ˜¯åˆ†å¸ƒå›¾APIå¤±è´¥çš„ä¸»è¦åŸå› \n';
                    }
                    
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent += `âŒ æ— æ³•è·å–å¯„å­˜ç‚¹æ•°æ®ï¼ŒçŠ¶æ€ç : ${response.status}\n`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                resultDiv.textContent += `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // ä¿®å¤å»ºè®®
        function suggestFix() {
            const resultDiv = document.getElementById('dbResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result warning';
            resultDiv.textContent = 'ä¿®å¤å»ºè®®:\n\n';
            
            resultDiv.textContent += 'åŸºäºå¸¸è§çš„500é”™è¯¯ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥:\n\n';
            
            resultDiv.textContent += '1. æ£€æŸ¥æ•°æ®åº“è¿æ¥\n';
            resultDiv.textContent += '   - ç¡®ä¿æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ\n';
            resultDiv.textContent += '   - æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®\n\n';
            
            resultDiv.textContent += '2. æ£€æŸ¥åŸå¸‚æ•°æ®\n';
            resultDiv.textContent += '   - ç¡®ä¿citiesè¡¨ä¸­æœ‰æ•°æ®\n';
            resultDiv.textContent += '   - ç¡®ä¿ç›®æ ‡åŸå¸‚å­˜åœ¨\n\n';
            
            resultDiv.textContent += '3. æ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®\n';
            resultDiv.textContent += '   - ç¡®ä¿locker_pointsè¡¨ä¸­æœ‰æ•°æ®\n';
            resultDiv.textContent += '   - ç¡®ä¿å¯„å­˜ç‚¹æœ‰æ­£ç¡®çš„åæ ‡\n\n';
            
            resultDiv.textContent += '4. æ£€æŸ¥å‚æ•°éªŒè¯\n';
            resultDiv.textContent += '   - ç¡®ä¿è¾¹ç•Œåæ ‡æ­£ç¡®\n';
            resultDiv.textContent += '   - ç¡®ä¿åŒ—çº¬åº¦ > å—çº¬åº¦\n';
            resultDiv.textContent += '   - ç¡®ä¿ä¸œç»åº¦ > è¥¿ç»åº¦\n\n';
            
            resultDiv.textContent += '5. æ£€æŸ¥åç«¯æ—¥å¿—\n';
            resultDiv.textContent += '   - æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯å †æ ˆ\n';
            resultDiv.textContent += '   - æ£€æŸ¥SQLæŸ¥è¯¢æ˜¯å¦æ­£ç¡®\n\n';
            
            resultDiv.textContent += '6. åˆå§‹åŒ–æµ‹è¯•æ•°æ®\n';
            resultDiv.textContent += '   - ç‚¹å‡»"åˆå§‹åŒ–æµ‹è¯•æ•°æ®"æŒ‰é’®\n';
            resultDiv.textContent += '   - æˆ–æ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ•°æ®åˆ°æ•°æ®åº“\n';
        }
        
        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
        async function initTestData() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'åˆå§‹åŒ–æµ‹è¯•æ•°æ®...\n\n';
            
            try {
                // å°è¯•è°ƒç”¨åˆå§‹åŒ–æ¥å£
                const response = await fetch(`${API_BASE_URL}/api/admin/nearby/init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.textContent += 'âœ… æµ‹è¯•æ•°æ®åˆå§‹åŒ–æˆåŠŸ\n';
                    resultDiv.textContent += `å“åº”: ${JSON.stringify(data, null, 2)}\n`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent += `âŒ åˆå§‹åŒ–å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}\n`;
                    const errorText = await response.text();
                    resultDiv.textContent += `é”™è¯¯ä¿¡æ¯: ${errorText}\n`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                resultDiv.textContent += `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}\n`;
                resultDiv.textContent += '\nå¦‚æœåˆå§‹åŒ–æ¥å£ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹SQL:\n\n';
                resultDiv.textContent += generateTestDataSQL();
                resultDiv.className = 'result warning';
            }
        }
        
        // ç”Ÿæˆæµ‹è¯•æ•°æ®SQL
        function generateTestDataSQL() {
            return `-- æ’å…¥æµ‹è¯•åŸå¸‚æ•°æ®
INSERT INTO cities (name, longitude, latitude, status) VALUES 
('éƒ‘å·', 113.6253, 34.7466, 1),
('åŒ—äº¬', 116.4074, 39.9042, 1),
('ä¸Šæµ·', 121.4737, 31.2304, 1);

-- æ’å…¥æµ‹è¯•å¯„å­˜ç‚¹æ•°æ®
INSERT INTO locker_points (name, address, longitude, latitude, location_id, available_large, available_medium, available_small, open_time, mobile) VALUES 
('éƒ‘å·ç«è½¦ç«™å¯„å­˜ç‚¹', 'éƒ‘å·å¸‚äºŒä¸ƒåŒºç«è½¦ç«™å¹¿åœº', 113.6253, 34.7466, 1, 5, 10, 15, '24å°æ—¶', '13800000001'),
('éƒ‘å·ä¸œç«™å¯„å­˜ç‚¹', 'éƒ‘å·å¸‚é‡‘æ°´åŒºéƒ‘å·ä¸œç«™', 113.7253, 34.7566, 1, 3, 8, 12, '06:00-23:00', '13800000002'),
('äºŒä¸ƒå¹¿åœºå¯„å­˜ç‚¹', 'éƒ‘å·å¸‚äºŒä¸ƒåŒºäºŒä¸ƒå¹¿åœº', 113.6353, 34.7366, 1, 4, 6, 10, '24å°æ—¶', '13800000003');`;
        }
        
        // æµ‹è¯•ä¸åŒå‚æ•°
        async function testWithDifferentParams() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æµ‹è¯•ä¸åŒå‚æ•°ç»„åˆ...\n\n';
            
            const testCases = [
                { name: 'éƒ‘å·', north: 34.8466, south: 34.6466, east: 113.7253, west: 113.5253 },
                { name: 'åŒ—äº¬', north: 40.0042, south: 39.8042, east: 116.5074, west: 116.3074 },
                { name: 'ä¸Šæµ·', north: 31.3304, south: 31.1304, east: 121.5737, west: 121.3737 }
            ];
            
            for (const testCase of testCases) {
                resultDiv.textContent += `æµ‹è¯•åŸå¸‚: ${testCase.name}\n`;
                
                const params = new URLSearchParams({
                    city_name: testCase.name,
                    north_lat: testCase.north.toString(),
                    south_lat: testCase.south.toString(),
                    east_lng: testCase.east.toString(),
                    west_lng: testCase.west.toString(),
                    zoom_level: '12',
                    enable_cluster: 'false'
                });
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/nearby/city/map?${params}`);
                    resultDiv.textContent += `  çŠ¶æ€ç : ${response.status}\n`;
                    
                    if (response.ok) {
                        const data = await response.json();
                        resultDiv.textContent += `  âœ… æˆåŠŸï¼Œæ‰¾åˆ°${data.total_count || 0}ä¸ªå¯„å­˜ç‚¹\n`;
                    } else {
                        resultDiv.textContent += `  âŒ å¤±è´¥\n`;
                    }
                } catch (error) {
                    resultDiv.textContent += `  âŒ ç½‘ç»œé”™è¯¯: ${error.message}\n`;
                }
                
                resultDiv.textContent += '\n';
                
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            resultDiv.textContent += 'æµ‹è¯•å®Œæˆï¼\n';
            resultDiv.className = 'result success';
        }
        
        // ç”ŸæˆæŠ¥å‘Š
        function generateReport() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const apiStatus = document.getElementById('apiStatus').textContent;
            const dbStatus = document.getElementById('dbStatus').textContent;
            
            resultDiv.textContent = `å¯„å­˜ç‚¹åˆ†å¸ƒå›¾é—®é¢˜è¯Šæ–­æŠ¥å‘Š\n`;
            resultDiv.textContent += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n\n`;
            
            resultDiv.textContent += `=== çŠ¶æ€æ‘˜è¦ ===\n`;
            resultDiv.textContent += `APIçŠ¶æ€: ${apiStatus}\n`;
            resultDiv.textContent += `æ•°æ®åº“çŠ¶æ€: ${dbStatus}\n\n`;
            
            resultDiv.textContent += `=== é—®é¢˜åˆ†æ ===\n`;
            if (apiStatus === 'é”™è¯¯') {
                resultDiv.textContent += `âŒ åˆ†å¸ƒå›¾APIè¿”å›500é”™è¯¯\n`;
                resultDiv.textContent += `   è¿™é€šå¸¸è¡¨ç¤ºåç«¯å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸\n\n`;
            }
            
            if (dbStatus === 'æ— æ•°æ®') {
                resultDiv.textContent += `âŒ æ•°æ®åº“ä¸­ç¼ºå°‘å¯„å­˜ç‚¹æ•°æ®\n`;
                resultDiv.textContent += `   è¿™æ˜¯å¯¼è‡´APIå¤±è´¥çš„å¯èƒ½åŸå› \n\n`;
            }
            
            resultDiv.textContent += `=== ä¿®å¤æ­¥éª¤ ===\n`;
            resultDiv.textContent += `1. æ£€æŸ¥åç«¯æœåŠ¡æ—¥å¿—ï¼ŒæŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯\n`;
            resultDiv.textContent += `2. ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸\n`;
            resultDiv.textContent += `3. æ£€æŸ¥citiesè¡¨å’Œlocker_pointsè¡¨æ˜¯å¦æœ‰æ•°æ®\n`;
            resultDiv.textContent += `4. å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿è¡Œåˆå§‹åŒ–è„šæœ¬\n`;
            resultDiv.textContent += `5. é‡æ–°æµ‹è¯•APIæ¥å£\n\n`;
            
            resultDiv.textContent += `=== è”ç³»ä¿¡æ¯ ===\n`;
            resultDiv.textContent += `å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯:\n`;
            resultDiv.textContent += `- åç«¯æœåŠ¡æ—¥å¿—\n`;
            resultDiv.textContent += `- æ•°æ®åº“è¡¨ç»“æ„å’Œæ•°æ®\n`;
            resultDiv.textContent += `- APIè¯·æ±‚å’Œå“åº”è¯¦æƒ…\n`;
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('dbResult').style.display = 'none';
            document.getElementById('fixResult').style.display = 'none';
            
            document.getElementById('apiStatus').textContent = 'æœªæµ‹è¯•';
            document.getElementById('dbStatus').textContent = 'æœªçŸ¥';
        }
    </script>
</body>
</html>