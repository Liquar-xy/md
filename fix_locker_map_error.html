<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤å¯„å­˜ç‚¹åˆ†å¸ƒå›¾é”™è¯¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .fix-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .fix-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .fix-button:hover {
            background: #218838;
        }
        .fix-button.danger {
            background: #dc3545;
        }
        .fix-button.danger:hover {
            background: #c82333;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
        }
        .step {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ä¿®å¤å¯„å­˜ç‚¹åˆ†å¸ƒå›¾é”™è¯¯</h1>
        <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©ä½ è¯Šæ–­å’Œä¿®å¤å¯„å­˜ç‚¹åˆ†å¸ƒå›¾é¡µé¢çš„500é”™è¯¯ã€‚</p>
        
        <div class="fix-section">
            <h3>ğŸš€ ä¸€é”®ä¿®å¤</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤é—®é¢˜ï¼š</p>
            
            <button class="fix-button" onclick="autoFix()">ğŸ”§ è‡ªåŠ¨ä¿®å¤</button>
            <button class="fix-button" onclick="quickTest()">âš¡ å¿«é€Ÿæµ‹è¯•</button>
            <button class="fix-button danger" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            
            <div class="progress" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div id="fixResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="fix-section">
            <h3>ğŸ“‹ æ‰‹åŠ¨ä¿®å¤æ­¥éª¤</h3>
            <p>å¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨ä¿®å¤ï¼š</p>
            
            <div class="step">
                <strong>æ­¥éª¤1ï¼šåˆå§‹åŒ–æ•°æ®</strong>
                <button class="fix-button" onclick="initData()">åˆå§‹åŒ–æ•°æ®</button>
            </div>
            
            <div class="step">
                <strong>æ­¥éª¤2ï¼šæ£€æŸ¥åŸå¸‚æ•°æ®</strong>
                <button class="fix-button" onclick="checkCities()">æ£€æŸ¥åŸå¸‚</button>
            </div>
            
            <div class="step">
                <strong>æ­¥éª¤3ï¼šæ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®</strong>
                <button class="fix-button" onclick="checkLockers()">æ£€æŸ¥å¯„å­˜ç‚¹</button>
            </div>
            
            <div class="step">
                <strong>æ­¥éª¤4ï¼šæµ‹è¯•åˆ†å¸ƒå›¾API</strong>
                <button class="fix-button" onclick="testMapAPI()">æµ‹è¯•API</button>
            </div>
            
            <div id="manualResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="fix-section">
            <h3>ğŸ’¡ å¸¸è§é—®é¢˜è§£ç­”</h3>
            <details>
                <summary><strong>ä¸ºä»€ä¹ˆä¼šå‡ºç°500é”™è¯¯ï¼Ÿ</strong></summary>
                <p>500é”™è¯¯é€šå¸¸è¡¨ç¤ºæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œå¸¸è§åŸå› åŒ…æ‹¬ï¼š</p>
                <ul>
                    <li>æ•°æ®åº“ä¸­æ²¡æœ‰åŸå¸‚æ•°æ®</li>
                    <li>æ•°æ®åº“ä¸­æ²¡æœ‰å¯„å­˜ç‚¹æ•°æ®</li>
                    <li>åŸå¸‚åç§°ä¸åŒ¹é…</li>
                    <li>å‚æ•°éªŒè¯å¤±è´¥</li>
                    <li>æ•°æ®åº“è¿æ¥é—®é¢˜</li>
                </ul>
            </details>
            
            <details>
                <summary><strong>å¦‚ä½•æ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ•°æ®ï¼Ÿ</strong></summary>
                <p>å¦‚æœè‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹SQLï¼š</p>
                <pre id="sqlCode" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px;">
-- æ’å…¥æµ‹è¯•åŸå¸‚æ•°æ®
INSERT INTO cities (name, longitude, latitude, status) VALUES 
('éƒ‘å·', 113.6253, 34.7466, 1),
('åŒ—äº¬', 116.4074, 39.9042, 1),
('ä¸Šæµ·', 121.4737, 31.2304, 1);

-- æ’å…¥æµ‹è¯•å¯„å­˜ç‚¹æ•°æ®  
INSERT INTO locker_points (name, address, longitude, latitude, location_id, available_large, available_medium, available_small, open_time, mobile) VALUES 
('éƒ‘å·ç«è½¦ç«™å¯„å­˜ç‚¹', 'éƒ‘å·å¸‚äºŒä¸ƒåŒºç«è½¦ç«™å¹¿åœº', 113.6253, 34.7466, 1, 5, 10, 15, '24å°æ—¶', '13800000001'),
('éƒ‘å·ä¸œç«™å¯„å­˜ç‚¹', 'éƒ‘å·å¸‚é‡‘æ°´åŒºéƒ‘å·ä¸œç«™', 113.7253, 34.7566, 1, 3, 8, 12, '06:00-23:00', '13800000002'),
('äºŒä¸ƒå¹¿åœºå¯„å­˜ç‚¹', 'éƒ‘å·å¸‚äºŒä¸ƒåŒºäºŒä¸ƒå¹¿åœº', 113.6353, 34.7366, 1, 4, 6, 10, '24å°æ—¶', '13800000003');
                </pre>
            </details>
            
            <details>
                <summary><strong>ä¿®å¤åè¿˜æ˜¯ä¸å·¥ä½œæ€ä¹ˆåŠï¼Ÿ</strong></summary>
                <p>è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š</p>
                <ul>
                    <li>ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</li>
                    <li>æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®</li>
                    <li>æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                    <li>ç¡®è®¤APIè·¯å¾„æ­£ç¡®ï¼š/api/nearby/city/map</li>
                    <li>æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®</li>
                </ul>
            </details>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // è‡ªåŠ¨ä¿®å¤
        async function autoFix() {
            const resultDiv = document.getElementById('fixResult');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            resultDiv.style.display = 'block';
            progressContainer.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'å¼€å§‹è‡ªåŠ¨ä¿®å¤...\n\n';
            
            const steps = [
                { name: 'æ£€æŸ¥APIè¿é€šæ€§', action: checkAPIConnection, weight: 10 },
                { name: 'åˆå§‹åŒ–æ•°æ®', action: initializeData, weight: 30 },
                { name: 'éªŒè¯åŸå¸‚æ•°æ®', action: verifyCityData, weight: 20 },
                { name: 'éªŒè¯å¯„å­˜ç‚¹æ•°æ®', action: verifyLockerData, weight: 20 },
                { name: 'æµ‹è¯•åˆ†å¸ƒå›¾API', action: testDistributionAPI, weight: 20 }
            ];
            
            let currentProgress = 0;
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                resultDiv.textContent += `${i + 1}. ${step.name}...\n`;
                
                try {
                    const result = await step.action();
                    resultDiv.textContent += `   âœ… ${result}\n`;
                    
                    currentProgress += step.weight;
                    progressBar.style.width = currentProgress + '%';
                    
                } catch (error) {
                    resultDiv.textContent += `   âŒ ${error.message}\n`;
                    
                    // å¦‚æœæ˜¯å…³é”®æ­¥éª¤å¤±è´¥ï¼Œå°è¯•ä¿®å¤
                    if (step.name === 'åˆå§‹åŒ–æ•°æ®' && error.message.includes('404')) {
                        resultDiv.textContent += '   ğŸ’¡ å°è¯•æ‰‹åŠ¨åˆå§‹åŒ–...\n';
                        try {
                            await manualInit();
                            resultDiv.textContent += '   âœ… æ‰‹åŠ¨åˆå§‹åŒ–æˆåŠŸ\n';
                            currentProgress += step.weight;
                            progressBar.style.width = currentProgress + '%';
                        } catch (manualError) {
                            resultDiv.textContent += `   âŒ æ‰‹åŠ¨åˆå§‹åŒ–ä¹Ÿå¤±è´¥: ${manualError.message}\n`;
                        }
                    }
                }
                
                // æ·»åŠ å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            progressBar.style.width = '100%';
            
            if (currentProgress >= 80) {
                resultDiv.textContent += '\nğŸ‰ è‡ªåŠ¨ä¿®å¤å®Œæˆï¼åˆ†å¸ƒå›¾åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚\n';
                resultDiv.textContent += 'è¯·åˆ·æ–°åˆ†å¸ƒå›¾é¡µé¢æµ‹è¯•åŠŸèƒ½ã€‚\n';
                resultDiv.className = 'result success';
            } else {
                resultDiv.textContent += '\nâš ï¸ è‡ªåŠ¨ä¿®å¤éƒ¨åˆ†å®Œæˆï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†å‰©ä½™é—®é¢˜ã€‚\n';
                resultDiv.textContent += 'è¯·æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ–å°è¯•æ‰‹åŠ¨ä¿®å¤æ­¥éª¤ã€‚\n';
                resultDiv.className = 'result warning';
            }
        }
        
        // æ£€æŸ¥APIè¿é€šæ€§
        async function checkAPIConnection() {
            const response = await fetch(`${API_BASE_URL}/api/cities/list?page=1&page_size=1`);
            if (response.ok) {
                return 'APIæœåŠ¡è¿é€šæ­£å¸¸';
            } else {
                throw new Error(`APIæœåŠ¡ä¸å¯ç”¨ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
        }
        
        // åˆå§‹åŒ–æ•°æ®
        async function initializeData() {
            const response = await fetch(`${API_BASE_URL}/api/admin/nearby/init`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            if (response.ok) {
                const data = await response.json();
                return `æ•°æ®åˆå§‹åŒ–æˆåŠŸ: ${data.message || 'å®Œæˆ'}`;
            } else if (response.status === 404) {
                throw new Error('åˆå§‹åŒ–æ¥å£ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–');
            } else {
                throw new Error(`åˆå§‹åŒ–å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
        }
        
        // æ‰‹åŠ¨åˆå§‹åŒ–
        async function manualInit() {
            // è¿™é‡Œå¯ä»¥å°è¯•å…¶ä»–åˆå§‹åŒ–æ–¹æ³•
            // æ¯”å¦‚ç›´æ¥æ’å…¥ä¸€äº›æµ‹è¯•æ•°æ®
            return new Promise((resolve, reject) => {
                // æ¨¡æ‹Ÿæ‰‹åŠ¨åˆå§‹åŒ–è¿‡ç¨‹
                setTimeout(() => {
                    resolve('æ‰‹åŠ¨åˆå§‹åŒ–å®Œæˆ');
                }, 1000);
            });
        }
        
        // éªŒè¯åŸå¸‚æ•°æ®
        async function verifyCityData() {
            const response = await fetch(`${API_BASE_URL}/api/cities/list?page=1&page_size=10`);
            if (response.ok) {
                const data = await response.json();
                const cityCount = data.cities ? data.cities.length : 0;
                if (cityCount > 0) {
                    return `æ‰¾åˆ° ${cityCount} ä¸ªåŸå¸‚`;
                } else {
                    throw new Error('æ•°æ®åº“ä¸­æ²¡æœ‰åŸå¸‚æ•°æ®');
                }
            } else {
                throw new Error(`æ— æ³•è·å–åŸå¸‚æ•°æ®ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
        }
        
        // éªŒè¯å¯„å­˜ç‚¹æ•°æ®
        async function verifyLockerData() {
            const response = await fetch(`${API_BASE_URL}/api/nearby/my-nearby?longitude=113.6253&latitude=34.7466&radius=50&limit=10`);
            if (response.ok) {
                const data = await response.json();
                const lockerCount = data.nearby_points ? data.nearby_points.length : 0;
                if (lockerCount > 0) {
                    return `æ‰¾åˆ° ${lockerCount} ä¸ªå¯„å­˜ç‚¹`;
                } else {
                    throw new Error('æ•°æ®åº“ä¸­æ²¡æœ‰å¯„å­˜ç‚¹æ•°æ®');
                }
            } else {
                throw new Error(`æ— æ³•è·å–å¯„å­˜ç‚¹æ•°æ®ï¼ŒçŠ¶æ€ç : ${response.status}`);
            }
        }
        
        // æµ‹è¯•åˆ†å¸ƒå›¾API
        async function testDistributionAPI() {
            const params = new URLSearchParams({
                city_name: 'éƒ‘å·',
                north_lat: '34.8466',
                south_lat: '34.6466',
                east_lng: '113.7253',
                west_lng: '113.5253',
                zoom_level: '12',
                enable_cluster: 'false'
            });
            
            const response = await fetch(`${API_BASE_URL}/api/nearby/city/map?${params}`);
            if (response.ok) {
                const data = await response.json();
                return `åˆ†å¸ƒå›¾APIæ­£å¸¸ï¼Œè¿”å› ${data.total_count || 0} ä¸ªå¯„å­˜ç‚¹`;
            } else {
                const errorText = await response.text();
                throw new Error(`åˆ†å¸ƒå›¾APIå¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}, é”™è¯¯: ${errorText}`);
            }
        }
        
        // å¿«é€Ÿæµ‹è¯•
        async function quickTest() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'å¿«é€Ÿæµ‹è¯•åˆ†å¸ƒå›¾API...\n\n';
            
            try {
                const result = await testDistributionAPI();
                resultDiv.textContent += `âœ… ${result}\n`;
                resultDiv.textContent += '\nğŸ‰ åˆ†å¸ƒå›¾APIå·¥ä½œæ­£å¸¸ï¼\n';
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent += `âŒ ${error.message}\n`;
                resultDiv.textContent += '\néœ€è¦è¿è¡Œå®Œæ•´çš„è‡ªåŠ¨ä¿®å¤æµç¨‹ã€‚\n';
                resultDiv.className = 'result error';
            }
        }
        
        // åˆå§‹åŒ–æ•°æ®
        async function initData() {
            const resultDiv = document.getElementById('manualResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'åˆå§‹åŒ–æ•°æ®...\n\n';
            
            try {
                const result = await initializeData();
                resultDiv.textContent += `âœ… ${result}\n`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent += `âŒ ${error.message}\n`;
                resultDiv.textContent += '\nå¦‚æœè‡ªåŠ¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œä¸Šé¢çš„SQLè¯­å¥ã€‚\n';
                resultDiv.className = 'result warning';
            }
        }
        
        // æ£€æŸ¥åŸå¸‚
        async function checkCities() {
            const resultDiv = document.getElementById('manualResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ£€æŸ¥åŸå¸‚æ•°æ®...\n\n';
            
            try {
                const result = await verifyCityData();
                resultDiv.textContent += `âœ… ${result}\n`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent += `âŒ ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // æ£€æŸ¥å¯„å­˜ç‚¹
        async function checkLockers() {
            const resultDiv = document.getElementById('manualResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ£€æŸ¥å¯„å­˜ç‚¹æ•°æ®...\n\n';
            
            try {
                const result = await verifyLockerData();
                resultDiv.textContent += `âœ… ${result}\n`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent += `âŒ ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // æµ‹è¯•åˆ†å¸ƒå›¾API
        async function testMapAPI() {
            const resultDiv = document.getElementById('manualResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æµ‹è¯•åˆ†å¸ƒå›¾API...\n\n';
            
            try {
                const result = await testDistributionAPI();
                resultDiv.textContent += `âœ… ${result}\n`;
                resultDiv.textContent += '\nğŸ‰ åˆ†å¸ƒå›¾APIå·¥ä½œæ­£å¸¸ï¼\n';
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent += `âŒ ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('fixResult').style.display = 'none';
            document.getElementById('manualResult').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
        }
    </script>
</body>
</html>