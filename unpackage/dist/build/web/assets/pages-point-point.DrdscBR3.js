import{$ as a,K as i,g as t,c as e,a as l,J as o,p as s,v as n,r as d,e as c,w as p,i as u,o as r,f as g,j as m,C as L,D as h,F as b,k as v,t as f}from"./index-C_HCjYUn.js";import{_}from"./_plugin-vue_export-helper.BCo6x5W8.js";const T=_({data:()=>({pointList:[],isLoading:!1}),onLoad(){this.getPointList(),a("updatePointList",(a=>{console.log("收到网点更新事件:",a),this.updatePointInList(a)}))},onUnload(){i("updatePointList")},onShow(){console.log("列表页面显示 - 开始检查数据更新");const a=t("dataUpdateTime"),i=t("currentPointData"),s=Date.now();if(console.log("列表页面 - 全局数据更新时间:",a),console.log("列表页面 - 全局最新数据:",i),console.log("当前时间:",s),a&&i&&s-a<3e4){console.log("检测到全局最新数据，立即更新列表");const a=this.pointList.findIndex((a=>a.id==i.id||a.Id==i.id));console.log("找到的网点索引:",a),console.log("当前列表数据:",this.pointList),-1!==a?(this.pointList[a]={...this.pointList[a],name:i.name,address:i.address,pointType:i.pointType,availableLarge:i.availableLarge,availableMedium:i.availableMedium,availableSmall:i.availableSmall,openTime:i.openTime,status:i.status,cabinetInfo:`${i.availableLarge}组${i.availableMedium}主机${i.availableSmall}柜门`},console.log("✅ 列表数据已更新:",this.pointList[a]),this.$forceUpdate(),e("pointList",this.pointList),l({title:"列表数据已更新",icon:"success",duration:1500}),setTimeout((()=>{o("currentPointData"),o("dataUpdateTime"),console.log("列表页面已清除全局数据")}),1e4)):(console.log("未找到匹配的网点，重新获取列表数据"),this.getPointList())}else{const a=t("lastEditTime"),i=t("latestPointData");if(console.log("检查本地编辑数据"),console.log("编辑时间:",a,"当前时间:",s,"时间差:",s-a),console.log("本地最新数据:",i),a&&i&&s-a<3e4){console.log("检测到最新编辑数据，更新列表");const a=this.pointList.findIndex((a=>a.id==i.id||a.Id==i.id));-1!==a?(this.pointList[a]={...this.pointList[a],name:i.name,address:i.address,pointType:i.pointType,availableLarge:i.availableLarge,availableMedium:i.availableMedium,availableSmall:i.availableSmall,openTime:i.openTime,status:i.status,cabinetInfo:`${i.availableLarge}组${i.availableMedium}主机${i.availableSmall}柜门`},console.log("✅ 列表数据已更新:",this.pointList[a]),this.$forceUpdate(),e("pointList",this.pointList),l({title:"列表数据已更新",icon:"success",duration:1500}),setTimeout((()=>{o("latestPointData"),o("lastEditTime"),console.log("列表页面已清除本地数据")}),3e3)):(console.log("未找到匹配的网点，重新获取列表数据"),this.getPointList())}else console.log("没有最新数据，正常刷新网点列表"),this.getPointList()}},methods:{goBack(){s({delta:1})},addNewPoint(){console.log("点击新增网点按钮"),n({url:"/pages/point-edit/point-edit?id=new&name=新增网点"})},updatePointInList(a){console.log("更新列表中的网点数据:",a);const i=this.pointList.findIndex((i=>i.id==a.id||i.Id==a.id));-1!==i?(this.pointList[i]={...this.pointList[i],name:a.name,address:a.address,pointType:a.pointType,availableLarge:a.availableLarge,availableMedium:a.availableMedium,availableSmall:a.availableSmall,openTime:a.openTime,status:a.status,cabinetInfo:`${a.availableLarge}组${a.availableMedium}主机${a.availableSmall}柜门`},console.log("✅ 列表数据已实时更新:",this.pointList[i]),this.$forceUpdate(),e("pointList",this.pointList),l({title:"列表数据已更新",icon:"success",duration:1500})):(console.log("❌ 未找到要更新的网点，重新获取列表"),this.getPointList())},getPointList(){this.isLoading=!0,d({url:"http://localhost:8000/point_list",method:"GET",header:{Authorization:"Bearer "+t("adminToken")},success:a=>{var i;if(console.log("网点列表接口返回数据:",a),!a.data||200!==a.data.code&&"200"!==a.data.code)this.pointList=[],l({title:(null==(i=a.data)?void 0:i.msg)||"获取网点列表失败",icon:"none"});else{const i=a.data.list||a.data.List||[];i&&Array.isArray(i)?(this.pointList=i.map((a=>(console.log("原始网点数据:",a),{...a,id:a.Id||a.id,cabinetInfo:`${a.availableLarge||a.AvailableLarge||0}组${a.availableMedium||a.AvailableMedium||0}主机${a.availableSmall||a.AvailableSmall||0}柜门`}))),console.log("网点列表数据:",this.pointList),e("pointList",this.pointList),0===this.pointList.length&&l({title:"暂无网点数据",icon:"none"})):(this.pointList=[],l({title:"暂无网点数据",icon:"none"}))}},fail:a=>{console.error("网点列表请求失败:",a),this.pointList=[],l({title:"网络请求失败",icon:"none"})},complete:()=>{this.isLoading=!1}})},updatePointInList(a){console.log("更新列表中的网点数据:",a);const i=this.pointList.findIndex((i=>i.id===a.id||i.Id===a.id));-1!==i&&(this.pointList[i]={...this.pointList[i],name:a.name,address:a.address,pointType:a.pointType,availableLarge:a.availableLarge,availableMedium:a.availableMedium,availableSmall:a.availableSmall,openTime:a.openTime,status:a.status,cabinetInfo:`${a.availableLarge}组${a.availableMedium}主机${a.availableSmall}柜门`},console.log("列表数据已更新:",this.pointList[i]),e("pointList",this.pointList),l({title:"列表已更新",icon:"success",duration:1e3}))},goToPointDetail(a){console.log("点击网点:",a);const i=a.id,t=a.name||a.Name||"";console.log("跳转参数 - ID:",i,"名称:",t),console.log("完整网点数据:",a),console.log("保存到currentPoint的数据:",a),e("currentPoint",a),this.pointList&&this.pointList.length>0&&(e("pointList",this.pointList),console.log("网点列表数据已保存到本地存储")),n({url:`/pages/point-detail/point-detail?id=${i}&name=${encodeURIComponent(t)}`})}}},[["render",function(a,i,t,e,l,o){const s=v,n=u;return r(),c(n,{class:"point-page"},{default:p((()=>[g(n,{class:"header"},{default:p((()=>[g(n,{class:"header-left",onClick:o.goBack},{default:p((()=>[g(s,{class:"back-icon"},{default:p((()=>[m("←")])),_:1})])),_:1},8,["onClick"]),g(n,{class:"header-title"},{default:p((()=>[g(s,{class:"title-text"},{default:p((()=>[m("我的网点")])),_:1})])),_:1}),g(n,{class:"header-right",onClick:o.addNewPoint},{default:p((()=>[g(s,{class:"add-text"},{default:p((()=>[m("新增网点")])),_:1})])),_:1},8,["onClick"])])),_:1}),g(n,{class:"point-list"},{default:p((()=>[l.isLoading?(r(),c(n,{key:0,class:"loading-container"},{default:p((()=>[g(s,{class:"loading-text"},{default:p((()=>[m("加载中...")])),_:1})])),_:1})):l.pointList.length>0?(r(),c(n,{key:1},{default:p((()=>[(r(!0),L(b,null,h(l.pointList,(a=>(r(),c(n,{key:a.id||a.name,class:"point-card",onClick:i=>o.goToPointDetail(a)},{default:p((()=>[g(n,{class:"point-title-section"},{default:p((()=>[g(n,{class:"point-title"},{default:p((()=>[m(f(a.name),1)])),_:2},1024)])),_:2},1024),g(n,{class:"point-divider"}),g(n,{class:"point-info"},{default:p((()=>[g(n,{class:"point-label"},{default:p((()=>[m("柜组数量：")])),_:1}),g(n,{class:"point-value"},{default:p((()=>[m(f(a.cabinetInfo||a.availableLarge+"组"+a.availableMedium+"主机"+a.availableSmall+"柜门"),1)])),_:2},1024)])),_:2},1024),g(n,{class:"point-info"},{default:p((()=>[g(n,{class:"point-label"},{default:p((()=>[m("详细地址：")])),_:1}),g(n,{class:"point-value"},{default:p((()=>[m(f(a.address),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})):(r(),c(n,{key:2,class:"empty-container"},{default:p((()=>[g(s,{class:"empty-text"},{default:p((()=>[m("暂无网点数据")])),_:1}),g(s,{class:"empty-tip"},{default:p((()=>[m('点击右上角"新增网点"开始添加')])),_:1})])),_:1}))])),_:1})])),_:1})}],["__scopeId","data-v-31042e54"]]);export{T as default};
