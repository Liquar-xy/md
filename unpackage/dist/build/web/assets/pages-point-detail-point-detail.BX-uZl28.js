import{g as t,J as e,a as i,r as a,c as o,v as l,d as s,p as n,e as d,w as r,i as c,o as p,f as u,j as h,x as m,t as g,n as f,k as D,u as I}from"./index-C_HCjYUn.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";const _=v({data:()=>({pointId:null,pointName:"",pointDetail:{name:"",address:"",pointType:"",availableLarge:0,availableMedium:0,availableSmall:0,openTime:"",status:1,pointImage:""},isLoading:!0,error:"",isNavigating:!1}),onLoad(e){this.pointId=e.id||1,this.pointName=decodeURIComponent(e.name||""),this.fromEdit="true"===e.fromEdit,console.log("网点详情页面加载 - ID:",this.pointId,"名称:",this.pointName,"来自编辑:",this.fromEdit),console.log("完整options:",e);const i=t("adminToken");if(console.log("当前token:",i),this.fromEdit){if(console.log("从编辑页面跳转过来，直接从数据库获取最新数据"),"new"===this.pointId||"undefined"===this.pointId||!this.pointId){console.log("新增网点模式，使用本地最新数据");const e=t("latestPointData");return e?void this.updatePointDetailDirectly(e):void(this.error="新增网点模式，但未找到本地数据")}this.getPointDetail()}else{const e=t("lastEditTime"),i=t("latestPointData"),a=Date.now();e&&i&&a-e<3e4&&(i.id==this.pointId||i.Id==this.pointId)?(console.log("页面加载时使用本地最新数据:",i),this.updatePointDetailDirectly(i)):this.getPointDetail()}},onShow(){this.isNavigating=!1,console.log("页面显示，重置导航状态");const i=t("lastEditTime"),a=t("latestPointData"),o=Date.now();if(console.log("详情页面显示 - 检查编辑数据"),console.log("编辑时间:",i,"当前时间:",o,"时间差:",o-i),console.log("最新编辑数据:",a),console.log("当前网点ID:",this.pointId),i&&a&&o-i<3e4&&(a.id==this.pointId||a.Id==this.pointId))return console.log("使用最新编辑数据更新详情页面"),void this.updatePointDetailDirectly(a);if(this.fromEdit){if(console.log("从编辑页面跳转过来，直接从数据库获取最新数据"),"new"===this.pointId||"undefined"===this.pointId||!this.pointId){console.log("新增网点模式，使用本地最新数据");const e=t("latestPointData");return e?void this.updatePointDetailDirectly(e):void(this.error="新增网点模式，但未找到本地数据")}return void setTimeout((()=>{this.getPointDetail()}),500)}const l=t("dataUpdateTime"),s=t("currentPointData");console.log("全局数据更新时间:",l),console.log("全局最新数据:",s),l&&s&&o-l<3e4&&(s.id==this.pointId||s.Id==this.pointId)?(console.log("使用全局最新数据:",s),this.updatePointDetailDirectly(s),setTimeout((()=>{e("currentPointData"),e("dataUpdateTime"),console.log("已清除全局数据")}),5e3)):i&&a&&o-i<3e4&&(a.id==this.pointId||a.Id==this.pointId)?(console.log("使用本地最新数据:",a),this.updatePointDetailDirectly(a),setTimeout((()=>{e("latestPointData"),e("lastEditTime"),console.log("已清除本地数据")}),5e3)):this.pointId&&(console.log("页面显示时重新获取网点详情"),setTimeout((()=>{this.getPointDetail()}),100))},methods:{updatePointDetailDirectly(t){console.log("直接更新网点详情数据:",t),this.isLoading=!1,this.error="",this.pointDetail={name:t.name||"",address:t.address||"",pointType:t.pointType||"",availableLarge:parseInt(t.availableLarge)||0,availableMedium:parseInt(t.availableMedium)||0,availableSmall:parseInt(t.availableSmall)||0,openTime:t.openTime||"",status:parseInt(t.status)||1,pointImage:t.pointImage||""},console.log("直接更新后的网点详情:",this.pointDetail),this.$set(this,"pointDetail",{...this.pointDetail}),i({title:"数据已更新",icon:"success",duration:1500})},getPointDetail(){if(this.isLoading=!0,this.error="",console.log("正在获取网点详情，ID:",this.pointId),"new"===this.pointId||"undefined"===this.pointId||!this.pointId)return console.log("新增网点模式或无效ID，跳过获取网点详情"),this.isLoading=!1,void(this.error="无效的网点ID");this.pointDetail={name:"",address:"",pointType:"",availableLarge:0,availableMedium:0,availableSmall:0,openTime:"",status:1,pointImage:""};const e={id:parseInt(this.pointId)||this.pointId};console.log("发送的请求数据:",e),a({url:"http://localhost:8000/point_info",method:"POST",data:e,header:{"Content-Type":"application/json",Authorization:"Bearer "+t("adminToken")},success:t=>{var e;if(this.isLoading=!1,console.log("网点详情接口返回数据:",t),!t.data||200!==t.data.code&&"200"!==t.data.code)this.error=(null==(e=t.data)?void 0:e.msg)||"获取网点详情失败",console.error("接口返回错误:",t.data),i({title:this.error,icon:"none"});else{console.log("原始接口返回数据:",t.data);const e=t.data.data||t.data;console.log("后端返回的原始数据:",e),this.pointDetail={name:e.name||e.Name||"",address:e.address||e.Address||"",pointType:e.pointType||e.PointType||e.point_type||"",availableLarge:parseInt(e.availableLarge||e.AvailableLarge||e.available_large)||0,availableMedium:parseInt(e.availableMedium||e.AvailableMedium||e.available_medium)||0,availableSmall:parseInt(e.availableSmall||e.AvailableSmall||e.available_small)||0,openTime:e.openTime||e.OpenTime||e.open_time||"",status:parseInt(e.status||e.Status)||1,pointImage:e.pointImage||e.PointImage||e.point_image||""},console.log("处理后的网点详情:",this.pointDetail);const a={id:this.pointId,name:this.pointDetail.name,address:this.pointDetail.address,pointType:this.pointDetail.pointType,availableLarge:this.pointDetail.availableLarge,availableMedium:this.pointDetail.availableMedium,availableSmall:this.pointDetail.availableSmall,openTime:this.pointDetail.openTime,status:this.pointDetail.status,pointImage:this.pointDetail.pointImage};o("currentPointData",a),o("dataUpdateTime",Date.now()),o("latestPointData",a),o("lastEditTime",Date.now()),console.log("数据库数据与前端数据已同步:",a),this.fromEdit?(i({title:"已显示最新数据",icon:"success",duration:1500}),console.log("✅ 从编辑页面跳转，已显示数据库最新数据")):(i({title:"数据加载成功",icon:"success",duration:1e3}),console.log("✅ 正常加载，数据获取成功"))}},fail:t=>{this.isLoading=!1,console.error("网点详情请求失败:",t),this.error="网络请求失败",i({title:this.error,icon:"none"})}})},getCabinetInfo(){if(!this.pointDetail)return"0组0主机0柜门";const{availableLarge:t,availableMedium:e,availableSmall:i}=this.pointDetail;return`${parseInt(t)||0}组${parseInt(e)||0}主机${parseInt(i)||0}柜门`},editPoint(){console.log("点击编辑网点，ID:",this.pointId,"名称:",this.pointName),l({url:`/pages/point-edit/point-edit?id=${this.pointId}&name=${encodeURIComponent(this.pointName)}`,success:()=>{console.log("成功跳转到编辑页面")},fail:t=>{console.error("跳转到编辑页面失败:",t),i({title:"跳转失败",icon:"none"})}})},openBaiduMap(){if(!this.pointDetail.address)return void i({title:"网点地址为空",icon:"none"});console.log("打开地图页面，地址:",this.pointDetail.address);const t=encodeURIComponent(this.pointDetail.name||"网点位置"),e=encodeURIComponent(this.pointDetail.address);l({url:`/pages/map-view/map-view?name=${t}&address=${e}`,success:()=>{console.log("跳转到地图页面成功")},fail:t=>{console.error("跳转到地图页面失败:",t),i({title:"跳转失败",icon:"none"})}})},goToPriceRule(){this.isNavigating?console.log("正在跳转中，忽略重复点击"):(this.isNavigating=!0,console.log("点击收费规则，网点ID:",this.pointId,"名称:",this.pointName),l({url:`/pages/price-rule/price-rule?id=${this.pointId}&name=${encodeURIComponent(this.pointName)}`,success:()=>{console.log("跳转成功"),setTimeout((()=>{this.isNavigating=!1}),500)},fail:t=>{console.error("跳转失败:",t),this.isNavigating=!1,i({title:"跳转失败",icon:"none"})}}))},updatePointDetail(t){console.log("更新网点详情数据:",t),this.pointDetail={name:t.name||"",address:t.address||"",pointType:t.pointType||"",availableLarge:t.availableLarge||0,availableMedium:t.availableMedium||0,availableSmall:t.availableSmall||0,openTime:t.openTime||"",status:t.status||1,pointImage:t.pointImage||""},console.log("更新后的网点详情:",this.pointDetail),this.$set(this,"pointDetail",{...this.pointDetail}),i({title:"数据已更新",icon:"success",duration:1e3})},forceRefresh(){if(console.log("强制刷新数据"),"new"===this.pointId||"undefined"===this.pointId||!this.pointId)return console.log("新增网点模式，不需要刷新详情"),void(this.error="新增网点模式，无需刷新详情");console.log("强制刷新 - 从数据库获取最新数据"),this.getPointDetail()},goBack(){console.log("点击返回按钮，fromEdit:",this.fromEdit),s({url:"/pages/point/point",success:()=>{console.log("✅ 成功跳转到我的网点页面，将显示最新数据")},fail:t=>{console.error("跳转到我的网点页面失败:",t),n()}})}}},[["render",function(t,e,i,a,o,l){const s=D,n=c,v=I;return p(),d(n,{class:"point-detail"},{default:r((()=>[u(n,{class:"header"},{default:r((()=>[u(n,{class:"back-btn",onClick:l.goBack},{default:r((()=>[u(s,{class:"back-icon"},{default:r((()=>[h("←")])),_:1})])),_:1},8,["onClick"]),u(n,{class:"title"},{default:r((()=>[h("网点详情")])),_:1}),u(n,{class:"header-right"},{default:r((()=>[u(s,{class:"refresh-btn",onClick:l.forceRefresh},{default:r((()=>[h("刷新")])),_:1},8,["onClick"]),u(s,{class:"edit-btn",onClick:l.editPoint},{default:r((()=>[h("编辑")])),_:1},8,["onClick"])])),_:1})])),_:1}),o.pointDetail?(p(),d(n,{key:0,class:"photo-section"},{default:r((()=>[u(n,{class:"photo-placeholder"},{default:r((()=>[o.pointDetail.pointImage?(p(),d(v,{key:0,src:o.pointDetail.pointImage,mode:"aspectFill",class:"main-photo"},null,8,["src"])):(p(),d(n,{key:1,class:"photo-upload"},{default:r((()=>[u(s,{class:"photo-icon"},{default:r((()=>[h("📷")])),_:1}),u(s,{class:"photo-text"},{default:r((()=>[h("网点照片")])),_:1})])),_:1}))])),_:1})])),_:1})):m("",!0),o.pointDetail?(p(),d(n,{key:1,class:"info-section"},{default:r((()=>[u(n,{class:"info-item"},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("网点名称")])),_:1}),u(s,{class:"info-value"},{default:r((()=>[h(g(o.pointDetail.name),1)])),_:1}),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1}),u(n,{class:"info-item clickable",onClick:l.openBaiduMap},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("网点地址")])),_:1}),u(n,{class:"address-container"},{default:r((()=>[u(s,{class:"location-icon"},{default:r((()=>[h("📍")])),_:1}),u(s,{class:"info-value"},{default:r((()=>[h(g(o.pointDetail.address),1)])),_:1})])),_:1}),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1},8,["onClick"]),u(n,{class:"info-item"},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("网点类型")])),_:1}),u(s,{class:"info-value"},{default:r((()=>[h(g(o.pointDetail.pointType),1)])),_:1}),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1}),u(n,{class:"info-item"},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("管理柜组")])),_:1}),u(s,{class:"info-value"},{default:r((()=>[h(g(l.getCabinetInfo()),1)])),_:1}),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1}),u(n,{class:"info-item"},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("营业时间")])),_:1}),u(s,{class:"info-value"},{default:r((()=>[h(g(o.pointDetail.openTime),1)])),_:1}),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1}),u(n,{class:"info-item"},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("网点状态")])),_:1}),u(s,{class:f(["info-value",1==o.pointDetail.staus?"status-normal":"status-closed"])},{default:r((()=>[h(g(1==o.pointDetail.staus?"正常":"暂停营业"),1)])),_:1},8,["class"]),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1}),u(n,{class:"info-item clickable",onClick:l.goToPriceRule},{default:r((()=>[u(s,{class:"info-label"},{default:r((()=>[h("收费规则")])),_:1}),u(s,{class:"info-value"},{default:r((()=>[h("查看")])),_:1}),u(s,{class:"arrow"},{default:r((()=>[h(">")])),_:1})])),_:1},8,["onClick"])])),_:1})):m("",!0),o.isLoading?(p(),d(n,{key:2,class:"loading"},{default:r((()=>[u(s,null,{default:r((()=>[h("加载中...")])),_:1})])),_:1})):m("",!0),o.error?(p(),d(n,{key:3,class:"error"},{default:r((()=>[u(s,null,{default:r((()=>[h(g(o.error),1)])),_:1})])),_:1})):m("",!0)])),_:1})}],["__scopeId","data-v-a72ff2a6"]]);export{_ as default};
