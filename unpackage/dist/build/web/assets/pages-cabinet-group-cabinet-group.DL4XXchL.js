import{g as t,J as o,p as e,r as s,m as a,v as n,a as l,b as c,h as r,e as i,w as u,i as d,o as g,f,j as p,t as h,n as _,x as m,C,D as k,F as T,L as b,k as L,l as w,S as M}from"./index-C_HCjYUn.js";import{_ as y}from"./_plugin-vue_export-helper.BCo6x5W8.js";const v=y({data:()=>({currentLocation:"郑州新途径",currentLocationId:1,groupList:[],currentPage:1,pageSize:10,hasMore:!0,loading:!1,showMenuModal:!1,showConnectionStatus:!1,connectionStatusText:"",connectionStatusClass:"",apiBaseUrl:"http://localhost:8000"}),onLoad(){console.log("=== 柜组管理页面加载 ==="),this.initLocationInfo(),console.log("当前寄存点ID:",this.currentLocationId),console.log("API基础URL:",this.apiBaseUrl);const o=t("token")||t("adminToken");console.log("登录状态:",o?"已登录":"未登录"),this.loadGroupList()},onShow(){console.log("=== 柜组管理页面显示 ===");const e=t("selectedLocationId"),s=t("selectedLocationName");if(e&&e!==this.currentLocationId)console.log("寄存点已变更，重新加载数据"),this.currentLocationId=parseInt(e),this.currentLocation=s||"未知寄存点",this.refreshData();else{t("shouldRefreshGroupList")&&(console.log("从添加页面返回，刷新柜组列表"),o("shouldRefreshGroupList"),this.refreshData())}},methods:{goBack(){e()},showMenu(){this.showMenuModal=!0},hideMenu(){this.showMenuModal=!1},refreshData(){console.log("🔄 刷新柜组数据"),this.currentPage=1,this.hasMore=!0,this.groupList=[],this.loadGroupList()},async testBackendConnection(){console.log("🔍 测试后端连接");try{const t=await new Promise(((t,o)=>{s({url:`${this.apiBaseUrl}/v1/group/list`,method:"POST",header:{"Content-Type":"application/json"},data:{page:1,size:1,location_point_id:1},timeout:5e3,success:t,fail:o})}));return console.log("✅ 后端连接测试成功:",t),!0}catch(t){return console.error("❌ 后端连接测试失败:",t),!1}},initLocationInfo(){const o=t("selectedLocationId"),e=t("selectedLocationName");o&&e?(this.currentLocationId=parseInt(o),this.currentLocation=e,console.log("从本地存储加载寄存点:",this.currentLocation,this.currentLocationId)):(this.currentLocationId=null,this.currentLocation="请选择寄存点",console.log("未选择寄存点，需要用户选择"),setTimeout((()=>{a({title:"提示",content:"请先选择要管理的寄存点",showCancel:!1,success:()=>{this.selectLocation()}})}),500))},selectLocation(){console.log("跳转到寄存点选择页面"),n({url:"/pages/location-select/location-select?from=cabinet-group"})},async loadGroupList(){if(!this.loading&&this.hasMore)if(this.currentLocationId){this.loading=!0;try{const t=await this.requestGroupList();if(console.log("=== 处理响应数据 ==="),console.log("响应对象:",t),console.log("响应code:",t.code),console.log("响应groups:",t.groups),200!==t.code&&"200"!==t.code)throw new Error(t.msg||`服务器返回错误: ${t.code}`);{const o=t.groups||[];console.log("获取到的柜组数据:",o),console.log("柜组数量:",o.length),1===this.currentPage?this.groupList=o:this.groupList=[...this.groupList,...o],this.hasMore=o.length===this.pageSize,console.log(`✅ 加载柜组列表成功，当前页：${this.currentPage}，数据量：${o.length}`),1===this.currentPage&&(this.showConnectionStatus=!0,this.connectionStatusText=`✅ 后端连接正常，共加载${o.length}个柜组`,this.connectionStatusClass="success",setTimeout((()=>{this.showConnectionStatus=!1}),3e3),l({title:`加载成功，共${o.length}个柜组`,icon:"success",duration:1500}))}}catch(t){console.error("❌ 加载柜组列表失败:",t),this.showConnectionStatus=!0,this.connectionStatusText=`连接失败: ${t.message}`,this.connectionStatusClass="error",l({title:t.message||"加载失败",icon:"none",duration:2e3}),1===this.currentPage&&(console.log("⚠️ 使用模拟数据作为降级方案"),this.loadMockData(),this.connectionStatusText="后端连接失败，使用模拟数据",this.connectionStatusClass="warning")}finally{this.loading=!1}}else console.log("未选择寄存点，无法加载柜组数据")},requestGroupList(){return new Promise(((o,e)=>{console.log("=== 开始请求柜组列表 ===");const a=t("token")||t("adminToken")||"",n={page:String(this.currentPage),size:String(this.pageSize),location_point_id:this.currentLocationId,status:"normal"};console.log("请求参数:",n),console.log("请求URL:",`${this.apiBaseUrl}/v1/group/list`),console.log("使用Token:",a?"已设置":"未设置"),console.log("Content-Type: application/json"),1===this.currentPage&&c({title:"加载柜组数据...",mask:!0}),s({url:`${this.apiBaseUrl}/v1/group/list`,method:"POST",header:{"Content-Type":"application/json",Authorization:a?`Bearer ${a}`:""},data:n,timeout:15e3,success:t=>{var s;console.log("=== 柜组列表API响应 ==="),console.log("HTTP状态码:",t.statusCode),console.log("响应头:",t.header),console.log("响应数据类型:",typeof t.data),console.log("响应数据:",t.data),1===this.currentPage&&r(),200===t.statusCode?t.data&&"object"==typeof t.data?(console.log("✅ 响应数据格式正确"),o(t.data)):(console.error("❌ 响应数据格式错误:",t.data),e(new Error("响应数据格式错误"))):(console.error("❌ HTTP状态码错误:",t.statusCode),e(new Error(`HTTP ${t.statusCode}: ${(null==(s=t.data)?void 0:s.msg)||"请求失败"}`)))},fail:t=>{console.error("=== 柜组列表API请求失败 ==="),console.error("错误对象:",t),console.error("错误消息:",t.errMsg),1===this.currentPage&&r();let o="网络请求失败";t.errMsg&&(o=t.errMsg.includes("timeout")?"请求超时，请检查网络连接":t.errMsg.includes("fail")?"无法连接到服务器，请检查后端服务是否启动":t.errMsg),e(new Error(o))}})}))},loadMockData(){console.log("🎭 使用模拟数据作为降级方案");this.groupList=[{id:1,location_point_id:1,group_name:"A组",group_code:"1234567865435",group_type:"standard",status:"normal",total_cells:20,start_no:1,end_no:20,install_time:"2024-01-15T10:00:00Z",create_time:"2024-01-15T10:00:00Z",update_time:"2024-01-15T10:00:00Z"},{id:2,location_point_id:1,group_name:"B组",group_code:"1234567865436",group_type:"standard",status:"normal",total_cells:20,start_no:1,end_no:20,install_time:"2024-01-15T10:00:00Z",create_time:"2024-01-15T10:00:00Z",update_time:"2024-01-15T10:00:00Z"},{id:3,location_point_id:1,group_name:"C组",group_code:"1234567865437",group_type:"refrigerated",status:"normal",total_cells:15,start_no:1,end_no:15,install_time:"2024-01-20T10:00:00Z",create_time:"2024-01-20T10:00:00Z",update_time:"2024-01-20T10:00:00Z"}],this.hasMore=!1,l({title:"使用模拟数据",icon:"none",duration:2e3})},loadMore(){this.hasMore&&!this.loading&&(this.currentPage++,this.loadGroupList())},formatGroupNumber(t){const o=t.startNo||t.start_no||1;return`${String(o).padStart(2,"0")}号柜`},getStatusClass:t=>({normal:"status-normal",abnormal:"status-abnormal",disabled:"status-disabled",damaged:"status-damaged"}[t]||"status-normal"),getStatusText:t=>({normal:"正常",abnormal:"异常",disabled:"禁用",damaged:"损坏"}[t]||"未知"),getUsageText(t){const o=t.totalCells||t.total_cells||0,e=Math.floor(Math.random()*o);return`${e}单/${o-e}门`},getTodayOrders:t=>Math.floor(50*Math.random())+10,manageCabinet(t){console.log("管理柜门:",t);const o=t.groupName||t.group_name||"未知柜组";n({url:`/pages/cabinet-cell/cabinet-cell?groupId=${t.id}&groupName=${encodeURIComponent(o)}`})},viewOrders(t){console.log("查看柜门订单:",t);const o=t.groupName||t.group_name||"未知柜组";n({url:`/pages/group-orders/group-orders?groupId=${t.id}&groupName=${encodeURIComponent(o)}`})},editGroup(t){console.log("修改柜组:",t);const o=t.groupName||t.group_name||"未知柜组",e=t.id;n({url:`/pages/group-edit/group-edit?groupId=${e}&groupName=${encodeURIComponent(o)}&from=cabinet-group`})},async deleteGroup(t){console.log("删除柜组:",t);const o=t.groupName||t.group_name||"未知柜组",e=t.id;if(await new Promise((t=>{a({title:"确认删除",content:`确定要删除柜组"${o}"吗？删除后柜组将被禁用，无法正常使用。`,confirmText:"确认删除",confirmColor:"#ff4d4f",cancelText:"取消",success:o=>{t(o.confirm)}})})))try{c({title:"删除中...",mask:!0}),await this.requestDeleteGroup(e),r(),this.groupList=this.groupList.filter((t=>t.id!==e)),l({title:"删除成功",icon:"success",duration:2e3})}catch(s){r(),console.error("删除柜组失败:",s),a({title:"删除失败",content:s.message||"删除柜组时发生错误，请稍后重试",showCancel:!1})}},requestDeleteGroup(o){return new Promise(((e,a)=>{console.log("=== 开始删除柜组 ==="),console.log("柜组ID:",o);const n=t("token")||t("adminToken")||"",l={id:o};console.log("删除请求参数:",l),console.log("请求URL:",`${this.apiBaseUrl}/v1/group/delete`),s({url:`${this.apiBaseUrl}/v1/group/delete`,method:"POST",header:{"Content-Type":"application/json",Authorization:n?`Bearer ${n}`:""},data:l,timeout:1e4,success:t=>{var o,s,n;console.log("=== 删除柜组API响应 ==="),console.log("HTTP状态码:",t.statusCode),console.log("响应数据:",t.data),200===t.statusCode?!t.data||200!==t.data.code&&"200"!==t.data.code?(console.error("❌ 删除失败:",null==(o=t.data)?void 0:o.msg),a(new Error((null==(s=t.data)?void 0:s.msg)||"删除失败"))):(console.log("✅ 删除柜组成功"),e(t.data)):(console.error("❌ HTTP状态码错误:",t.statusCode),a(new Error(`HTTP ${t.statusCode}: ${(null==(n=t.data)?void 0:n.msg)||"请求失败"}`)))},fail:t=>{console.error("=== 删除柜组API请求失败 ==="),console.error("错误对象:",t),console.error("错误消息:",t.errMsg);let o="网络请求失败";t.errMsg&&(o=t.errMsg.includes("timeout")?"请求超时，请检查网络连接":t.errMsg.includes("fail")?"无法连接到服务器，请检查后端服务是否启动":t.errMsg),a(new Error(o))}})}))},addGroup(){this.navigateToAddGroup()},navigateToAddGroup(){this.hideMenu(),n({url:"/pages/group-add/group-add?from=cabinet-group"})},searchGroup(){this.hideMenu(),n({url:"/pages/group-search/group-search"})},exportData(){this.hideMenu(),l({title:"导出功能开发中",icon:"none"})},async testAPI(){console.log("🔍 手动测试API连接"),c({title:"测试连接...",mask:!0});try{if(await this.testBackendConnection()){const t=await this.requestGroupList();r(),a({title:"测试结果",content:`连接成功！\n返回数据: ${JSON.stringify(t,null,2)}`,showCancel:!1})}else r(),a({title:"测试结果",content:"无法连接到后端服务，请检查：\n1. 后端服务是否启动\n2. 端口8000是否正确\n3. 网络连接是否正常",showCancel:!1})}catch(t){r(),a({title:"测试失败",content:`错误信息: ${t.message}`,showCancel:!1})}}}},[["render",function(t,o,e,s,a,n){const l=L,c=d,r=w,y=M;return g(),i(c,{class:"page"},{default:u((()=>[f(c,{class:"navbar"},{default:u((()=>[f(c,{class:"nav-left",onClick:n.goBack},{default:u((()=>[f(c,{class:"back-button"},{default:u((()=>[f(l,{class:"back-icon"},{default:u((()=>[p("←")])),_:1}),f(l,{class:"back-text"},{default:u((()=>[p("返回")])),_:1})])),_:1})])),_:1},8,["onClick"]),f(c,{class:"nav-center"},{default:u((()=>[f(l,{class:"nav-title"},{default:u((()=>[p("柜组管理")])),_:1})])),_:1}),f(c,{class:"nav-right"},{default:u((()=>[f(c,{class:"nav-action",onClick:n.testAPI},{default:u((()=>[f(l,{class:"nav-icon"},{default:u((()=>[p("🔍")])),_:1})])),_:1},8,["onClick"]),f(c,{class:"nav-action",onClick:n.showMenu},{default:u((()=>[f(l,{class:"nav-icon"},{default:u((()=>[p("⋯")])),_:1})])),_:1},8,["onClick"]),f(c,{class:"nav-action",onClick:n.refreshData},{default:u((()=>[f(l,{class:"nav-icon"},{default:u((()=>[p("⟲")])),_:1})])),_:1},8,["onClick"])])),_:1})])),_:1}),f(c,{class:"location-selector",onClick:n.selectLocation},{default:u((()=>[f(c,{class:"location-content"},{default:u((()=>[f(c,{class:"location-icon"},{default:u((()=>[p("📍")])),_:1}),f(c,{class:"location-info"},{default:u((()=>[f(l,{class:"location-label"},{default:u((()=>[p("当前寄存点")])),_:1}),f(l,{class:"location-text"},{default:u((()=>[p(h(a.currentLocation),1)])),_:1})])),_:1})])),_:1}),f(c,{class:"dropdown-arrow"},{default:u((()=>[f(l,{class:"dropdown-icon"},{default:u((()=>[p("▼")])),_:1})])),_:1})])),_:1},8,["onClick"]),a.showConnectionStatus?(g(),i(c,{key:0,class:"connection-status"},{default:u((()=>[f(l,{class:_(["status-text",a.connectionStatusClass])},{default:u((()=>[p(h(a.connectionStatusText),1)])),_:1},8,["class"])])),_:1})):m("",!0),f(y,{class:"group-list","scroll-y":"true",onScrolltolower:n.loadMore},{default:u((()=>[(g(!0),C(T,null,k(a.groupList,((t,o)=>(g(),i(c,{class:"group-item",key:t.id},{default:u((()=>[f(c,{class:"group-card"},{default:u((()=>[f(c,{class:"group-header"},{default:u((()=>[f(c,{class:"group-title-section"},{default:u((()=>[f(l,{class:"group-name"},{default:u((()=>[p(h(t.groupName||t.group_name),1)])),_:2},1024),f(c,{class:"group-badge"},{default:u((()=>[f(l,{class:"group-number"},{default:u((()=>[p(h(n.formatGroupNumber(t)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),f(c,{class:_(["status-indicator",n.getStatusClass(t.status)])},{default:u((()=>[f(l,{class:"status-dot"},{default:u((()=>[p("●")])),_:1}),f(l,{class:"status-text"},{default:u((()=>[p(h(n.getStatusText(t.status)),1)])),_:2},1024)])),_:2},1032,["class"])])),_:2},1024),f(c,{class:"group-info-grid"},{default:u((()=>[f(c,{class:"info-card"},{default:u((()=>[f(l,{class:"info-icon"},{default:u((()=>[p("🏷️")])),_:1}),f(c,{class:"info-content"},{default:u((()=>[f(l,{class:"info-label"},{default:u((()=>[p("柜组编号")])),_:1}),f(l,{class:"info-value"},{default:u((()=>[p(h(t.groupCode||t.group_code),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),f(c,{class:"info-card"},{default:u((()=>[f(l,{class:"info-icon"},{default:u((()=>[p("📊")])),_:1}),f(c,{class:"info-content"},{default:u((()=>[f(l,{class:"info-label"},{default:u((()=>[p("使用状态")])),_:1}),f(l,{class:"info-value"},{default:u((()=>[p(h(n.getUsageText(t)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),f(c,{class:"info-card"},{default:u((()=>[f(l,{class:"info-icon"},{default:u((()=>[p("🔢")])),_:1}),f(c,{class:"info-content"},{default:u((()=>[f(l,{class:"info-label"},{default:u((()=>[p("编号区间")])),_:1}),f(l,{class:"info-value"},{default:u((()=>[p(h(t.startNo||t.start_no)+" - "+h(t.endNo||t.end_no),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),f(c,{class:"info-card"},{default:u((()=>[f(l,{class:"info-icon"},{default:u((()=>[p("📋")])),_:1}),f(c,{class:"info-content"},{default:u((()=>[f(l,{class:"info-label"},{default:u((()=>[p("今日订单")])),_:1}),f(l,{class:"info-value highlight"},{default:u((()=>[p(h(n.getTodayOrders(t))+"单",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024),f(c,{class:"group-actions"},{default:u((()=>[f(r,{class:"action-btn primary-btn",onClick:o=>n.manageCabinet(t)},{default:u((()=>[f(l,{class:"btn-icon"},{default:u((()=>[p("🔧")])),_:1}),f(l,{class:"btn-text"},{default:u((()=>[p("管理柜门")])),_:1})])),_:2},1032,["onClick"]),f(r,{class:"action-btn secondary-btn",onClick:o=>n.viewOrders(t)},{default:u((()=>[f(l,{class:"btn-icon"},{default:u((()=>[p("📊")])),_:1}),f(l,{class:"btn-text"},{default:u((()=>[p("柜门订单")])),_:1})])),_:2},1032,["onClick"]),f(r,{class:"action-btn edit-btn",onClick:o=>n.editGroup(t)},{default:u((()=>[f(l,{class:"btn-icon"},{default:u((()=>[p("✏️")])),_:1}),f(l,{class:"btn-text"},{default:u((()=>[p("修改柜组")])),_:1})])),_:2},1032,["onClick"]),f(r,{class:"action-btn danger-btn",onClick:o=>n.deleteGroup(t)},{default:u((()=>[f(l,{class:"btn-icon"},{default:u((()=>[p("🗑️")])),_:1}),f(l,{class:"btn-text"},{default:u((()=>[p("删除柜组")])),_:1})])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128)),a.hasMore?(g(),i(c,{key:0,class:"load-more"},{default:u((()=>[a.loading?(g(),i(l,{key:1,class:"load-text"},{default:u((()=>[p("加载中...")])),_:1})):(g(),i(l,{key:0,class:"load-text"},{default:u((()=>[p("上拉加载更多")])),_:1}))])),_:1})):m("",!0),!a.hasMore&&a.groupList.length>0?(g(),i(c,{key:1,class:"no-more"},{default:u((()=>[f(l,{class:"no-more-text"},{default:u((()=>[p("没有更多数据了")])),_:1})])),_:1})):m("",!0),a.loading||0!==a.groupList.length?m("",!0):(g(),i(c,{key:2,class:"empty-state"},{default:u((()=>[f(l,{class:"empty-icon"},{default:u((()=>[p("📦")])),_:1}),f(l,{class:"empty-text"},{default:u((()=>[p("暂无柜组数据")])),_:1}),f(r,{class:"refresh-btn",onClick:n.refreshData},{default:u((()=>[p("刷新数据")])),_:1},8,["onClick"])])),_:1}))])),_:1},8,["onScrolltolower"]),f(c,{class:"fab",onClick:n.addGroup},{default:u((()=>[f(c,{class:"fab-content"},{default:u((()=>[f(l,{class:"fab-icon"},{default:u((()=>[p("+")])),_:1})])),_:1})])),_:1},8,["onClick"]),a.showMenuModal?(g(),i(c,{key:1,class:"menu-overlay",onClick:n.hideMenu},{default:u((()=>[f(c,{class:"menu-popup",onClick:o[0]||(o[0]=b((()=>{}),["stop"]))},{default:u((()=>[f(c,{class:"menu-item",onClick:n.navigateToAddGroup},{default:u((()=>[f(l,{class:"menu-icon"},{default:u((()=>[p("➕")])),_:1}),f(l,{class:"menu-text"},{default:u((()=>[p("添加柜组")])),_:1})])),_:1},8,["onClick"]),f(c,{class:"menu-item",onClick:n.searchGroup},{default:u((()=>[f(l,{class:"menu-icon"},{default:u((()=>[p("🔍")])),_:1}),f(l,{class:"menu-text"},{default:u((()=>[p("搜索柜组")])),_:1})])),_:1},8,["onClick"]),f(c,{class:"menu-item",onClick:n.exportData},{default:u((()=>[f(l,{class:"menu-icon"},{default:u((()=>[p("📊")])),_:1}),f(l,{class:"menu-text"},{default:u((()=>[p("导出数据")])),_:1})])),_:1},8,["onClick"])])),_:1})])),_:1},8,["onClick"])):m("",!0)])),_:1})}],["__scopeId","data-v-12014a61"]]);export{v as default};
