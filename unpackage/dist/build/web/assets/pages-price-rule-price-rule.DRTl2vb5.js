import{g as e,a as t,b as s,r as l,h as a,c as i,p as o,e as n,w as d,i as r,o as g,f as c,j as u,t as h,n as p,x as m,k as y,I as D,l as f}from"./index-BgeTyoVd.js";import{_ as S}from"./_plugin-vue_export-helper.BCo6x5W8.js";const _=S({data:()=>({networkId:null,networkName:"",chargingMode:"timed",hasData:!1,timedSettings:{smallHourlyRate:"",smallDailyCap:"",largeHourlyRate:"",largeDailyCap:""},dailySettings:{smallDailyRate:"",largeDailyRate:""},freeDuration:"",depositSettings:{smallDeposit:"",largeDeposit:""}}),onLoad(e){this.networkId=e.id||1,this.networkName=decodeURIComponent(e.name||"未命名网点"),console.log("收费规则页面加载 - 网点ID:",this.networkId,"名称:",this.networkName),setTimeout((()=>{this.loadPriceData()}),100)},onShow(){console.log("页面显示 - 网点ID:",this.networkId),this.loadPriceData()},methods:{loadPriceData(){console.log("开始加载价格数据，网点ID:",this.networkId);const s=e(`price_rule_${this.networkId}`);console.log("本地存储数据:",s),s?(console.log("找到本地保存的数据:",s),this.loadPriceRules(s),t({title:"加载本地保存的配置",icon:"success",duration:1e3})):(console.log("没有本地数据，从服务器获取"),this.getPriceRule())},setChargingMode(e){this.chargingMode=e},onFreeDurationChange(e){const t=e.detail.value.replace(/[^0-9.]/g,""),s=t.split(".");s.length>2?this.freeDuration=s[0]+"."+s.slice(1).join(""):this.freeDuration=t,console.log("免费时长已更新:",this.freeDuration)},getPriceRule(){console.log("正在获取价格规则，网点ID:",this.networkId),s({title:"加载中..."}),l({url:`http://localhost:8000/admin/getPriceRule?networkId=${this.networkId}`,method:"GET",header:{"Content-Type":"application/json"},success:s=>{if(a(),console.log("获取价格规则返回:",s),s.data&&200===s.data.code&&s.data.rules&&s.data.rules.length>0)console.log("找到价格规则数据，开始加载"),this.loadPriceRules(s.data.rules),this.hasData=!0,t({title:"数据加载成功",icon:"success",duration:1e3});else{console.log("没有找到价格规则数据或数据为空"),console.log("响应数据详情:",s.data);const l=e(`price_rule_${this.networkId}`);l?(console.log("从本地存储恢复数据:",l),this.loadPriceRules(l),this.hasData=!0,t({title:"使用本地保存的配置",icon:"success",duration:1e3})):(this.resetFormData(),this.hasData=!1,t({title:"暂无价格规则数据",icon:"none",duration:1500}))}},fail:s=>{a(),console.error("获取价格规则失败:",s);const l=e(`price_rule_${this.networkId}`);l?(console.log("网络失败，从本地存储恢复数据:",l),this.loadPriceRules(l),this.hasData=!0,t({title:"使用本地保存的配置",icon:"success",duration:1e3})):t({title:"获取数据失败",icon:"none",duration:3e3})}})},loadPriceRules(e){if(console.log("开始加载价格规则:",e),this.hasData=!0,e.chargingMode)return console.log("加载本地存储的数据"),this.chargingMode=e.chargingMode,this.freeDuration=e.freeDuration||"",this.timedSettings=e.timedSettings||{smallHourlyRate:"",smallDailyCap:"",largeHourlyRate:"",largeDailyCap:""},this.dailySettings=e.dailySettings||{smallDailyRate:"",largeDailyRate:""},this.depositSettings=e.depositSettings||{smallDeposit:"",largeDeposit:""},console.log("=== 本地数据加载结果 ==="),console.log("计时设置:",this.timedSettings),console.log("按日设置:",this.dailySettings),console.log("押金设置:",this.depositSettings),console.log("免费时长:",this.freeDuration),console.log("收费模式:",this.chargingMode),console.log("数据状态:",this.hasData),void(this.hasData=!0);if(console.log("加载后端API的数据"),this.timedSettings={smallHourlyRate:"",smallDailyCap:"",largeHourlyRate:"",largeDailyCap:""},this.dailySettings={smallDailyRate:"",largeDailyRate:""},this.depositSettings={smallDeposit:"",largeDeposit:""},this.freeDuration="",e.length>0){const t=e[0];this.freeDuration=(t.freeDuration||0).toString(),this.chargingMode=1===t.feeType?"timed":"daily",console.log("设置免费时长:",this.freeDuration),console.log("设置收费模式:",this.chargingMode)}e.forEach((e=>{console.log("处理规则:",e),1===e.lockerType?(1===e.feeType?(this.timedSettings.smallHourlyRate=(e.hourlyRate||0).toString(),this.timedSettings.smallDailyCap=(e.dailyCap||0).toString(),console.log("小柜子计时收费设置:",this.timedSettings.smallHourlyRate,this.timedSettings.smallDailyCap)):(this.dailySettings.smallDailyRate=(e.dailyRate||0).toString(),console.log("小柜子按日收费设置:",this.dailySettings.smallDailyRate)),this.depositSettings.smallDeposit=(e.depositAmount||0).toString(),console.log("小柜子押金设置:",this.depositSettings.smallDeposit)):2===e.lockerType&&(1===e.feeType?(this.timedSettings.largeHourlyRate=(e.hourlyRate||0).toString(),this.timedSettings.largeDailyCap=(e.dailyCap||0).toString(),console.log("大柜子计时收费设置:",this.timedSettings.largeHourlyRate,this.timedSettings.largeDailyCap)):(this.dailySettings.largeDailyRate=(e.dailyRate||0).toString(),console.log("大柜子按日收费设置:",this.dailySettings.largeDailyRate)),this.depositSettings.largeDeposit=(e.depositAmount||0).toString(),console.log("大柜子押金设置:",this.depositSettings.largeDeposit))})),console.log("=== 最终加载结果 ==="),console.log("计时设置:",this.timedSettings),console.log("按日设置:",this.dailySettings),console.log("押金设置:",this.depositSettings),console.log("免费时长:",this.freeDuration),console.log("收费模式:",this.chargingMode),console.log("数据状态:",this.hasData)},savePriceRule(){if((parseFloat(this.freeDuration)||0)<0)return void t({title:"免费时长不能为负数",icon:"none"});let o=!1;if("timed"===this.chargingMode){const e=parseFloat(this.timedSettings.smallHourlyRate)||0,t=parseFloat(this.timedSettings.largeHourlyRate)||0;o=e>0||t>0}else{const e=parseFloat(this.dailySettings.smallDailyRate)||0,t=parseFloat(this.dailySettings.largeDailyRate)||0;o=e>0||t>0}if(!o)return void t({title:"请至少设置一个柜子的价格",icon:"none"});s({title:"正在保存..."});const n=[];"timed"===this.chargingMode?(n.push({ruleName:"小柜子计时收费",feeType:1,lockerType:1,freeDuration:parseFloat(this.freeDuration)||0,hourlyRate:parseFloat(this.timedSettings.smallHourlyRate)||0,dailyCap:parseFloat(this.timedSettings.smallDailyCap)||0,depositAmount:parseFloat(this.depositSettings.smallDeposit)||0,isDepositEnabled:parseFloat(this.depositSettings.smallDeposit)>0,isAdvancePay:!1}),n.push({ruleName:"大柜子计时收费",feeType:1,lockerType:2,freeDuration:parseFloat(this.freeDuration)||0,hourlyRate:parseFloat(this.timedSettings.largeHourlyRate)||0,dailyCap:parseFloat(this.timedSettings.largeDailyCap)||0,depositAmount:parseFloat(this.depositSettings.largeDeposit)||0,isDepositEnabled:parseFloat(this.depositSettings.largeDeposit)>0,isAdvancePay:!1})):(n.push({ruleName:"小柜子按日收费",feeType:2,lockerType:1,freeDuration:parseFloat(this.freeDuration)||0,dailyRate:parseFloat(this.dailySettings.smallDailyRate)||0,depositAmount:parseFloat(this.depositSettings.smallDeposit)||0,isDepositEnabled:parseFloat(this.depositSettings.smallDeposit)>0,isAdvancePay:!1}),n.push({ruleName:"大柜子按日收费",feeType:2,lockerType:2,freeDuration:parseFloat(this.freeDuration)||0,dailyRate:parseFloat(this.dailySettings.largeDailyRate)||0,depositAmount:parseFloat(this.depositSettings.largeDeposit)||0,isDepositEnabled:parseFloat(this.depositSettings.largeDeposit)>0,isAdvancePay:!1}));const d={networkId:parseInt(this.networkId),rules:n};console.log("=== 保存价格规则 ==="),console.log("网点ID:",this.networkId),console.log("收费模式:",this.chargingMode),console.log("免费时长:",this.freeDuration),console.log("计时设置:",this.timedSettings),console.log("按日设置:",this.dailySettings),console.log("押金设置:",this.depositSettings),console.log("请求数据:",d),l({url:"http://localhost:8000/admin/setPriceRule",method:"POST",data:d,header:{"Content-Type":"application/json",Authorization:"Bearer "+e("adminToken")},success:s=>{var l;if(a(),console.log("保存价格规则返回:",s),s.data&&200===s.data.code){this.hasData=!0,t({title:"保存成功",icon:"success",duration:2e3}),console.log("=== 保存成功，保存到本地 ==="),console.log("计时设置:",this.timedSettings),console.log("按日设置:",this.dailySettings),console.log("押金设置:",this.depositSettings),console.log("免费时长:",this.freeDuration),console.log("收费模式:",this.chargingMode);const s={networkId:this.networkId,chargingMode:this.chargingMode,freeDuration:this.freeDuration,timedSettings:this.timedSettings,dailySettings:this.dailySettings,depositSettings:this.depositSettings};i(`price_rule_${this.networkId}`,s),console.log("数据已保存到本地存储:",s);const l=e(`price_rule_${this.networkId}`);console.log("验证保存结果:",l),this.hasData=!0,t({title:"保存成功，数据已存储",icon:"success",duration:2e3})}else t({title:(null==(l=s.data)?void 0:l.msg)||"保存失败",icon:"none",duration:3e3})},fail:e=>{a(),console.error("保存价格规则失败:",e),t({title:"网络错误",icon:"none",duration:3e3})}})},resetFormData(){this.hasData=!1,this.timedSettings={smallHourlyRate:"",smallDailyCap:"",largeHourlyRate:"",largeDailyCap:""},this.dailySettings={smallDailyRate:"",largeDailyRate:""},this.depositSettings={smallDeposit:"",largeDeposit:""},this.freeDuration="",this.chargingMode="timed",console.log("表单数据已重置")},refreshData(){console.log("手动刷新数据"),this.hasData=!1,this.getPriceRule()},goBack(){o()}}},[["render",function(e,t,s,l,a,i){const o=y,S=r,_=D,R=f;return g(),n(S,{class:"price-rule"},{default:d((()=>[c(S,{class:"header"},{default:d((()=>[c(S,{class:"header-left",onClick:i.goBack},{default:d((()=>[c(o,{class:"back-icon"},{default:d((()=>[u("←")])),_:1})])),_:1},8,["onClick"]),c(o,{class:"header-title"},{default:d((()=>[u("收费规则")])),_:1}),c(S,{class:"header-right"},{default:d((()=>[c(o,{class:"menu-icon"},{default:d((()=>[u("⋯")])),_:1}),c(o,{class:"target-icon"},{default:d((()=>[u("○")])),_:1})])),_:1})])),_:1}),c(S,{class:"network-info"},{default:d((()=>[c(o,{class:"network-title"},{default:d((()=>[u("网点: "+h(a.networkName),1)])),_:1}),a.hasData?(g(),n(S,{key:0,class:"data-status"},{default:d((()=>[c(o,{class:"status-text"},{default:d((()=>[u("✅ 已加载保存的配置")])),_:1})])),_:1})):(g(),n(S,{key:1,class:"data-status"},{default:d((()=>[c(o,{class:"status-text"},{default:d((()=>[u("📝 使用默认配置")])),_:1})])),_:1}))])),_:1}),c(S,{class:"charging-mode"},{default:d((()=>[c(o,{class:"section-title"},{default:d((()=>[u("收费模式")])),_:1}),c(S,{class:"mode-buttons"},{default:d((()=>[c(S,{class:p(["mode-btn",{active:"timed"===a.chargingMode}]),onClick:t[0]||(t[0]=e=>i.setChargingMode("timed"))},{default:d((()=>[u(" 计时收费 ")])),_:1},8,["class"]),c(S,{class:p(["mode-btn",{active:"daily"===a.chargingMode}]),onClick:t[1]||(t[1]=e=>i.setChargingMode("daily"))},{default:d((()=>[u(" 按日收费 ")])),_:1},8,["class"])])),_:1})])),_:1}),c(S,{class:"price-settings"},{default:d((()=>[c(o,{class:"section-title"},{default:d((()=>[u("价格设置")])),_:1}),"timed"===a.chargingMode?(g(),n(S,{key:0,class:"timed-settings"},{default:d((()=>[c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("小柜子:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.timedSettings.smallHourlyRate,"onUpdate:modelValue":t[2]||(t[2]=e=>a.timedSettings.smallHourlyRate=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元/小时")])),_:1})])),_:1}),c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("小柜子24小时内封顶费用:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.timedSettings.smallDailyCap,"onUpdate:modelValue":t[3]||(t[3]=e=>a.timedSettings.smallDailyCap=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元")])),_:1})])),_:1}),c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("大柜子:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.timedSettings.largeHourlyRate,"onUpdate:modelValue":t[4]||(t[4]=e=>a.timedSettings.largeHourlyRate=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元/小时")])),_:1})])),_:1}),c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("大柜子24小时内封顶费用:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.timedSettings.largeDailyCap,"onUpdate:modelValue":t[5]||(t[5]=e=>a.timedSettings.largeDailyCap=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元")])),_:1})])),_:1})])),_:1})):m("",!0),"daily"===a.chargingMode?(g(),n(S,{key:1,class:"daily-settings"},{default:d((()=>[c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("小柜子:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.dailySettings.smallDailyRate,"onUpdate:modelValue":t[6]||(t[6]=e=>a.dailySettings.smallDailyRate=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元/日")])),_:1})])),_:1}),c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("大柜子:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.dailySettings.largeDailyRate,"onUpdate:modelValue":t[7]||(t[7]=e=>a.dailySettings.largeDailyRate=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元/日")])),_:1})])),_:1})])),_:1})):m("",!0)])),_:1}),c(S,{class:"free-duration"},{default:d((()=>[c(o,{class:"section-title"},{default:d((()=>[u("免费时长")])),_:1}),c(S,{class:"free-duration-row"},{default:d((()=>[c(o,{class:"free-duration-label"},{default:d((()=>[u("寄存后前")])),_:1}),c(_,{class:"free-duration-input",type:"text",modelValue:a.freeDuration,"onUpdate:modelValue":t[8]||(t[8]=e=>a.freeDuration=e),placeholder:"0",onInput:i.onFreeDurationChange},null,8,["modelValue","onInput"]),"timed"===a.chargingMode?(g(),n(o,{key:0,class:"free-duration-unit"},{default:d((()=>[u("分钟内取出结束订单不收取费用。")])),_:1})):(g(),n(o,{key:1,class:"free-duration-unit"},{default:d((()=>[u("小时内取出结束订单不收取费用。")])),_:1}))])),_:1})])),_:1}),c(S,{class:"deposit"},{default:d((()=>[c(o,{class:"section-title"},{default:d((()=>[u("押金")])),_:1}),c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("小柜子:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.depositSettings.smallDeposit,"onUpdate:modelValue":t[9]||(t[9]=e=>a.depositSettings.smallDeposit=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元")])),_:1})])),_:1}),c(S,{class:"setting-item"},{default:d((()=>[c(o,{class:"setting-label"},{default:d((()=>[u("大柜子:")])),_:1}),c(_,{class:"setting-input",type:"text",modelValue:a.depositSettings.largeDeposit,"onUpdate:modelValue":t[10]||(t[10]=e=>a.depositSettings.largeDeposit=e),placeholder:"0"},null,8,["modelValue"]),c(o,{class:"setting-unit"},{default:d((()=>[u("元")])),_:1})])),_:1})])),_:1}),c(S,{class:"bottom-buttons"},{default:d((()=>[c(R,{class:"cancel-btn",onClick:i.goBack},{default:d((()=>[u("取消")])),_:1},8,["onClick"]),c(R,{class:"refresh-btn",onClick:i.refreshData},{default:d((()=>[u("刷新")])),_:1},8,["onClick"]),c(R,{class:"save-btn",onClick:i.savePriceRule},{default:d((()=>[u("保存")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-3f010499"]]);export{_ as default};
