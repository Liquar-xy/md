import{a as e,p as t,r as s,A as a,s as r,d as o,v as d,e as l,w as n,i,o as u,f as c,j as f,t as h,x as _,k as p,l as g}from"./index-C_HCjYUn.js";import{_ as m}from"./_plugin-vue_export-helper.BCo6x5W8.js";const k=m({data:()=>({orderId:null,order:null,loading:!0,statusCheckTimer:null}),onLoad(s){const a=s.id?parseInt(s.id,10):null;a&&!isNaN(a)?(this.orderId=a,this.fetchOrderDetails()):(e({title:"无效的订单ID",icon:"none",duration:2e3}),setTimeout((()=>{t()}),2e3))},onShow(){this.startStatusSync()},onHide(){this.stopStatusSync()},onUnload(){this.stopStatusSync()},methods:{fetchOrderDetails(){if(!this.orderId)return e({title:"订单ID无效",icon:"none"}),void(this.loading=!1);s({url:"http://127.0.0.1:8000/v1/orders/show",method:"POST",header:{"Content-Type":"application/json"},data:JSON.stringify({id:this.orderId}),success:t=>{if(console.log("订单详情请求成功:",t),200!==t.statusCode)return void e({title:`请求失败：状态码 ${t.statusCode}`,icon:"none"});if(!t.data||!t.data.order||0===t.data.order.length)return e({title:"未找到订单详情",icon:"none"}),void console.warn("订单数据为空:",t.data);const s=t.data.order[0];this.order={id:s.id,order_number:s.orderNumber,user_id:s.userId,scheduled_duration:s.scheduledDuration,actual_duration:s.actualDuration,price:s.price,discount:s.discount,amount_paid:s.amountPaid,storage_location_name:s.storageLocationName,cabinet_id:s.cabinetId,status:parseInt(s.status)||0,deposit_status:parseInt(s.depositStatus)||0},console.log("订单状态调试信息:",{"原始状态":s.status,"转换后状态":this.order.status,"状态文本":this.getOrderStatusText(this.order.status)}),this.order?this.startStatusSync():e({title:"未找到订单详情",icon:"none"})},fail:t=>{console.error("获取订单详情失败 - 详细错误:",t),e({title:`获取订单详情失败：${t.errMsg||"未知错误"}`,icon:"none"})},complete:()=>{this.loading=!1}})},getOrderStatusText(e){const t=parseInt(e);switch(console.log("状态映射调试:",{"输入状态":e,"转换后":t}),t){case 1:return"待支付";case 2:return"寄存中";case 3:return"已完成";case 4:return"已取消";case 5:return"超时";case 6:return"异常";default:return console.warn("未知的订单状态:",e,"类型:",typeof e),`未知状态(${e})`}},getDepositStatusText(e){switch(parseInt(e)){case 1:return"已支付";case 2:return"已退还";case 3:return"已扣除";default:return console.warn("未知的押金状态:",e,"类型:",typeof e),`未知状态(${e})`}},goBack(){try{a().length>1?t({delta:1,fail:e=>{console.error("返回失败:",e),r({url:"/pages/orders/orders",fail:()=>{o({url:"/pages/orders/orders"})}})}}):r({url:"/pages/orders/orders",fail:()=>{o({url:"/pages/orders/orders"})}})}catch(e){console.error("返回出错:",e),o({url:"/pages/orders/orders"})}},handlePickup(){e({title:"取出物品功能开发中",icon:"none"})},handleEvaluate(){e({title:"评价功能开发中",icon:"none"})},handleCustomAction(){this.order?d({url:`/pages/alipay/alipay?id=${this.order.id}`,fail:t=>{console.error("跳转支付页面失败:",t),e({title:"页面跳转失败",icon:"none"})}}):e({title:"订单数据不完整",icon:"none"})},goToRemindTask(){this.order?d({url:`/pages/timetasksend/timetasksend?orderId=${this.order.id}&orderNumber=${this.order.order_number}`,fail:t=>{console.error("跳转提醒任务页面失败:",t),e({title:"页面跳转失败",icon:"none"})}}):e({title:"订单数据不完整",icon:"none"})},startStatusSync(){this.stopStatusSync(),this.order&&this.order.status&&this.order.status<3&&(console.log("开始订单状态同步，当前状态:",this.order.status),this.statusCheckTimer=setInterval((()=>{this.syncOrderStatus()}),3e4))},stopStatusSync(){this.statusCheckTimer&&(clearInterval(this.statusCheckTimer),this.statusCheckTimer=null,console.log("停止订单状态同步"))},syncOrderStatus(){this.orderId&&(console.log("同步订单状态，订单ID:",this.orderId),s({url:"http://127.0.0.1:8000/v1/orders/show",method:"POST",header:{"Content-Type":"application/json"},data:JSON.stringify({id:this.orderId}),success:t=>{if(200===t.statusCode&&t.data&&t.data.order&&t.data.order.length>0){const s=t.data.order[0],a=parseInt(s.status)||0,r=parseInt(s.depositStatus)||0;this.order.status===a&&this.order.deposit_status===r||(console.log("订单状态发生变化:",{"旧状态":this.order.status,"新状态":a,"旧押金状态":this.order.deposit_status,"新押金状态":r}),this.order.status=a,this.order.deposit_status=r,a>=3&&this.stopStatusSync(),e({title:`订单状态已更新: ${this.getOrderStatusText(a)}`,icon:"none",duration:2e3}))}},fail:e=>{console.error("同步订单状态失败:",e)}}))},goToExpireRemind(){this.order?d({url:`/pages/timetasksend/timetasksend?orderId=${this.order.id}&orderNumber=${this.order.order_number}&type=expire`,fail:t=>{console.error("跳转提醒到期页面失败:",t),e({title:"页面跳转失败",icon:"none"})}}):e({title:"订单数据不完整",icon:"none"})},goToRefund(){this.order?d({url:`/pages/orderdel/orderdel?id=${this.order.id}&orderNumber=${this.order.order_number}&status=${this.order.status}`,fail:t=>{console.error("跳转退款页面失败:",t),e({title:"页面跳转失败",icon:"none"})}}):e({title:"订单数据不完整",icon:"none"})}}},[["render",function(e,t,s,a,r,o){const d=p,m=i,k=g;return u(),l(m,{class:"order-detail-container"},{default:n((()=>[c(m,{class:"header-bar"},{default:n((()=>[c(m,{class:"back-btn",onClick:o.goBack,"hover-class":"back-btn-hover"},{default:n((()=>[c(d,{class:"back-icon"},{default:n((()=>[f("←")])),_:1})])),_:1},8,["onClick"]),c(d,{class:"header-title"},{default:n((()=>[f("订单详情")])),_:1}),c(m,{class:"header-placeholder"})])),_:1}),r.loading?(u(),l(m,{key:0,class:"loading-container"},{default:n((()=>[c(d,{class:"loading-text"},{default:n((()=>[f("加载中...")])),_:1})])),_:1})):r.order?(u(),l(m,{key:1,class:"order-detail-content"},{default:n((()=>[c(m,{class:"order-status-banner"},{default:n((()=>[c(d,{class:"status-text"},{default:n((()=>[f(h(o.getOrderStatusText(r.order.status)),1)])),_:1})])),_:1}),c(m,{class:"order-info-card"},{default:n((()=>[c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("订单号")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f(h(r.order.order_number),1)])),_:1})])),_:1}),c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("寄存网点")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f(h(r.order.storage_location_name),1)])),_:1})])),_:1}),c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("柜子ID")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f(h(r.order.cabinet_id),1)])),_:1})])),_:1})])),_:1}),c(m,{class:"order-time-fee-card"},{default:n((()=>[c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("计划寄存时长")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f(h(r.order.scheduled_duration)+"小时",1)])),_:1})])),_:1}),c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("实际寄存时长")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f(h(r.order.actual_duration)+"小时",1)])),_:1})])),_:1}),c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("基础费用")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f("¥"+h(r.order.price.toFixed(2)),1)])),_:1})])),_:1}),c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("优惠金额")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f("¥"+h(r.order.discount.toFixed(2)),1)])),_:1})])),_:1}),c(m,{class:"info-row total"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("实付金额")])),_:1}),c(d,{class:"info-value highlight"},{default:n((()=>[f("¥"+h(r.order.amount_paid.toFixed(2)),1)])),_:1})])),_:1})])),_:1}),c(m,{class:"order-deposit-card"},{default:n((()=>[c(m,{class:"info-row"},{default:n((()=>[c(d,{class:"info-label"},{default:n((()=>[f("押金状态")])),_:1}),c(d,{class:"info-value"},{default:n((()=>[f(h(o.getDepositStatusText(r.order.deposit_status)),1)])),_:1})])),_:1})])),_:1}),c(m,{class:"order-actions"},{default:n((()=>[2===r.order.status?(u(),l(k,{key:0,class:"action-btn primary",onClick:o.handlePickup},{default:n((()=>[f(" 取出物品 ")])),_:1},8,["onClick"])):_("",!0),3===r.order.status?(u(),l(k,{key:1,class:"action-btn default",onClick:o.handleEvaluate},{default:n((()=>[f(" 去评价 ")])),_:1},8,["onClick"])):_("",!0),3!==r.order.status?(u(),l(k,{key:2,class:"action-btn secondary",onClick:o.handleCustomAction},{default:n((()=>[f(" 去支付 ")])),_:1},8,["onClick"])):_("",!0),2===r.order.status?(u(),l(k,{key:3,class:"action-btn remind",onClick:o.goToRemindTask},{default:n((()=>[f(" 发送提醒 ")])),_:1},8,["onClick"])):_("",!0),1===r.order.status||2===r.order.status?(u(),l(k,{key:4,class:"action-btn expire-remind",onClick:o.goToExpireRemind},{default:n((()=>[f(" 提醒到期 ")])),_:1},8,["onClick"])):_("",!0),1===r.order.status||2===r.order.status?(u(),l(k,{key:5,class:"action-btn refund",onClick:o.goToRefund},{default:n((()=>[f(" 申请退款 ")])),_:1},8,["onClick"])):_("",!0)])),_:1})])),_:1})):(u(),l(m,{key:2,class:"error-container"},{default:n((()=>[c(d,{class:"error-text"},{default:n((()=>[f("未找到订单详情")])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-fd78d042"]]);export{k as default};
