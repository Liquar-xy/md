import{g as t,J as e,r as a,m as s,p as r,b as l,V as o,h as n,a as i,c as d,T as c,v as u,d as m,W as h,s as f,e as p,w as _,i as y,o as g,f as D,j as P,t as w,n as b,x as k,k as T,l as v}from"./index-C_HCjYUn.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const C=x({data:()=>({loading:!1,paying:!1,selectedPayment:"",errorMsg:"",orderData:{id:null,actual_duration:0,status:1,deposit_status:1,hourly_rate:0,locker_type:1,type_id:1,price:0,title:""}}),computed:{totalAmount(){if(this.orderData.amount_paid>0)return this.orderData.amount_paid;const t=this.orderData.price||0,e=this.orderData.discount||0;return Math.max(0,t-e)}},onLoad(t){t.id&&(this.orderData.id=parseInt(t.id),this.fetchOrderDetail()),this.checkPendingPayment()},onShow(){this.checkPendingPayment()},methods:{formatAmount:t=>(t||0).toFixed(2),checkPendingPayment(){try{const a=t("current_payment_info");if(a){const{startTime:t,orderNumber:s}=a;if(Date.now()-t>18e5)return void e("current_payment_info");s==this.orderData.id&&(console.log("发现待处理的支付，检查结果"),this.checkPaymentResult(a))}}catch(a){console.error("检查待处理支付失败:",a)}},fetchOrderDetail(){this.loading=!0,a({url:"http://127.0.0.1:8000/v1/orders/show",method:"POST",data:{id:this.orderData.id},success:t=>{if(console.log("后端返回数据:",t.data),t.data&&"object"==typeof t.data&&Array.isArray(t.data.order)&&t.data.order.length>0){const e=t.data.order[0];Number(e.price||e.amountPaid||e.totalPrice),this.orderData={...this.orderData,id:e.id,order_number:e.orderNumber,storage_location_name:e.storageLocationName,cabinet_id:e.cabinetId,actual_duration:Number(e.actualDuration||e.actual_duration)||0,scheduled_duration:Number(e.scheduledDuration||e.scheduled_duration)||0,status:parseInt(e.status)||0,deposit_status:parseInt(e.depositStatus)||0,price:Number(e.price)||0,discount:Number(e.discount)||0,amount_paid:Number(e.amountPaid)||0,locker_type:e.cabinetId,type_id:e.type_id||e.typeId||e.locker_type_id,title:`订单${e.id}支付`},console.log("订单数据映射完成:",this.orderData)}else this.showError("订单数据异常")},fail:t=>{var e,a;let s="网络异常";(null==(e=t.errMsg)?void 0:e.includes("timeout"))?s="连接服务器超时，点击重试":(null==(a=t.errMsg)?void 0:a.includes("fail"))&&(s="网络连接失败，请重试"),this.showError(s)},complete:()=>{this.loading=!1}})},showError(t){this.loading=!1,s({title:"提示",content:t,showCancel:!0,cancelText:"返回",confirmText:"重试",success:t=>{t.confirm?this.fetchOrderDetail():r()}})},async handlePay(){if(!this.paying&&this.selectedPayment&&this.validateOrder()){this.paying=!0,l({title:"处理支付请求...",mask:!0});try{const t={id:this.orderData.id,actual_duration:this.orderData.actual_duration,status:3,deposit_status:this.orderData.deposit_status,locker_type:this.orderData.locker_type,type_id:this.orderData.type_id,payment_method:this.selectedPayment,title:this.orderData.title,return_url:"app://payment/return",cancel_url:"app://payment/cancel",client_type:"uniapp",platform:o().platform};console.log("发送支付请求:",t);const e=await a({url:"http://127.0.0.1:8000/v1/order/update",method:"PUT",header:{"Content-Type":"application/json"},data:t,timeout:1e4});if(console.log("后端响应:",e),200!==e.statusCode)throw new Error(`服务器错误: ${e.statusCode}`);if(!e.data)throw new Error("服务器返回数据为空");if(e.data.error)throw new Error(e.data.error);const s=e.data;console.log("后端返回的支付信息:",s);const r=s.payUrl||s.PayUrl||s.result||s.url;if(!r)throw console.error("支付链接为空，完整响应:",s),new Error("支付链接获取失败，请联系客服");const l=s.payment_method||this.selectedPayment,i=s.order_number||s.order_id||this.orderData.id,d=s.amount||this.orderData.price;if(!this.isValidUrl(r))throw console.error("支付链接格式无效:",r),new Error("支付链接格式无效");n(),this.handlePaymentRedirect({payUrl:r,paymentMethod:l,orderNumber:i,amount:d,title:this.orderData.title})}catch(t){console.error("支付处理错误:",t),n();let e="网络异常，请重试";t.message?e=t.message:t.errMsg&&(e=t.errMsg.includes("timeout")?"请求超时，请检查网络连接":t.errMsg.includes("fail")?"网络连接失败，请重试":t.errMsg),s({title:"支付失败",content:e,confirmText:"重试",cancelText:"返回",success:t=>{t.confirm&&setTimeout((()=>{this.handlePay()}),1e3)}})}finally{this.paying=!1}}},validateOrder(){return this.orderData.id?!this.orderData.actual_duration||this.orderData.actual_duration<=0?(i({title:"寄存时长异常",icon:"none"}),!1):this.totalAmount<=0?(i({title:"订单金额异常",icon:"none"}),!1):!!this.orderData.title||(i({title:"订单标题缺失",icon:"none"}),!1):(i({title:"订单ID缺失",icon:"none"}),!1)},isValidUrl(t){if(!t||"string"!=typeof t)return!1;try{return/^https?:\/\/.+/.test(t)}catch(e){return!1}},handlePaymentRedirect(t){const{payUrl:e,paymentMethod:a,orderNumber:r,amount:l,title:o}=t;console.log("处理支付跳转:",t),s({title:"确认支付",content:`订单号：${r}\n支付金额：¥${l}\n支付方式：${"alipay"===a?"支付宝":a}\n\n即将跳转到安全支付环境`,confirmText:"确认支付",cancelText:"取消",success:a=>{a.confirm&&this.openPaymentUrl(e,t)}})},openPaymentUrl(t,e){console.log("打开支付链接:",t);try{d("current_payment_info",{...e,startTime:Date.now()})}catch(a){console.error("保存支付信息失败:",a)}try{if("undefined"!=typeof window&&window.open){const a=window.open(t,"_blank");a?this.monitorPaymentWindow(a,e):this.showPaymentUrlFallback(t)}else"undefined"!=typeof plus&&plus.runtime?(plus.runtime.openURL(t,(e=>{console.error("打开支付链接失败:",e),this.showPaymentUrlFallback(t)})),this.startPaymentResultCheck(e)):this.showPaymentUrlFallback(t)}catch(a){console.error("打开支付链接异常:",a),this.showPaymentUrlFallback(t)}},showPaymentUrlFallback(t){c({data:t,success:()=>{s({title:"支付链接已复制",content:"支付链接已复制到剪贴板，请在浏览器中粘贴打开完成支付",confirmText:"我知道了",showCancel:!1,success:()=>{console.log("用户确认已知晓支付链接复制")}})},fail:()=>{s({title:"支付链接",content:`请复制以下链接在浏览器中打开：\n\n${t}`,confirmText:"我知道了",showCancel:!1})}})},monitorPaymentWindow(t,e){if(!t)return void console.error("支付窗口对象无效");const a=setInterval((()=>{try{t.closed&&(clearInterval(a),console.log("支付窗口已关闭，检查支付结果"),this.checkPaymentResult(e))}catch(s){console.error("监听支付窗口失败:",s),clearInterval(a)}}),1e3);setTimeout((()=>{clearInterval(a);try{t&&!t.closed&&console.log("支付监听超时")}catch(e){console.error("检查窗口状态失败:",e)}}),6e5)},startPaymentResultCheck(t){setTimeout((()=>{this.checkPaymentResult(t)}),3e3)},async checkPaymentResult(t){if(t&&t.orderNumber)try{console.log("检查支付结果:",t);const e=await a({url:"http://127.0.0.1:8000/v1/payment/status",method:"POST",header:{"Content-Type":"application/json"},data:{order_id:t.orderNumber,order_number:t.orderNumber},timeout:5e3});if(200===e.statusCode&&e.data){const a=e.data.status;"success"===a||2===a?this.handlePaymentSuccess(t):"failed"===a||3===a?this.handlePaymentFailed(t,e.data.message):this.handlePaymentUnknown(t)}else this.handlePaymentUnknown(t)}catch(e){console.error("检查支付结果失败:",e),console.log("由于网络错误，跳过支付状态检查")}else console.error("支付信息无效:",t)},handlePaymentSuccess(t){e("current_payment_info"),this.orderData.status=2,i({title:"支付成功",icon:"success",duration:2e3}),setTimeout((()=>{u({url:`/pages/show/show?id=${this.orderData.id}`,fail:()=>{r({delta:1,fail:()=>{m({url:"/pages/index/index"})}})}})}),2e3)},handlePaymentFailed(t,a){e("current_payment_info"),s({title:"支付失败",content:a||"支付未成功，请重试",confirmText:"重新支付",cancelText:"返回",success:t=>{t.confirm&&this.handlePay()}})},handlePaymentUnknown(t){s({title:"支付状态确认",content:"无法确认支付状态，请检查订单详情或联系客服",confirmText:"查看订单",cancelText:"返回",success:t=>{t.confirm&&this.goToOrderDetail(this.orderData.id)}})},selectPayment(t){this.paying||(this.selectedPayment=t,h({success:()=>{i({title:"已选择支付宝",icon:"none",duration:1e3})}}))},goBack(){r()},goToOrderDetail(t){u({url:`/pages/show/show?id=${t}`})},goToOrderList(){f({url:"/pages/orders/orders"})},getOrderStatusText(t){switch(parseInt(t)){case 1:return"待支付";case 2:return"寄存中";case 3:return"已完成";case 4:return"已取消";case 5:return"超时";case 6:return"异常";default:return"未知状态"}},getDepositStatusText(t){switch(parseInt(t)){case 1:return"已支付";case 2:return"已退还";case 3:return"已扣除";default:return"未知状态"}}}},[["render",function(t,e,a,s,r,l){const o=T,n=y,i=v;return g(),p(n,{class:"pay-container"},{default:_((()=>[D(n,{class:"header-bar"},{default:_((()=>[D(n,{class:"back-btn",onClick:l.goBack,"hover-class":"back-btn-hover"},{default:_((()=>[D(o,{class:"back-icon"},{default:_((()=>[P("←")])),_:1})])),_:1},8,["onClick"]),D(o,{class:"header-title"},{default:_((()=>[P("订单支付")])),_:1}),D(n,{class:"header-placeholder"})])),_:1}),r.loading?(g(),p(n,{key:0,class:"loading-container"},{default:_((()=>[D(o,{class:"loading-text"},{default:_((()=>[P("加载中...")])),_:1})])),_:1})):(g(),p(n,{key:1,class:"order-summary"},{default:_((()=>[D(n,{class:"order-info"},{default:_((()=>[D(o,{class:"order-title"},{default:_((()=>[P(w(r.orderData.title),1)])),_:1}),D(n,{class:"order-details"},{default:_((()=>[D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("订单号：")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.order_number),1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("寄存网点：")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.storage_location_name),1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("柜子ID：")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.cabinet_id),1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("寄存时长：")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.actual_duration)+"小时",1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("订单状态：")])),_:1}),D(o,{class:b(["detail-value status","status-"+r.orderData.status])},{default:_((()=>[P(w(l.getOrderStatusText(r.orderData.status)),1)])),_:1},8,["class"])])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("押金状态：")])),_:1}),D(o,{class:b(["detail-value deposit","deposit-"+r.orderData.deposit_status])},{default:_((()=>[P(w(l.getDepositStatusText(r.orderData.deposit_status)),1)])),_:1},8,["class"])])),_:1})])),_:1})])),_:1}),D(n,{class:"amount-info"},{default:_((()=>[D(o,{class:"amount-label"},{default:_((()=>[P("应付金额")])),_:1}),D(o,{class:"amount-value"},{default:_((()=>[P("¥"+w(l.formatAmount(l.totalAmount)),1)])),_:1})])),_:1})])),_:1})),r.loading?k("",!0):(g(),p(n,{key:2,class:"fee-detail"},{default:_((()=>[D(n,{class:"detail-header"},{default:_((()=>[D(o,{class:"detail-title"},{default:_((()=>[P("费用明细")])),_:1})])),_:1}),D(n,{class:"detail-item"},{default:_((()=>[D(o,{class:"item-label"},{default:_((()=>[P("基础费用")])),_:1}),D(o,{class:"item-value"},{default:_((()=>[P("¥"+w(l.formatAmount(r.orderData.price)),1)])),_:1})])),_:1}),r.orderData.discount>0?(g(),p(n,{key:0,class:"detail-item"},{default:_((()=>[D(o,{class:"item-label"},{default:_((()=>[P("优惠金额")])),_:1}),D(o,{class:"item-value discount"},{default:_((()=>[P("-¥"+w(l.formatAmount(r.orderData.discount)),1)])),_:1})])),_:1})):k("",!0),D(n,{class:"detail-divider"}),D(n,{class:"detail-item total"},{default:_((()=>[D(o,{class:"item-label"},{default:_((()=>[P("实付金额")])),_:1}),D(o,{class:"item-value"},{default:_((()=>[P("¥"+w(l.formatAmount(r.orderData.amount_paid||l.totalAmount)),1)])),_:1})])),_:1})])),_:1})),r.loading?k("",!0):(g(),p(n,{key:3,class:"payment-methods"},{default:_((()=>[D(n,{class:"method-header"},{default:_((()=>[D(o,{class:"method-title"},{default:_((()=>[P("选择支付方式")])),_:1})])),_:1}),D(n,{class:b(["payment-option",{active:"alipay"===r.selectedPayment}]),onClick:e[0]||(e[0]=t=>l.selectPayment("alipay"))},{default:_((()=>[D(n,{class:"option-left"},{default:_((()=>[D(o,{class:"payment-icon"},{default:_((()=>[P("💰")])),_:1}),D(o,{class:"payment-name"},{default:_((()=>[P("支付宝")])),_:1})])),_:1}),D(n,{class:"option-right"},{default:_((()=>[D(o,{class:b(["radio",{checked:"alipay"===r.selectedPayment}])},null,8,["class"])])),_:1})])),_:1},8,["class"])])),_:1})),r.loading?k("",!0):(g(),p(n,{key:4,class:"pay-action"},{default:_((()=>[D(i,{class:b(["pay-btn",{disabled:!r.selectedPayment||r.paying}]),onClick:l.handlePay,disabled:!r.selectedPayment||r.paying},{default:_((()=>[P(w(r.paying?"处理中...":`立即支付 ¥${l.formatAmount(l.totalAmount)}`),1)])),_:1},8,["class","onClick","disabled"]),D(n,{class:"secondary-actions"},{default:_((()=>[D(o,{class:"link-text",onClick:e[1]||(e[1]=t=>l.goToOrderDetail(r.orderData.id))},{default:_((()=>[P("查看订单详情")])),_:1}),D(o,{class:"link-text",onClick:l.goToOrderList},{default:_((()=>[P("我的订单")])),_:1},8,["onClick"])])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-62f42dca"]]);export{C as default};
