import{g as t,J as e,r as a,m as s,p as r,b as l,V as o,h as n,a as i,c as d,T as c,v as u,d as m,W as h,s as f,e as p,w as _,i as y,o as g,f as D,j as P,t as w,n as b,x as k,k as T,l as v}from"./index-C_HCjYUn.js";import{_ as x}from"./_plugin-vue_export-helper.BCo6x5W8.js";const C=x({data:()=>({loading:!1,paying:!1,selectedPayment:"",errorMsg:"",orderData:{id:null,actual_duration:0,status:1,deposit_status:1,hourly_rate:0,locker_type:1,type_id:1,price:0,title:""}}),computed:{totalAmount(){if(this.orderData.amount_paid>0)return this.orderData.amount_paid;const t=this.orderData.price||0,e=this.orderData.discount||0;return Math.max(0,t-e)}},onLoad(t){t.id&&(this.orderData.id=parseInt(t.id),this.fetchOrderDetail()),this.checkPendingPayment()},onShow(){this.checkPendingPayment()},methods:{formatAmount:t=>(t||0).toFixed(2),checkPendingPayment(){try{const a=t("current_payment_info");if(a){const{startTime:t,orderNumber:s}=a;if(Date.now()-t>18e5)return void e("current_payment_info");s==this.orderData.id&&(console.log("å‘ç°å¾…å¤„ç†çš„æ”¯ä»˜ï¼Œæ£€æŸ¥ç»“æœ"),this.checkPaymentResult(a))}}catch(a){console.error("æ£€æŸ¥å¾…å¤„ç†æ”¯ä»˜å¤±è´¥:",a)}},fetchOrderDetail(){this.loading=!0,a({url:"http://127.0.0.1:8000/v1/orders/show",method:"POST",data:{id:this.orderData.id},success:t=>{if(console.log("åç«¯è¿”å›æ•°æ®:",t.data),t.data&&"object"==typeof t.data&&Array.isArray(t.data.order)&&t.data.order.length>0){const e=t.data.order[0];Number(e.price||e.amountPaid||e.totalPrice),this.orderData={...this.orderData,id:e.id,order_number:e.orderNumber,storage_location_name:e.storageLocationName,cabinet_id:e.cabinetId,actual_duration:Number(e.actualDuration||e.actual_duration)||0,scheduled_duration:Number(e.scheduledDuration||e.scheduled_duration)||0,status:parseInt(e.status)||0,deposit_status:parseInt(e.depositStatus)||0,price:Number(e.price)||0,discount:Number(e.discount)||0,amount_paid:Number(e.amountPaid)||0,locker_type:e.cabinetId,type_id:e.type_id||e.typeId||e.locker_type_id,title:`è®¢å•${e.id}æ”¯ä»˜`},console.log("è®¢å•æ•°æ®æ˜ å°„å®Œæˆ:",this.orderData)}else this.showError("è®¢å•æ•°æ®å¼‚å¸¸")},fail:t=>{var e,a;let s="ç½‘ç»œå¼‚å¸¸";(null==(e=t.errMsg)?void 0:e.includes("timeout"))?s="è¿æ¥æœåŠ¡å™¨è¶…æ—¶ï¼Œç‚¹å‡»é‡è¯•":(null==(a=t.errMsg)?void 0:a.includes("fail"))&&(s="ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•"),this.showError(s)},complete:()=>{this.loading=!1}})},showError(t){this.loading=!1,s({title:"æç¤º",content:t,showCancel:!0,cancelText:"è¿”å›",confirmText:"é‡è¯•",success:t=>{t.confirm?this.fetchOrderDetail():r()}})},async handlePay(){if(!this.paying&&this.selectedPayment&&this.validateOrder()){this.paying=!0,l({title:"å¤„ç†æ”¯ä»˜è¯·æ±‚...",mask:!0});try{const t={id:this.orderData.id,actual_duration:this.orderData.actual_duration,status:3,deposit_status:this.orderData.deposit_status,locker_type:this.orderData.locker_type,type_id:this.orderData.type_id,payment_method:this.selectedPayment,title:this.orderData.title,return_url:"app://payment/return",cancel_url:"app://payment/cancel",client_type:"uniapp",platform:o().platform};console.log("å‘é€æ”¯ä»˜è¯·æ±‚:",t);const e=await a({url:"http://127.0.0.1:8000/v1/order/update",method:"PUT",header:{"Content-Type":"application/json"},data:t,timeout:1e4});if(console.log("åç«¯å“åº”:",e),200!==e.statusCode)throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${e.statusCode}`);if(!e.data)throw new Error("æœåŠ¡å™¨è¿”å›æ•°æ®ä¸ºç©º");if(e.data.error)throw new Error(e.data.error);const s=e.data;console.log("åç«¯è¿”å›çš„æ”¯ä»˜ä¿¡æ¯:",s);const r=s.payUrl||s.PayUrl||s.result||s.url;if(!r)throw console.error("æ”¯ä»˜é“¾æ¥ä¸ºç©ºï¼Œå®Œæ•´å“åº”:",s),new Error("æ”¯ä»˜é“¾æ¥è·å–å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ");const l=s.payment_method||this.selectedPayment,i=s.order_number||s.order_id||this.orderData.id,d=s.amount||this.orderData.price;if(!this.isValidUrl(r))throw console.error("æ”¯ä»˜é“¾æ¥æ ¼å¼æ— æ•ˆ:",r),new Error("æ”¯ä»˜é“¾æ¥æ ¼å¼æ— æ•ˆ");n(),this.handlePaymentRedirect({payUrl:r,paymentMethod:l,orderNumber:i,amount:d,title:this.orderData.title})}catch(t){console.error("æ”¯ä»˜å¤„ç†é”™è¯¯:",t),n();let e="ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•";t.message?e=t.message:t.errMsg&&(e=t.errMsg.includes("timeout")?"è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥":t.errMsg.includes("fail")?"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•":t.errMsg),s({title:"æ”¯ä»˜å¤±è´¥",content:e,confirmText:"é‡è¯•",cancelText:"è¿”å›",success:t=>{t.confirm&&setTimeout((()=>{this.handlePay()}),1e3)}})}finally{this.paying=!1}}},validateOrder(){return this.orderData.id?!this.orderData.actual_duration||this.orderData.actual_duration<=0?(i({title:"å¯„å­˜æ—¶é•¿å¼‚å¸¸",icon:"none"}),!1):this.totalAmount<=0?(i({title:"è®¢å•é‡‘é¢å¼‚å¸¸",icon:"none"}),!1):!!this.orderData.title||(i({title:"è®¢å•æ ‡é¢˜ç¼ºå¤±",icon:"none"}),!1):(i({title:"è®¢å•IDç¼ºå¤±",icon:"none"}),!1)},isValidUrl(t){if(!t||"string"!=typeof t)return!1;try{return/^https?:\/\/.+/.test(t)}catch(e){return!1}},handlePaymentRedirect(t){const{payUrl:e,paymentMethod:a,orderNumber:r,amount:l,title:o}=t;console.log("å¤„ç†æ”¯ä»˜è·³è½¬:",t),s({title:"ç¡®è®¤æ”¯ä»˜",content:`è®¢å•å·ï¼š${r}\næ”¯ä»˜é‡‘é¢ï¼šÂ¥${l}\næ”¯ä»˜æ–¹å¼ï¼š${"alipay"===a?"æ”¯ä»˜å®":a}\n\nå³å°†è·³è½¬åˆ°å®‰å…¨æ”¯ä»˜ç¯å¢ƒ`,confirmText:"ç¡®è®¤æ”¯ä»˜",cancelText:"å–æ¶ˆ",success:a=>{a.confirm&&this.openPaymentUrl(e,t)}})},openPaymentUrl(t,e){console.log("æ‰“å¼€æ”¯ä»˜é“¾æ¥:",t);try{d("current_payment_info",{...e,startTime:Date.now()})}catch(a){console.error("ä¿å­˜æ”¯ä»˜ä¿¡æ¯å¤±è´¥:",a)}try{if("undefined"!=typeof window&&window.open){const a=window.open(t,"_blank");a?this.monitorPaymentWindow(a,e):this.showPaymentUrlFallback(t)}else"undefined"!=typeof plus&&plus.runtime?(plus.runtime.openURL(t,(e=>{console.error("æ‰“å¼€æ”¯ä»˜é“¾æ¥å¤±è´¥:",e),this.showPaymentUrlFallback(t)})),this.startPaymentResultCheck(e)):this.showPaymentUrlFallback(t)}catch(a){console.error("æ‰“å¼€æ”¯ä»˜é“¾æ¥å¼‚å¸¸:",a),this.showPaymentUrlFallback(t)}},showPaymentUrlFallback(t){c({data:t,success:()=>{s({title:"æ”¯ä»˜é“¾æ¥å·²å¤åˆ¶",content:"æ”¯ä»˜é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­ç²˜è´´æ‰“å¼€å®Œæˆæ”¯ä»˜",confirmText:"æˆ‘çŸ¥é“äº†",showCancel:!1,success:()=>{console.log("ç”¨æˆ·ç¡®è®¤å·²çŸ¥æ™“æ”¯ä»˜é“¾æ¥å¤åˆ¶")}})},fail:()=>{s({title:"æ”¯ä»˜é“¾æ¥",content:`è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š\n\n${t}`,confirmText:"æˆ‘çŸ¥é“äº†",showCancel:!1})}})},monitorPaymentWindow(t,e){if(!t)return void console.error("æ”¯ä»˜çª—å£å¯¹è±¡æ— æ•ˆ");const a=setInterval((()=>{try{t.closed&&(clearInterval(a),console.log("æ”¯ä»˜çª—å£å·²å…³é—­ï¼Œæ£€æŸ¥æ”¯ä»˜ç»“æœ"),this.checkPaymentResult(e))}catch(s){console.error("ç›‘å¬æ”¯ä»˜çª—å£å¤±è´¥:",s),clearInterval(a)}}),1e3);setTimeout((()=>{clearInterval(a);try{t&&!t.closed&&console.log("æ”¯ä»˜ç›‘å¬è¶…æ—¶")}catch(e){console.error("æ£€æŸ¥çª—å£çŠ¶æ€å¤±è´¥:",e)}}),6e5)},startPaymentResultCheck(t){setTimeout((()=>{this.checkPaymentResult(t)}),3e3)},async checkPaymentResult(t){if(t&&t.orderNumber)try{console.log("æ£€æŸ¥æ”¯ä»˜ç»“æœ:",t);const e=await a({url:"http://127.0.0.1:8000/v1/payment/status",method:"POST",header:{"Content-Type":"application/json"},data:{order_id:t.orderNumber,order_number:t.orderNumber},timeout:5e3});if(200===e.statusCode&&e.data){const a=e.data.status;"success"===a||2===a?this.handlePaymentSuccess(t):"failed"===a||3===a?this.handlePaymentFailed(t,e.data.message):this.handlePaymentUnknown(t)}else this.handlePaymentUnknown(t)}catch(e){console.error("æ£€æŸ¥æ”¯ä»˜ç»“æœå¤±è´¥:",e),console.log("ç”±äºç½‘ç»œé”™è¯¯ï¼Œè·³è¿‡æ”¯ä»˜çŠ¶æ€æ£€æŸ¥")}else console.error("æ”¯ä»˜ä¿¡æ¯æ— æ•ˆ:",t)},handlePaymentSuccess(t){e("current_payment_info"),this.orderData.status=2,i({title:"æ”¯ä»˜æˆåŠŸ",icon:"success",duration:2e3}),setTimeout((()=>{u({url:`/pages/show/show?id=${this.orderData.id}`,fail:()=>{r({delta:1,fail:()=>{m({url:"/pages/index/index"})}})}})}),2e3)},handlePaymentFailed(t,a){e("current_payment_info"),s({title:"æ”¯ä»˜å¤±è´¥",content:a||"æ”¯ä»˜æœªæˆåŠŸï¼Œè¯·é‡è¯•",confirmText:"é‡æ–°æ”¯ä»˜",cancelText:"è¿”å›",success:t=>{t.confirm&&this.handlePay()}})},handlePaymentUnknown(t){s({title:"æ”¯ä»˜çŠ¶æ€ç¡®è®¤",content:"æ— æ³•ç¡®è®¤æ”¯ä»˜çŠ¶æ€ï¼Œè¯·æ£€æŸ¥è®¢å•è¯¦æƒ…æˆ–è”ç³»å®¢æœ",confirmText:"æŸ¥çœ‹è®¢å•",cancelText:"è¿”å›",success:t=>{t.confirm&&this.goToOrderDetail(this.orderData.id)}})},selectPayment(t){this.paying||(this.selectedPayment=t,h({success:()=>{i({title:"å·²é€‰æ‹©æ”¯ä»˜å®",icon:"none",duration:1e3})}}))},goBack(){r()},goToOrderDetail(t){u({url:`/pages/show/show?id=${t}`})},goToOrderList(){f({url:"/pages/orders/orders"})},getOrderStatusText(t){switch(parseInt(t)){case 1:return"å¾…æ”¯ä»˜";case 2:return"å¯„å­˜ä¸­";case 3:return"å·²å®Œæˆ";case 4:return"å·²å–æ¶ˆ";case 5:return"è¶…æ—¶";case 6:return"å¼‚å¸¸";default:return"æœªçŸ¥çŠ¶æ€"}},getDepositStatusText(t){switch(parseInt(t)){case 1:return"å·²æ”¯ä»˜";case 2:return"å·²é€€è¿˜";case 3:return"å·²æ‰£é™¤";default:return"æœªçŸ¥çŠ¶æ€"}}}},[["render",function(t,e,a,s,r,l){const o=T,n=y,i=v;return g(),p(n,{class:"pay-container"},{default:_((()=>[D(n,{class:"header-bar"},{default:_((()=>[D(n,{class:"back-btn",onClick:l.goBack,"hover-class":"back-btn-hover"},{default:_((()=>[D(o,{class:"back-icon"},{default:_((()=>[P("â†")])),_:1})])),_:1},8,["onClick"]),D(o,{class:"header-title"},{default:_((()=>[P("è®¢å•æ”¯ä»˜")])),_:1}),D(n,{class:"header-placeholder"})])),_:1}),r.loading?(g(),p(n,{key:0,class:"loading-container"},{default:_((()=>[D(o,{class:"loading-text"},{default:_((()=>[P("åŠ è½½ä¸­...")])),_:1})])),_:1})):(g(),p(n,{key:1,class:"order-summary"},{default:_((()=>[D(n,{class:"order-info"},{default:_((()=>[D(o,{class:"order-title"},{default:_((()=>[P(w(r.orderData.title),1)])),_:1}),D(n,{class:"order-details"},{default:_((()=>[D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("è®¢å•å·ï¼š")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.order_number),1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("å¯„å­˜ç½‘ç‚¹ï¼š")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.storage_location_name),1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("æŸœå­IDï¼š")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.cabinet_id),1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("å¯„å­˜æ—¶é•¿ï¼š")])),_:1}),D(o,{class:"detail-value"},{default:_((()=>[P(w(r.orderData.actual_duration)+"å°æ—¶",1)])),_:1})])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("è®¢å•çŠ¶æ€ï¼š")])),_:1}),D(o,{class:b(["detail-value status","status-"+r.orderData.status])},{default:_((()=>[P(w(l.getOrderStatusText(r.orderData.status)),1)])),_:1},8,["class"])])),_:1}),D(n,{class:"detail-row"},{default:_((()=>[D(o,{class:"detail-label"},{default:_((()=>[P("æŠ¼é‡‘çŠ¶æ€ï¼š")])),_:1}),D(o,{class:b(["detail-value deposit","deposit-"+r.orderData.deposit_status])},{default:_((()=>[P(w(l.getDepositStatusText(r.orderData.deposit_status)),1)])),_:1},8,["class"])])),_:1})])),_:1})])),_:1}),D(n,{class:"amount-info"},{default:_((()=>[D(o,{class:"amount-label"},{default:_((()=>[P("åº”ä»˜é‡‘é¢")])),_:1}),D(o,{class:"amount-value"},{default:_((()=>[P("Â¥"+w(l.formatAmount(l.totalAmount)),1)])),_:1})])),_:1})])),_:1})),r.loading?k("",!0):(g(),p(n,{key:2,class:"fee-detail"},{default:_((()=>[D(n,{class:"detail-header"},{default:_((()=>[D(o,{class:"detail-title"},{default:_((()=>[P("è´¹ç”¨æ˜ç»†")])),_:1})])),_:1}),D(n,{class:"detail-item"},{default:_((()=>[D(o,{class:"item-label"},{default:_((()=>[P("åŸºç¡€è´¹ç”¨")])),_:1}),D(o,{class:"item-value"},{default:_((()=>[P("Â¥"+w(l.formatAmount(r.orderData.price)),1)])),_:1})])),_:1}),r.orderData.discount>0?(g(),p(n,{key:0,class:"detail-item"},{default:_((()=>[D(o,{class:"item-label"},{default:_((()=>[P("ä¼˜æƒ é‡‘é¢")])),_:1}),D(o,{class:"item-value discount"},{default:_((()=>[P("-Â¥"+w(l.formatAmount(r.orderData.discount)),1)])),_:1})])),_:1})):k("",!0),D(n,{class:"detail-divider"}),D(n,{class:"detail-item total"},{default:_((()=>[D(o,{class:"item-label"},{default:_((()=>[P("å®ä»˜é‡‘é¢")])),_:1}),D(o,{class:"item-value"},{default:_((()=>[P("Â¥"+w(l.formatAmount(r.orderData.amount_paid||l.totalAmount)),1)])),_:1})])),_:1})])),_:1})),r.loading?k("",!0):(g(),p(n,{key:3,class:"payment-methods"},{default:_((()=>[D(n,{class:"method-header"},{default:_((()=>[D(o,{class:"method-title"},{default:_((()=>[P("é€‰æ‹©æ”¯ä»˜æ–¹å¼")])),_:1})])),_:1}),D(n,{class:b(["payment-option",{active:"alipay"===r.selectedPayment}]),onClick:e[0]||(e[0]=t=>l.selectPayment("alipay"))},{default:_((()=>[D(n,{class:"option-left"},{default:_((()=>[D(o,{class:"payment-icon"},{default:_((()=>[P("ğŸ’°")])),_:1}),D(o,{class:"payment-name"},{default:_((()=>[P("æ”¯ä»˜å®")])),_:1})])),_:1}),D(n,{class:"option-right"},{default:_((()=>[D(o,{class:b(["radio",{checked:"alipay"===r.selectedPayment}])},null,8,["class"])])),_:1})])),_:1},8,["class"])])),_:1})),r.loading?k("",!0):(g(),p(n,{key:4,class:"pay-action"},{default:_((()=>[D(i,{class:b(["pay-btn",{disabled:!r.selectedPayment||r.paying}]),onClick:l.handlePay,disabled:!r.selectedPayment||r.paying},{default:_((()=>[P(w(r.paying?"å¤„ç†ä¸­...":`ç«‹å³æ”¯ä»˜ Â¥${l.formatAmount(l.totalAmount)}`),1)])),_:1},8,["class","onClick","disabled"]),D(n,{class:"secondary-actions"},{default:_((()=>[D(o,{class:"link-text",onClick:e[1]||(e[1]=t=>l.goToOrderDetail(r.orderData.id))},{default:_((()=>[P("æŸ¥çœ‹è®¢å•è¯¦æƒ…")])),_:1}),D(o,{class:"link-text",onClick:l.goToOrderList},{default:_((()=>[P("æˆ‘çš„è®¢å•")])),_:1},8,["onClick"])])),_:1})])),_:1}))])),_:1})}],["__scopeId","data-v-62f42dca"]]);export{C as default};
