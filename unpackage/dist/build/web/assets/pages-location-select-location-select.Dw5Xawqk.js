import{g as e,p as t,a,b as o,r as s,h as l,c as i,Q as n,m as c,e as r,w as d,i as u,o as h,f as g,j as m,x as f,C as _,D as L,F as p,t as b,k,I as v,l as P,S as y,n as C}from"./index-BAOqw0gZ.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";const I=w({data:()=>({locationList:[],filteredLocationList:[],searchKeyword:"",isSearching:!1,selectedLocationId:null,selectedLocation:null,currentPage:1,pageSize:20,hasMore:!0,loading:!1,fromPage:"",targetPage:"",apiBaseUrl:"http://localhost:8000"}),onLoad(t){console.log("=== 寄存点选择页面加载 ==="),console.log("页面参数:",t),this.fromPage=t.from||"",this.targetPage=t.target||"";const a=e("selectedLocationId");a&&(this.selectedLocationId=parseInt(a)),this.loadLocationList()},methods:{goBack(){t()},refreshData(){console.log("🔄 刷新寄存点数据"),this.currentPage=1,this.hasMore=!0,this.locationList=[],this.filteredLocationList=[],this.loadLocationList()},async loadLocationList(){if(!this.loading&&this.hasMore){this.loading=!0;try{const e=await this.requestLocationList();if(console.log("=== 处理寄存点响应数据 ==="),console.log("响应对象:",e),200!==e.code&&"200"!==e.code)throw new Error(e.msg||`服务器返回错误: ${e.code}`);{const t=e.locations||[];if(console.log("获取到的寄存点数据:",t),console.log("寄存点数量:",t.length),console.log("总数量:",e.total),0===t.length&&1===this.currentPage)return console.log("⚠️ 后端返回空数据，使用模拟数据"),void this.loadMockData();1===this.currentPage?this.locationList=t:this.locationList=[...this.locationList,...t],this.updateFilteredList(),this.hasMore=t.length===this.pageSize,console.log(`✅ 加载寄存点列表成功，当前页：${this.currentPage}，数据量：${t.length}`),1===this.currentPage&&(t.length>0?a({title:`加载成功，共${e.total||t.length}个寄存点`,icon:"success",duration:1500}):a({title:"后端暂无数据，使用模拟数据",icon:"none",duration:2e3}))}}catch(e){console.error("❌ 加载寄存点列表失败:",e),a({title:e.message||"加载失败",icon:"none",duration:2e3}),1===this.currentPage&&(console.log("⚠️ 使用模拟数据作为降级方案"),this.loadMockData())}finally{this.loading=!1}}},async requestLocationList(){console.log("=== 开始请求寄存点列表 ===");try{const e=await this.requestDirectLockerPoints();if(e&&e.locations&&e.locations.length>0)return console.log("✅ 直接查询成功，返回数据"),e}catch(e){console.log("⚠️ 直接查询失败，尝试城市搜索接口:",e.message)}return this.requestCitySearchAPI()},requestDirectLockerPoints(){return new Promise(((t,a)=>{console.log("=== 尝试直接查询寄存点数据 ===");const i=e("token")||e("adminToken")||"",n={keyword:this.searchKeyword||"",page:this.currentPage,page_size:this.pageSize},c=Object.keys(n).filter((e=>null!=n[e]&&""!==n[e])).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)).join("&"),r=`${this.apiBaseUrl}/api/locker-points/all?${c}`;console.log("直接查询API URL:",r),console.log("直接查询参数:",n),1===this.currentPage&&o({title:"加载寄存点数据...",mask:!0}),s({url:r,method:"GET",header:{"Content-Type":"application/json",Authorization:i?`Bearer ${i}`:""},timeout:1e4,success:e=>{console.log("直接查询API响应:",e),1===this.currentPage&&l(),200===e.statusCode&&e.data?t({code:200,msg:"查询成功",locations:e.data.items||[],total:e.data.total||0}):a(new Error("直接查询接口返回异常"))},fail:e=>{1===this.currentPage&&l(),console.log("直接查询接口失败:",e),a(new Error("直接查询接口不可用"))}})}))},requestCitySearchAPI(){return new Promise(((t,a)=>{console.log("=== 使用城市搜索API ===");const i=e("token")||e("adminToken")||"",n={city_name:"郑州",keyword:this.searchKeyword||"",page:this.currentPage,page_size:this.pageSize};console.log("完整请求参数:",n);const c=Object.keys(n).filter((e=>null!=n[e]&&""!==n[e])).map((e=>`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)).join("&"),r=`${this.apiBaseUrl}/api/nearby/city/search?${c}`;console.log("请求参数:",n),console.log("请求URL:",r),1===this.currentPage&&o({title:"加载寄存点数据...",mask:!0}),s({url:r,method:"GET",header:{"Content-Type":"application/json",Authorization:i?`Bearer ${i}`:""},timeout:15e3,success:e=>{var o;if(console.log("=== 寄存点列表API响应 ==="),console.log("HTTP状态码:",e.statusCode),console.log("响应数据:",e.data),1===this.currentPage&&l(),200===e.statusCode)if(e.data&&"object"==typeof e.data){console.log("✅ 响应数据格式正确");const a={code:200,msg:"查询成功",locations:e.data.items||[],total:e.data.total||0};t(a)}else console.error("❌ 响应数据格式错误:",e.data),a(new Error("响应数据格式错误"));else console.error("❌ HTTP状态码错误:",e.statusCode),a(new Error(`HTTP ${e.statusCode}: ${(null==(o=e.data)?void 0:o.msg)||"请求失败"}`))},fail:e=>{console.error("=== 寄存点列表API请求失败 ==="),console.error("错误对象:",e),1===this.currentPage&&l();let t="网络请求失败";e.errMsg&&(t=e.errMsg.includes("timeout")?"请求超时，请检查网络连接":e.errMsg.includes("fail")?"无法连接到服务器，请检查后端服务是否启动":e.errMsg),a(new Error(t))}})}))},loadMockData(){console.log("🎭 使用模拟寄存点数据（模拟数据库真实数据）");const e=[{id:1,name:"北京西站南广场寄存点",address:"南广场站出口东侧",latitude:39.8963,longitude:116.322,available_large:7,available_medium:13,available_small:22,open_time:"24小时",mobile:"13900139000"},{id:2,name:"上海虹桥站出发层寄存点",address:"出发层A17检票口附近",latitude:31.1979,longitude:121.3157,available_large:3,available_medium:6,available_small:10,open_time:"24小时",mobile:"13900139000"},{id:3,name:"广州南站东进站口寄存点",address:"东进站口南侧",latitude:23.0059,longitude:113.265,available_large:4,available_medium:7,available_small:11,open_time:"24小时",mobile:"13900139000"},{id:4,name:"郑州新途径",address:"郑州市中原区新途径大厦1楼",latitude:34.7466,longitude:113.6253,available_large:5,available_medium:8,available_small:12,open_time:"06:00-24:00",mobile:"0371-12345678"},{id:5,name:"郑州火车站",address:"郑州市二七区火车站西广场",latitude:34.7532,longitude:113.6401,available_large:3,available_medium:6,available_small:10,open_time:"24小时",mobile:"0371-87654321"},{id:6,name:"郑州东站",address:"郑州市郑东新区郑州东站",latitude:34.72,longitude:113.73,available_large:8,available_medium:15,available_small:20,open_time:"05:00-23:00",mobile:"0371-11223344"},{id:7,name:"郑州机场",address:"郑州市新郑区郑州机场T2航站楼",latitude:34.5197,longitude:113.8408,available_large:10,available_medium:20,available_small:25,open_time:"24小时",mobile:"0371-44556677"},{id:8,name:"河南大学",address:"郑州市金水区河南大学新校区",latitude:34.78,longitude:113.68,available_large:3,available_medium:5,available_small:8,open_time:"06:00-23:00",mobile:"0371-33445566"}];console.log("模拟数据（共%d个寄存点）:",e.length,e),this.locationList=e,this.updateFilteredList(),this.hasMore=!1,console.log("设置后的locationList:",this.locationList),console.log("设置后的filteredLocationList:",this.filteredLocationList),a({title:`数据库暂无数据，使用模拟数据（${e.length}个寄存点）`,icon:"none",duration:3e3})},loadMore(){!this.hasMore||this.loading||this.isSearching||(this.currentPage++,this.loadLocationList())},onSearchInput(){this.isSearching=this.searchKeyword.trim().length>0,this.updateFilteredList()},clearSearch(){this.searchKeyword="",this.isSearching=!1,this.updateFilteredList()},updateFilteredList(){if(this.isSearching){const e=this.searchKeyword.toLowerCase();this.filteredLocationList=this.locationList.filter((t=>t.name.toLowerCase().includes(e)||t.address&&t.address.toLowerCase().includes(e)))}else this.filteredLocationList=[...this.locationList]},selectLocation(e){console.log("选择寄存点:",e),this.selectedLocationId=e.id,this.selectedLocation=e},confirmSelection(){this.selectedLocation&&(console.log("确认选择寄存点:",this.selectedLocation),console.log("来源页面:",this.fromPage),console.log("目标页面:",this.targetPage),i("selectedLocationId",this.selectedLocation.id),i("selectedLocationName",this.selectedLocation.name),i("selectedLocationData",this.selectedLocation),a({title:`已选择：${this.selectedLocation.name}`,icon:"success",duration:1500}),setTimeout((()=>{"admin"===this.fromPage&&"cabinet-group"===this.targetPage?(console.log("跳转到柜组管理页面"),n({url:"/pages/cabinet-group/cabinet-group"})):(console.log("返回上一页"),t())}),1500))},getStatusClass:e=>({active:"status-active",inactive:"status-inactive",maintenance:"status-maintenance"}[e]||"status-active"),getStatusText:e=>({active:"营业中",inactive:"暂停营业",maintenance:"维护中"}[e]||"营业中"),testMockData(){console.log("🎭 手动加载模拟数据"),this.locationList=[],this.filteredLocationList=[],this.loadMockData()},getConfirmButtonText(){return"admin"===this.fromPage&&"cabinet-group"===this.targetPage?"确认选择并进入柜组管理":"确认选择"},async checkDatabase(){console.log("🔍 检查数据库状态"),o({title:"检查数据库...",mask:!0});try{console.log("测试直接查询接口...");const e=await this.requestDirectLockerPoints();l();const t=`数据库状态检查结果：\n\n直接查询API: ✅ 正常\n返回数据: ${e.locations.length} 个寄存点\n总数量: ${e.total}\n\n${0===e.locations.length?"⚠️ 数据库查询返回空数据\n可能原因:\n1. 数据库表为空\n2. 查询条件过滤了所有数据\n3. 表名或字段名不匹配":"✅ 数据库中有寄存点数据"}\n\n数据示例:\n${e.locations.slice(0,2).map((e=>`- ${e.name}: ${e.address}`)).join("\n")}`;c({title:"数据库状态",content:t,showCancel:!1,confirmText:"确定"})}catch(e){console.log("直接查询失败，尝试城市搜索接口...");try{const t=await this.requestCitySearchAPI();l();const a=`数据库状态检查结果：\n\n直接查询API: ❌ 失败 (${e.message})\n城市搜索API: ✅ 正常\n返回数据: ${t.locations.length} 个寄存点\n总数量: ${t.total}\n\n${0===t.locations.length?"⚠️ 城市搜索返回空数据\n可能原因:\n1. 城市表不存在\n2. 城市名称不匹配\n3. location_id关联错误":"✅ 城市搜索有数据"}`;c({title:"数据库状态",content:a,showCancel:!1,confirmText:"确定"})}catch(t){l(),c({title:"数据库检查失败",content:`两个接口都失败了：\n\n直接查询: ${e.message}\n城市搜索: ${t.message}\n\n可能原因:\n1. 后端服务未启动\n2. 数据库连接失败\n3. API接口异常\n4. 认证问题 (401错误)`,showCancel:!1,confirmText:"确定"})}}}}},[["render",function(e,t,a,o,s,l){const i=k,n=u,c=v,w=P,I=y;return h(),r(n,{class:"page"},{default:d((()=>[g(n,{class:"navbar"},{default:d((()=>[g(n,{class:"nav-left",onClick:l.goBack},{default:d((()=>[g(i,{class:"nav-icon"},{default:d((()=>[m("‹")])),_:1})])),_:1},8,["onClick"]),g(n,{class:"nav-center"},{default:d((()=>[g(i,{class:"nav-title"},{default:d((()=>[m("选择寄存点")])),_:1})])),_:1}),g(n,{class:"nav-right"},{default:d((()=>[g(i,{class:"nav-icon",onClick:l.checkDatabase},{default:d((()=>[m("🔍")])),_:1},8,["onClick"]),g(i,{class:"nav-icon",onClick:l.testMockData},{default:d((()=>[m("🎭")])),_:1},8,["onClick"]),g(i,{class:"nav-icon",onClick:l.refreshData},{default:d((()=>[m("⟲")])),_:1},8,["onClick"])])),_:1})])),_:1}),"admin"===s.fromPage&&"cabinet-group"===s.targetPage?(h(),r(n,{key:0,class:"operation-hint"},{default:d((()=>[g(i,{class:"hint-icon"},{default:d((()=>[m("📍")])),_:1}),g(i,{class:"hint-text"},{default:d((()=>[m("请选择要管理的寄存点，选择后将进入柜组管理页面")])),_:1})])),_:1})):f("",!0),g(n,{class:"search-section"},{default:d((()=>[g(n,{class:"search-box"},{default:d((()=>[g(i,{class:"search-icon"},{default:d((()=>[m("🔍")])),_:1}),g(c,{class:"search-input",placeholder:"搜索寄存点名称或地址",modelValue:s.searchKeyword,"onUpdate:modelValue":t[0]||(t[0]=e=>s.searchKeyword=e),onInput:l.onSearchInput},null,8,["modelValue","onInput"]),s.searchKeyword?(h(),r(i,{key:0,class:"clear-icon",onClick:l.clearSearch},{default:d((()=>[m("×")])),_:1},8,["onClick"])):f("",!0)])),_:1})])),_:1}),g(I,{class:"location-list","scroll-y":"true",onScrolltolower:l.loadMore},{default:d((()=>[(h(!0),_(p,null,L(s.filteredLocationList,(e=>(h(),r(n,{class:C(["location-item",{selected:s.selectedLocationId===e.id}]),key:e.id,onClick:t=>l.selectLocation(e)},{default:d((()=>[g(n,{class:"location-header"},{default:d((()=>[g(i,{class:"location-name"},{default:d((()=>[m(b(e.name),1)])),_:2},1024),g(i,{class:C(["location-status",l.getStatusClass(e.status)])},{default:d((()=>[m(b(l.getStatusText(e.status)),1)])),_:2},1032,["class"])])),_:2},1024),g(n,{class:"location-info"},{default:d((()=>[g(n,{class:"info-row"},{default:d((()=>[g(i,{class:"info-label"},{default:d((()=>[m("地址:")])),_:1}),g(i,{class:"info-value"},{default:d((()=>[m(b(e.address||"暂无地址"),1)])),_:2},1024)])),_:2},1024),g(n,{class:"info-row"},{default:d((()=>[g(i,{class:"info-label"},{default:d((()=>[m("营业时间:")])),_:1}),g(i,{class:"info-value"},{default:d((()=>[m(b(e.open_time||"24小时"),1)])),_:2},1024)])),_:2},1024),g(n,{class:"info-row"},{default:d((()=>[g(i,{class:"info-label"},{default:d((()=>[m("联系电话:")])),_:1}),g(i,{class:"info-value"},{default:d((()=>[m(b(e.mobile||"暂无"),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),g(n,{class:"cabinet-stats"},{default:d((()=>[g(n,{class:"stat-item"},{default:d((()=>[g(i,{class:"stat-label"},{default:d((()=>[m("大柜")])),_:1}),g(i,{class:"stat-value"},{default:d((()=>[m(b(e.available_large||0),1)])),_:2},1024)])),_:2},1024),g(n,{class:"stat-item"},{default:d((()=>[g(i,{class:"stat-label"},{default:d((()=>[m("中柜")])),_:1}),g(i,{class:"stat-value"},{default:d((()=>[m(b(e.available_medium||0),1)])),_:2},1024)])),_:2},1024),g(n,{class:"stat-item"},{default:d((()=>[g(i,{class:"stat-label"},{default:d((()=>[m("小柜")])),_:1}),g(i,{class:"stat-value"},{default:d((()=>[m(b(e.available_small||0),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),s.selectedLocationId===e.id?(h(),r(n,{key:0,class:"selected-icon"},{default:d((()=>[g(i,{class:"check-icon"},{default:d((()=>[m("✓")])),_:1})])),_:1})):f("",!0)])),_:2},1032,["onClick","class"])))),128)),s.hasMore&&!s.isSearching?(h(),r(n,{key:0,class:"load-more"},{default:d((()=>[s.loading?(h(),r(i,{key:1,class:"load-text"},{default:d((()=>[m("加载中...")])),_:1})):(h(),r(i,{key:0,class:"load-text"},{default:d((()=>[m("上拉加载更多")])),_:1}))])),_:1})):f("",!0),!s.hasMore&&s.locationList.length>0&&!s.isSearching?(h(),r(n,{key:1,class:"no-more"},{default:d((()=>[g(i,{class:"no-more-text"},{default:d((()=>[m("没有更多数据了")])),_:1})])),_:1})):f("",!0),s.loading||0!==s.filteredLocationList.length?f("",!0):(h(),r(n,{key:2,class:"empty-state"},{default:d((()=>[g(i,{class:"empty-icon"},{default:d((()=>[m("📍")])),_:1}),g(i,{class:"empty-text"},{default:d((()=>[m(b(s.isSearching?"未找到匹配的寄存点":"暂无寄存点数据"),1)])),_:1}),g(i,{class:"empty-desc"},{default:d((()=>[m(b(s.isSearching?"尝试修改搜索关键词":"后端API返回空数据，可能是数据库中没有寄存点数据"),1)])),_:1}),g(n,{class:"empty-actions"},{default:d((()=>[g(w,{class:"refresh-btn",onClick:l.refreshData},{default:d((()=>[m("重新请求API")])),_:1},8,["onClick"]),g(w,{class:"mock-btn",onClick:l.testMockData},{default:d((()=>[m("使用模拟数据")])),_:1},8,["onClick"])])),_:1})])),_:1}))])),_:1},8,["onScrolltolower"]),s.selectedLocationId?(h(),r(n,{key:1,class:"confirm-section"},{default:d((()=>[g(w,{class:"confirm-btn",onClick:l.confirmSelection},{default:d((()=>[m(b(l.getConfirmButtonText()),1)])),_:1},8,["onClick"])])),_:1})):f("",!0)])),_:1})}],["__scopeId","data-v-06e360b9"]]);export{I as default};
