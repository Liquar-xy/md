import{a as e,r as s,v as t,e as a,w as l,i,o as n,f as d,j as o,t as u,x as r,n as m,k as c,I as f,E as p,l as h,U as _}from"./index-C_HCjYUn.js";import{a as g}from"./api.D1TiY1OU.js";import{_ as k}from"./_plugin-vue_export-helper.BCo6x5W8.js";const b=k({data:()=>({isSubmitting:!1,taskTypeIndex:0,statusIndex:0,taskTypeOptions:["remind","check","handle"],statusOptions:["待执行","执行中","已完成","执行失败"],lastResult:null,remindForm:{id:"",task_type:"remind",status:1,mobile:""}}),onLoad(e){console.log("定时任务提醒页面加载",e),e.orderId&&(this.remindForm.id=e.orderId,console.log("接收到订单ID:",e.orderId)),e.orderNumber&&console.log("接收到订单号:",e.orderNumber),"expire"===e.type&&(console.log("这是到期提醒任务"),this.remindForm.task_type="remind",this.taskTypeIndex=0)},methods:{onTaskTypeChange(e){this.taskTypeIndex=e.detail.value,this.remindForm.task_type=this.taskTypeOptions[e.detail.value]},onStatusChange(e){this.statusIndex=e.detail.value,this.remindForm.status=parseInt(e.detail.value)+1},validateForm(){if(!this.remindForm.id||this.remindForm.id<=0)return e({title:"请输入有效的任务ID",icon:"none"}),!1;if(this.remindForm.mobile){if(!/^1[3-9]\d{9}$/.test(this.remindForm.mobile))return e({title:"请输入正确的手机号码",icon:"none"}),!1}return!0},async handleSubmit(){if(this.validateForm()){this.isSubmitting=!0,this.lastResult=null;try{const s={id:parseInt(this.remindForm.id),task_type:this.remindForm.task_type,status:this.remindForm.status,mobile:this.remindForm.mobile},t=await this.handleRemindTask(s);if(!t.success)throw new Error(t.message||"处理提醒任务失败");this.lastResult={success:!0,message:t.message||"提醒任务处理成功",details:t.details},e({title:"提醒发送成功",icon:"success"})}catch(s){console.error("处理提醒任务失败:",s);let t="处理提醒任务失败",a="";s.message.includes("任务ID不能为空")?t="任务ID不能为空":s.message.includes("到期提醒任务不存在或状态异常")?(t="任务不存在或状态异常",a="请检查任务ID和状态是否正确"):s.message.includes("关联的寄存订单不存在")?t="关联的寄存订单不存在":s.message.includes("关联用户不存在")?t="关联用户不存在":s.message.includes("订单状态无需提醒")?(t="订单状态无需提醒",a="任务已自动结束"):s.message&&(t=s.message),this.lastResult={success:!1,message:t,details:a},e({title:t,icon:"none",duration:3e3})}finally{this.isSubmitting=!1}}},handleRemindTask:e=>new Promise(((t,a)=>{console.log("发送提醒任务处理请求:",e),s({url:"http://127.0.0.1:8000/handle/remind/task",method:"POST",data:e,header:{"Content-Type":"application/json"},timeout:g.timeout||1e4,success:e=>{var s,l,i,n;if(console.log("提醒任务处理响应:",e),200===e.statusCode)t({success:!0,data:e.data,message:(null==(s=e.data)?void 0:s.msg)||"提醒任务处理成功",details:null==(l=e.data)?void 0:l.details});else{const s=(null==(i=e.data)?void 0:i.message)||(null==(n=e.data)?void 0:n.msg)||"请求失败";a(new Error(s))}},fail:e=>{console.error("网络请求失败:",e),a(new Error("网络连接失败，请检查网络设置"))}})})),handleReset(){this.remindForm={id:"",task_type:"remind",status:1,mobile:""},this.taskTypeIndex=0,this.statusIndex=0,this.lastResult=null,e({title:"表单已重置",icon:"success"})},goToIndex(){t({url:"/pages/index/index"})},fillTestData(){this.remindForm={id:10,task_type:"remind",status:1,mobile:"13661740781"},this.taskTypeIndex=0,this.statusIndex=0,e({title:"已填充测试数据",icon:"success"})}}},[["render",function(e,s,t,g,k,b){const y=c,I=i,x=f,T=p,F=h,v=_;return n(),a(I,{class:"remind-task-page"},{default:l((()=>[d(I,{class:"header"},{default:l((()=>[d(y,{class:"title"},{default:l((()=>[o("定时任务到期提醒")])),_:1}),d(I,{class:"tips"},{default:l((()=>[d(y,{class:"tip-text"},{default:l((()=>[o("• 处理寄存订单的到期提醒任务")])),_:1}),d(y,{class:"tip-text"},{default:l((()=>[o('• 仅对"寄存中"状态的订单发送提醒')])),_:1}),d(y,{class:"tip-text"},{default:l((()=>[o("• 支持短信通知用户")])),_:1})])),_:1})])),_:1}),d(v,{onSubmit:b.handleSubmit,class:"remind-form"},{default:l((()=>[d(I,{class:"form-section"},{default:l((()=>[d(y,{class:"section-title"},{default:l((()=>[o("任务信息")])),_:1}),d(I,{class:"form-item"},{default:l((()=>[d(y,{class:"label"},{default:l((()=>[o("任务ID")])),_:1}),d(x,{modelValue:k.remindForm.id,"onUpdate:modelValue":s[0]||(s[0]=e=>k.remindForm.id=e),type:"number",placeholder:"请输入任务ID",class:"input"},null,8,["modelValue"])])),_:1}),d(I,{class:"form-item"},{default:l((()=>[d(y,{class:"label"},{default:l((()=>[o("任务类型")])),_:1}),d(T,{onChange:b.onTaskTypeChange,value:k.taskTypeIndex,range:k.taskTypeOptions},{default:l((()=>[d(I,{class:"picker"},{default:l((()=>[o(u(k.taskTypeOptions[k.taskTypeIndex]),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1}),d(I,{class:"form-item"},{default:l((()=>[d(y,{class:"label"},{default:l((()=>[o("任务状态")])),_:1}),d(T,{onChange:b.onStatusChange,value:k.statusIndex,range:k.statusOptions},{default:l((()=>[d(I,{class:"picker"},{default:l((()=>[o(u(k.statusOptions[k.statusIndex]),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),d(I,{class:"form-section"},{default:l((()=>[d(y,{class:"section-title"},{default:l((()=>[o("用户信息")])),_:1}),d(I,{class:"form-item"},{default:l((()=>[d(y,{class:"label"},{default:l((()=>[o("手机号码")])),_:1}),d(x,{modelValue:k.remindForm.mobile,"onUpdate:modelValue":s[1]||(s[1]=e=>k.remindForm.mobile=e),type:"text",placeholder:"请输入手机号码",class:"input"},null,8,["modelValue"])])),_:1})])),_:1}),d(I,{class:"form-actions"},{default:l((()=>[d(F,{onClick:b.handleSubmit,disabled:k.isSubmitting,class:"submit-btn"},{default:l((()=>[o(u(k.isSubmitting?"处理中...":"发送提醒"),1)])),_:1},8,["onClick","disabled"]),d(F,{onClick:b.handleReset,class:"reset-btn"},{default:l((()=>[o("重置")])),_:1},8,["onClick"]),d(F,{onClick:b.goToIndex,class:"index-btn"},{default:l((()=>[o("返回首页")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["onSubmit"]),k.lastResult?(n(),a(I,{key:0,class:"result-section"},{default:l((()=>[d(y,{class:"result-title"},{default:l((()=>[o("处理结果")])),_:1}),d(I,{class:m(["result-content",k.lastResult.success?"success":"error"])},{default:l((()=>[d(y,{class:"result-text"},{default:l((()=>[o(u(k.lastResult.message),1)])),_:1}),k.lastResult.details?(n(),a(y,{key:0,class:"result-details"},{default:l((()=>[o(u(k.lastResult.details),1)])),_:1})):r("",!0)])),_:1},8,["class"])])),_:1})):r("",!0),k.isSubmitting?(n(),a(I,{key:1,class:"loading-overlay"},{default:l((()=>[d(I,{class:"loading-content"},{default:l((()=>[d(y,null,{default:l((()=>[o("正在处理提醒任务...")])),_:1})])),_:1})])),_:1})):r("",!0)])),_:1})}],["__scopeId","data-v-6f90702a"]]);export{b as default};
