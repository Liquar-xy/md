<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试附近页面功能</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
        }
        .error {
            border-left: 4px solid #dc3545;
        }
        .map-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin-top: 10px;
            position: relative;
        }
        .marker-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ 测试附近页面功能</h1>
        
        <div class="test-section">
            <h3>📍 完整流程测试</h3>
            <p>模拟nearby.vue页面的完整功能流程</p>
            
            <button class="test-button" onclick="testCompleteFlow()">🚀 测试完整流程</button>
            <button class="test-button" onclick="testDifferentCities()">🏙️ 测试多个城市</button>
            <button class="test-button" onclick="clearAll()">🗑️ 清空所有</button>
            
            <div id="flowResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>🗺️ 百度地图集成测试</h3>
            <p>测试百度地图加载和寄存点标记功能</p>
            
            <button class="test-button" onclick="initBaiduMap()">🗺️ 初始化地图</button>
            <button class="test-button" onclick="addTestMarkers()">📍 添加测试标记</button>
            <button class="test-button" onclick="testMapInteraction()">🖱️ 测试地图交互</button>
            
            <div id="mapResult" class="result" style="display: none;"></div>
            <div id="mapContainer" class="map-container" style="display: none;">
                <div id="markerInfo" class="marker-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const BAIDU_MAP_AK = '9jnxn6bIxVgX1u4KffC5Cc83dTMzzYIA';
        let mapInstance = null;
        let testMarkers = [];
        
        // 测试城市数据
        const testCities = [
            { name: '郑州', longitude: 113.6253, latitude: 34.7466 },
            { name: '北京', longitude: 116.4074, latitude: 39.9042 },
            { name: '上海', longitude: 121.4737, latitude: 31.2304 },
            { name: '广州', longitude: 113.2644, latitude: 23.1291 },
            { name: '深圳', longitude: 114.0579, latitude: 22.5431 }
        ];
        
        // 测试完整流程
        async function testCompleteFlow() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '开始测试完整流程...\n';
            
            try {
                // 1. 测试API连接
                resultDiv.textContent += '\n1. 测试API连接...\n';
                const testCity = testCities[0]; // 郑州
                
                const params = new URLSearchParams({
                    longitude: testCity.longitude.toString(),
                    latitude: testCity.latitude.toString(),
                    radius: '5',
                    limit: '20'
                });
                
                const apiUrl = `${API_BASE_URL}/api/nearby/my-nearby?${params.toString()}`;
                resultDiv.textContent += `请求URL: ${apiUrl}\n`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.textContent += `✅ API调用成功，状态码: ${response.status}\n`;
                
                // 2. 解析响应数据
                resultDiv.textContent += '\n2. 解析响应数据...\n';
                const nearbyPoints = data.nearby_points || [];
                const totalCount = data.total_count || 0;
                const searchRadius = data.search_radius || 5;
                const userLocation = data.user_location || null;
                
                resultDiv.textContent += `- 找到寄存点: ${nearbyPoints.length} 个\n`;
                resultDiv.textContent += `- 总数量: ${totalCount}\n`;
                resultDiv.textContent += `- 搜索半径: ${searchRadius} km\n`;
                resultDiv.textContent += `- 用户位置: ${userLocation ? '已获取' : '未获取'}\n`;
                
                // 3. 处理寄存点数据
                resultDiv.textContent += '\n3. 处理寄存点数据...\n';
                const processedPoints = nearbyPoints.map((point, index) => ({
                    id: point.id || point.point_id || `point_${index + 1}`,
                    name: point.name || point.point_name || `寄存点${index + 1}`,
                    large: parseInt(point.large_count || point.large || 0),
                    medium: parseInt(point.medium_count || point.medium || 0),
                    small: parseInt(point.small_count || point.small || 0),
                    address: point.address || point.location || '地址信息待完善',
                    distance: formatDistance(point.distance),
                    status: point.status || 'available',
                    longitude: parseFloat(point.longitude || 0),
                    latitude: parseFloat(point.latitude || 0)
                }));
                
                resultDiv.textContent += `✅ 数据处理完成，有效寄存点: ${processedPoints.length} 个\n`;
                
                // 4. 显示寄存点详情
                if (processedPoints.length > 0) {
                    resultDiv.textContent += '\n4. 寄存点详情:\n';
                    processedPoints.slice(0, 3).forEach((point, index) => {
                        resultDiv.textContent += `\n寄存点 ${index + 1}:\n`;
                        resultDiv.textContent += `  - 名称: ${point.name}\n`;
                        resultDiv.textContent += `  - 地址: ${point.address}\n`;
                        resultDiv.textContent += `  - 距离: ${point.distance}\n`;
                        resultDiv.textContent += `  - 柜子: 大${point.large} 中${point.medium} 小${point.small}\n`;
                        resultDiv.textContent += `  - 坐标: (${point.longitude}, ${point.latitude})\n`;
                        resultDiv.textContent += `  - 状态: ${point.status}\n`;
                    });
                    
                    if (processedPoints.length > 3) {
                        resultDiv.textContent += `\n... 还有 ${processedPoints.length - 3} 个寄存点\n`;
                    }
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent += '\n✅ 完整流程测试成功！';
                
                // 保存数据供地图使用
                window.testLockerPoints = processedPoints;
                
            } catch (error) {
                console.error('完整流程测试失败:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent += `\n❌ 测试失败: ${error.message}`;
            }
        }
        
        // 测试多个城市
        async function testDifferentCities() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '开始测试多个城市...\n';
            
            for (const city of testCities) {
                try {
                    resultDiv.textContent += `\n测试城市: ${city.name}\n`;
                    
                    const params = new URLSearchParams({
                        longitude: city.longitude.toString(),
                        latitude: city.latitude.toString(),
                        radius: '5',
                        limit: '10'
                    });
                    
                    const response = await fetch(`${API_BASE_URL}/api/nearby/my-nearby?${params.toString()}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const count = data.nearby_points ? data.nearby_points.length : 0;
                        resultDiv.textContent += `  ✅ ${city.name}: 找到 ${count} 个寄存点\n`;
                    } else {
                        resultDiv.textContent += `  ❌ ${city.name}: HTTP ${response.status}\n`;
                    }
                    
                } catch (error) {
                    resultDiv.textContent += `  ❌ ${city.name}: ${error.message}\n`;
                }
                
                // 添加延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            resultDiv.textContent += '\n✅ 多城市测试完成！';
        }
        
        // 初始化百度地图
        function initBaiduMap() {
            const resultDiv = document.getElementById('mapResult');
            const mapContainer = document.getElementById('mapContainer');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = '正在初始化百度地图...';
            
            if (window.BMap) {
                createMapInstance();
                return;
            }
            
            // 加载百度地图API
            const script = document.createElement('script');
            script.src = `https://api.map.baidu.com/api?v=3.0&ak=${BAIDU_MAP_AK}&callback=initMapCallback`;
            
            window.initMapCallback = function() {
                createMapInstance();
                delete window.initMapCallback;
            };
            
            script.onerror = function() {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ 百度地图API加载失败';
            };
            
            document.head.appendChild(script);
            
            function createMapInstance() {
                try {
                    mapContainer.style.display = 'block';
                    
                    mapInstance = new BMap.Map(mapContainer);
                    const point = new BMap.Point(113.6253, 34.7466); // 郑州
                    mapInstance.centerAndZoom(point, 13);
                    
                    // 添加控件
                    mapInstance.addControl(new BMap.NavigationControl());
                    mapInstance.addControl(new BMap.ScaleControl());
                    
                    // 启用交互
                    mapInstance.enableScrollWheelZoom(true);
                    mapInstance.enableDragging(true);
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '✅ 百度地图初始化成功！\n\n地图功能:\n- 滚轮缩放: 已启用\n- 拖拽: 已启用\n- 导航控件: 已添加\n- 比例尺: 已添加';
                    
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 地图初始化失败: ${error.message}`;
                }
            }
        }
        
        // 添加测试标记
        function addTestMarkers() {
            if (!mapInstance) {
                alert('请先初始化地图！');
                return;
            }
            
            const resultDiv = document.getElementById('mapResult');
            const markerInfo = document.getElementById('markerInfo');
            
            // 清除之前的标记
            testMarkers.forEach(marker => mapInstance.removeOverlay(marker));
            testMarkers = [];
            
            // 使用测试数据或API数据
            const lockerPoints = window.testLockerPoints || [
                { name: '测试寄存点1', longitude: 113.6253, latitude: 34.7466, address: '郑州市中心', large: 5, medium: 10, small: 15 },
                { name: '测试寄存点2', longitude: 113.6353, latitude: 34.7566, address: '郑州市东区', large: 3, medium: 8, small: 12 },
                { name: '测试寄存点3', longitude: 113.6153, latitude: 34.7366, address: '郑州市西区', large: 4, medium: 6, small: 10 }
            ];
            
            lockerPoints.forEach((locker, index) => {
                const point = new BMap.Point(locker.longitude, locker.latitude);
                const marker = new BMap.Marker(point);
                
                // 创建自定义图标
                const icon = new BMap.Icon(
                    'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28">
                            <rect x="2" y="2" width="24" height="24" fill="#FF6B35" stroke="#FFFFFF" stroke-width="2" rx="4"/>
                            <text x="14" y="18" text-anchor="middle" fill="white" font-size="12" font-weight="bold">柜</text>
                        </svg>
                    `),
                    new BMap.Size(28, 28),
                    { anchor: new BMap.Size(14, 14) }
                );
                marker.setIcon(icon);
                
                // 添加点击事件
                marker.addEventListener('click', () => {
                    markerInfo.style.display = 'block';
                    markerInfo.innerHTML = `
                        <strong>${locker.name}</strong><br>
                        地址: ${locker.address}<br>
                        大柜: ${locker.large}个<br>
                        中柜: ${locker.medium}个<br>
                        小柜: ${locker.small}个<br>
                        距离: ${locker.distance || '未知'}
                    `;
                });
                
                mapInstance.addOverlay(marker);
                testMarkers.push(marker);
            });
            
            resultDiv.className = 'result success';
            resultDiv.textContent = `✅ 已添加 ${lockerPoints.length} 个寄存点标记\n\n点击地图上的标记查看详情`;
        }
        
        // 测试地图交互
        function testMapInteraction() {
            if (!mapInstance) {
                alert('请先初始化地图！');
                return;
            }
            
            const resultDiv = document.getElementById('mapResult');
            
            // 添加地图事件监听
            mapInstance.addEventListener('click', (e) => {
                const point = e.point;
                resultDiv.textContent = `地图点击事件:\n经度: ${point.lng.toFixed(6)}\n纬度: ${point.lat.toFixed(6)}`;
            });
            
            mapInstance.addEventListener('dragend', () => {
                const center = mapInstance.getCenter();
                resultDiv.textContent = `地图拖拽结束:\n中心点: (${center.lng.toFixed(6)}, ${center.lat.toFixed(6)})`;
            });
            
            mapInstance.addEventListener('zoomend', () => {
                const zoom = mapInstance.getZoom();
                resultDiv.textContent = `地图缩放结束:\n缩放级别: ${zoom}`;
            });
            
            resultDiv.className = 'result success';
            resultDiv.textContent = '✅ 地图交互事件已启用\n\n尝试:\n- 点击地图\n- 拖拽地图\n- 滚轮缩放';
        }
        
        // 格式化距离
        function formatDistance(distance) {
            if (typeof distance === 'number') {
                if (distance < 1) {
                    return Math.round(distance * 1000) + 'm';
                } else {
                    return distance.toFixed(1) + 'km';
                }
            }
            return distance || '距离未知';
        }
        
        // 清空所有
        function clearAll() {
            document.getElementById('flowResult').style.display = 'none';
            document.getElementById('mapResult').style.display = 'none';
            document.getElementById('mapContainer').style.display = 'none';
            document.getElementById('markerInfo').style.display = 'none';
            
            if (mapInstance) {
                testMarkers.forEach(marker => mapInstance.removeOverlay(marker));
                testMarkers = [];
            }
        }
    </script>
</body>
</html>