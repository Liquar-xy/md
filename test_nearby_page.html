<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é™„è¿‘é¡µé¢åŠŸèƒ½</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056CC;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
        }
        .error {
            border-left: 4px solid #dc3545;
        }
        .map-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            margin-top: 10px;
            position: relative;
        }
        .marker-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ æµ‹è¯•é™„è¿‘é¡µé¢åŠŸèƒ½</h1>
        
        <div class="test-section">
            <h3>ğŸ“ å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <p>æ¨¡æ‹Ÿnearby.vueé¡µé¢çš„å®Œæ•´åŠŸèƒ½æµç¨‹</p>
            
            <button class="test-button" onclick="testCompleteFlow()">ğŸš€ æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <button class="test-button" onclick="testDifferentCities()">ğŸ™ï¸ æµ‹è¯•å¤šä¸ªåŸå¸‚</button>
            <button class="test-button" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            
            <div id="flowResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ—ºï¸ ç™¾åº¦åœ°å›¾é›†æˆæµ‹è¯•</h3>
            <p>æµ‹è¯•ç™¾åº¦åœ°å›¾åŠ è½½å’Œå¯„å­˜ç‚¹æ ‡è®°åŠŸèƒ½</p>
            
            <button class="test-button" onclick="initBaiduMap()">ğŸ—ºï¸ åˆå§‹åŒ–åœ°å›¾</button>
            <button class="test-button" onclick="addTestMarkers()">ğŸ“ æ·»åŠ æµ‹è¯•æ ‡è®°</button>
            <button class="test-button" onclick="testMapInteraction()">ğŸ–±ï¸ æµ‹è¯•åœ°å›¾äº¤äº’</button>
            
            <div id="mapResult" class="result" style="display: none;"></div>
            <div id="mapContainer" class="map-container" style="display: none;">
                <div id="markerInfo" class="marker-info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const BAIDU_MAP_AK = '9jnxn6bIxVgX1u4KffC5Cc83dTMzzYIA';
        let mapInstance = null;
        let testMarkers = [];
        
        // æµ‹è¯•åŸå¸‚æ•°æ®
        const testCities = [
            { name: 'éƒ‘å·', longitude: 113.6253, latitude: 34.7466 },
            { name: 'åŒ—äº¬', longitude: 116.4074, latitude: 39.9042 },
            { name: 'ä¸Šæµ·', longitude: 121.4737, latitude: 31.2304 },
            { name: 'å¹¿å·', longitude: 113.2644, latitude: 23.1291 },
            { name: 'æ·±åœ³', longitude: 114.0579, latitude: 22.5431 }
        ];
        
        // æµ‹è¯•å®Œæ•´æµç¨‹
        async function testCompleteFlow() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'å¼€å§‹æµ‹è¯•å®Œæ•´æµç¨‹...\n';
            
            try {
                // 1. æµ‹è¯•APIè¿æ¥
                resultDiv.textContent += '\n1. æµ‹è¯•APIè¿æ¥...\n';
                const testCity = testCities[0]; // éƒ‘å·
                
                const params = new URLSearchParams({
                    longitude: testCity.longitude.toString(),
                    latitude: testCity.latitude.toString(),
                    radius: '5',
                    limit: '20'
                });
                
                const apiUrl = `${API_BASE_URL}/api/nearby/my-nearby?${params.toString()}`;
                resultDiv.textContent += `è¯·æ±‚URL: ${apiUrl}\n`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.textContent += `âœ… APIè°ƒç”¨æˆåŠŸï¼ŒçŠ¶æ€ç : ${response.status}\n`;
                
                // 2. è§£æå“åº”æ•°æ®
                resultDiv.textContent += '\n2. è§£æå“åº”æ•°æ®...\n';
                const nearbyPoints = data.nearby_points || [];
                const totalCount = data.total_count || 0;
                const searchRadius = data.search_radius || 5;
                const userLocation = data.user_location || null;
                
                resultDiv.textContent += `- æ‰¾åˆ°å¯„å­˜ç‚¹: ${nearbyPoints.length} ä¸ª\n`;
                resultDiv.textContent += `- æ€»æ•°é‡: ${totalCount}\n`;
                resultDiv.textContent += `- æœç´¢åŠå¾„: ${searchRadius} km\n`;
                resultDiv.textContent += `- ç”¨æˆ·ä½ç½®: ${userLocation ? 'å·²è·å–' : 'æœªè·å–'}\n`;
                
                // 3. å¤„ç†å¯„å­˜ç‚¹æ•°æ®
                resultDiv.textContent += '\n3. å¤„ç†å¯„å­˜ç‚¹æ•°æ®...\n';
                const processedPoints = nearbyPoints.map((point, index) => ({
                    id: point.id || point.point_id || `point_${index + 1}`,
                    name: point.name || point.point_name || `å¯„å­˜ç‚¹${index + 1}`,
                    large: parseInt(point.large_count || point.large || 0),
                    medium: parseInt(point.medium_count || point.medium || 0),
                    small: parseInt(point.small_count || point.small || 0),
                    address: point.address || point.location || 'åœ°å€ä¿¡æ¯å¾…å®Œå–„',
                    distance: formatDistance(point.distance),
                    status: point.status || 'available',
                    longitude: parseFloat(point.longitude || 0),
                    latitude: parseFloat(point.latitude || 0)
                }));
                
                resultDiv.textContent += `âœ… æ•°æ®å¤„ç†å®Œæˆï¼Œæœ‰æ•ˆå¯„å­˜ç‚¹: ${processedPoints.length} ä¸ª\n`;
                
                // 4. æ˜¾ç¤ºå¯„å­˜ç‚¹è¯¦æƒ…
                if (processedPoints.length > 0) {
                    resultDiv.textContent += '\n4. å¯„å­˜ç‚¹è¯¦æƒ…:\n';
                    processedPoints.slice(0, 3).forEach((point, index) => {
                        resultDiv.textContent += `\nå¯„å­˜ç‚¹ ${index + 1}:\n`;
                        resultDiv.textContent += `  - åç§°: ${point.name}\n`;
                        resultDiv.textContent += `  - åœ°å€: ${point.address}\n`;
                        resultDiv.textContent += `  - è·ç¦»: ${point.distance}\n`;
                        resultDiv.textContent += `  - æŸœå­: å¤§${point.large} ä¸­${point.medium} å°${point.small}\n`;
                        resultDiv.textContent += `  - åæ ‡: (${point.longitude}, ${point.latitude})\n`;
                        resultDiv.textContent += `  - çŠ¶æ€: ${point.status}\n`;
                    });
                    
                    if (processedPoints.length > 3) {
                        resultDiv.textContent += `\n... è¿˜æœ‰ ${processedPoints.length - 3} ä¸ªå¯„å­˜ç‚¹\n`;
                    }
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent += '\nâœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼';
                
                // ä¿å­˜æ•°æ®ä¾›åœ°å›¾ä½¿ç”¨
                window.testLockerPoints = processedPoints;
                
            } catch (error) {
                console.error('å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•å¤šä¸ªåŸå¸‚
        async function testDifferentCities() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'å¼€å§‹æµ‹è¯•å¤šä¸ªåŸå¸‚...\n';
            
            for (const city of testCities) {
                try {
                    resultDiv.textContent += `\næµ‹è¯•åŸå¸‚: ${city.name}\n`;
                    
                    const params = new URLSearchParams({
                        longitude: city.longitude.toString(),
                        latitude: city.latitude.toString(),
                        radius: '5',
                        limit: '10'
                    });
                    
                    const response = await fetch(`${API_BASE_URL}/api/nearby/my-nearby?${params.toString()}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const count = data.nearby_points ? data.nearby_points.length : 0;
                        resultDiv.textContent += `  âœ… ${city.name}: æ‰¾åˆ° ${count} ä¸ªå¯„å­˜ç‚¹\n`;
                    } else {
                        resultDiv.textContent += `  âŒ ${city.name}: HTTP ${response.status}\n`;
                    }
                    
                } catch (error) {
                    resultDiv.textContent += `  âŒ ${city.name}: ${error.message}\n`;
                }
                
                // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            resultDiv.textContent += '\nâœ… å¤šåŸå¸‚æµ‹è¯•å®Œæˆï¼';
        }
        
        // åˆå§‹åŒ–ç™¾åº¦åœ°å›¾
        function initBaiduMap() {
            const resultDiv = document.getElementById('mapResult');
            const mapContainer = document.getElementById('mapContainer');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨åˆå§‹åŒ–ç™¾åº¦åœ°å›¾...';
            
            if (window.BMap) {
                createMapInstance();
                return;
            }
            
            // åŠ è½½ç™¾åº¦åœ°å›¾API
            const script = document.createElement('script');
            script.src = `https://api.map.baidu.com/api?v=3.0&ak=${BAIDU_MAP_AK}&callback=initMapCallback`;
            
            window.initMapCallback = function() {
                createMapInstance();
                delete window.initMapCallback;
            };
            
            script.onerror = function() {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥';
            };
            
            document.head.appendChild(script);
            
            function createMapInstance() {
                try {
                    mapContainer.style.display = 'block';
                    
                    mapInstance = new BMap.Map(mapContainer);
                    const point = new BMap.Point(113.6253, 34.7466); // éƒ‘å·
                    mapInstance.centerAndZoom(point, 13);
                    
                    // æ·»åŠ æ§ä»¶
                    mapInstance.addControl(new BMap.NavigationControl());
                    mapInstance.addControl(new BMap.ScaleControl());
                    
                    // å¯ç”¨äº¤äº’
                    mapInstance.enableScrollWheelZoom(true);
                    mapInstance.enableDragging(true);
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… ç™¾åº¦åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼\n\nåœ°å›¾åŠŸèƒ½:\n- æ»šè½®ç¼©æ”¾: å·²å¯ç”¨\n- æ‹–æ‹½: å·²å¯ç”¨\n- å¯¼èˆªæ§ä»¶: å·²æ·»åŠ \n- æ¯”ä¾‹å°º: å·²æ·»åŠ ';
                    
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
                }
            }
        }
        
        // æ·»åŠ æµ‹è¯•æ ‡è®°
        function addTestMarkers() {
            if (!mapInstance) {
                alert('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼');
                return;
            }
            
            const resultDiv = document.getElementById('mapResult');
            const markerInfo = document.getElementById('markerInfo');
            
            // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
            testMarkers.forEach(marker => mapInstance.removeOverlay(marker));
            testMarkers = [];
            
            // ä½¿ç”¨æµ‹è¯•æ•°æ®æˆ–APIæ•°æ®
            const lockerPoints = window.testLockerPoints || [
                { name: 'æµ‹è¯•å¯„å­˜ç‚¹1', longitude: 113.6253, latitude: 34.7466, address: 'éƒ‘å·å¸‚ä¸­å¿ƒ', large: 5, medium: 10, small: 15 },
                { name: 'æµ‹è¯•å¯„å­˜ç‚¹2', longitude: 113.6353, latitude: 34.7566, address: 'éƒ‘å·å¸‚ä¸œåŒº', large: 3, medium: 8, small: 12 },
                { name: 'æµ‹è¯•å¯„å­˜ç‚¹3', longitude: 113.6153, latitude: 34.7366, address: 'éƒ‘å·å¸‚è¥¿åŒº', large: 4, medium: 6, small: 10 }
            ];
            
            lockerPoints.forEach((locker, index) => {
                const point = new BMap.Point(locker.longitude, locker.latitude);
                const marker = new BMap.Marker(point);
                
                // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
                const icon = new BMap.Icon(
                    'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28">
                            <rect x="2" y="2" width="24" height="24" fill="#FF6B35" stroke="#FFFFFF" stroke-width="2" rx="4"/>
                            <text x="14" y="18" text-anchor="middle" fill="white" font-size="12" font-weight="bold">æŸœ</text>
                        </svg>
                    `),
                    new BMap.Size(28, 28),
                    { anchor: new BMap.Size(14, 14) }
                );
                marker.setIcon(icon);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.addEventListener('click', () => {
                    markerInfo.style.display = 'block';
                    markerInfo.innerHTML = `
                        <strong>${locker.name}</strong><br>
                        åœ°å€: ${locker.address}<br>
                        å¤§æŸœ: ${locker.large}ä¸ª<br>
                        ä¸­æŸœ: ${locker.medium}ä¸ª<br>
                        å°æŸœ: ${locker.small}ä¸ª<br>
                        è·ç¦»: ${locker.distance || 'æœªçŸ¥'}
                    `;
                });
                
                mapInstance.addOverlay(marker);
                testMarkers.push(marker);
            });
            
            resultDiv.className = 'result success';
            resultDiv.textContent = `âœ… å·²æ·»åŠ  ${lockerPoints.length} ä¸ªå¯„å­˜ç‚¹æ ‡è®°\n\nç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°æŸ¥çœ‹è¯¦æƒ…`;
        }
        
        // æµ‹è¯•åœ°å›¾äº¤äº’
        function testMapInteraction() {
            if (!mapInstance) {
                alert('è¯·å…ˆåˆå§‹åŒ–åœ°å›¾ï¼');
                return;
            }
            
            const resultDiv = document.getElementById('mapResult');
            
            // æ·»åŠ åœ°å›¾äº‹ä»¶ç›‘å¬
            mapInstance.addEventListener('click', (e) => {
                const point = e.point;
                resultDiv.textContent = `åœ°å›¾ç‚¹å‡»äº‹ä»¶:\nç»åº¦: ${point.lng.toFixed(6)}\nçº¬åº¦: ${point.lat.toFixed(6)}`;
            });
            
            mapInstance.addEventListener('dragend', () => {
                const center = mapInstance.getCenter();
                resultDiv.textContent = `åœ°å›¾æ‹–æ‹½ç»“æŸ:\nä¸­å¿ƒç‚¹: (${center.lng.toFixed(6)}, ${center.lat.toFixed(6)})`;
            });
            
            mapInstance.addEventListener('zoomend', () => {
                const zoom = mapInstance.getZoom();
                resultDiv.textContent = `åœ°å›¾ç¼©æ”¾ç»“æŸ:\nç¼©æ”¾çº§åˆ«: ${zoom}`;
            });
            
            resultDiv.className = 'result success';
            resultDiv.textContent = 'âœ… åœ°å›¾äº¤äº’äº‹ä»¶å·²å¯ç”¨\n\nå°è¯•:\n- ç‚¹å‡»åœ°å›¾\n- æ‹–æ‹½åœ°å›¾\n- æ»šè½®ç¼©æ”¾';
        }
        
        // æ ¼å¼åŒ–è·ç¦»
        function formatDistance(distance) {
            if (typeof distance === 'number') {
                if (distance < 1) {
                    return Math.round(distance * 1000) + 'm';
                } else {
                    return distance.toFixed(1) + 'km';
                }
            }
            return distance || 'è·ç¦»æœªçŸ¥';
        }
        
        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            document.getElementById('flowResult').style.display = 'none';
            document.getElementById('mapResult').style.display = 'none';
            document.getElementById('mapContainer').style.display = 'none';
            document.getElementById('markerInfo').style.display = 'none';
            
            if (mapInstance) {
                testMarkers.forEach(marker => mapInstance.removeOverlay(marker));
                testMarkers = [];
            }
        }
    </script>
</body>
</html>