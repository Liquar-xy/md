<!DOCTYPE html>
<html>
<head>
    <title>后端接口连接测试</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; }
        .test-button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .test-button.primary { background: #007bff; color: white; }
        .test-button.success { background: #28a745; color: white; }
        .test-button.danger { background: #dc3545; color: white; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-result.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .test-result.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔧 后端接口连接测试</h1>
    
    <div class="test-section">
        <h2>📡 API接口测试</h2>
        <p>点击下面的按钮测试各个后端接口是否正常工作：</p>
        
        <button class="test-button primary" onclick="testHealthCheck()">健康检查</button>
        <button class="test-button primary" onclick="testLockersDistribution()">寄存点分布</button>
        <button class="test-button primary" onclick="testNearbySearch()">附近搜索</button>
        <button class="test-button primary" onclick="testCitiesList()">城市列表</button>
        <button class="test-button success" onclick="testAllApis()">测试所有接口</button>
        
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h2>⚙️ 后端服务启动指南</h2>
        
        <h3>Go后端服务启动：</h3>
        <pre><code># 进入后端目录
cd ito-deposit

# 安装依赖
go mod tidy

# 启动服务
go run cmd/ito-deposit/main.go

# 或者使用Kratos命令
kratos run</code></pre>
        
        <h3>检查服务状态：</h3>
        <pre><code># 检查端口是否被占用
netstat -ano | findstr :8000

# 或者直接访问健康检查接口
curl http://localhost:8000/health</code></pre>
    </div>
    
    <div class="test-section">
        <h2>🔗 API接口列表</h2>
        
        <h3>用户认证相关：</h3>
        <ul>
            <li><code>POST /api/auth/login</code> - 用户登录</li>
            <li><code>POST /api/auth/admin/login</code> - 管理员登录</li>
            <li><code>POST /api/auth/sms</code> - 发送短信验证码</li>
        </ul>
        
        <h3>寄存点相关：</h3>
        <ul>
            <li><code>POST /api/lockers/distribution</code> - 获取寄存点分布</li>
            <li><code>GET /api/lockers/{id}</code> - 获取寄存点详情</li>
            <li><code>GET /api/nearby/city/search</code> - 附近搜索</li>
            <li><code>GET /api/nearby/my-nearby</code> - 我的附近</li>
            <li><code>GET /api/nearby/city/map</code> - 地图数据</li>
        </ul>
        
        <h3>其他接口：</h3>
        <ul>
            <li><code>GET /api/cities</code> - 城市列表</li>
            <li><code>POST /api/orders/list</code> - 订单列表</li>
            <li><code>POST /api/orders/detail</code> - 订单详情</li>
            <li><code>POST /api/admin/dashboard</code> - 管理员面板</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>🛠️ 常见问题解决</h2>
        
        <h3>问题1：ERR_CONNECTION_REFUSED</h3>
        <div class="error">
            <p><strong>原因</strong>：后端服务未启动或端口被占用</p>
            <p><strong>解决</strong>：</p>
            <ul>
                <li>检查后端服务是否启动</li>
                <li>确认端口8000没有被其他程序占用</li>
                <li>检查防火墙设置</li>
            </ul>
        </div>
        
        <h3>问题2：404 Not Found</h3>
        <div class="warning">
            <p><strong>原因</strong>：API路径不正确或后端路由未配置</p>
            <p><strong>解决</strong>：</p>
            <ul>
                <li>检查API路径是否正确</li>
                <li>确认后端路由配置</li>
                <li>查看后端日志</li>
            </ul>
        </div>
        
        <h3>问题3：CORS跨域错误</h3>
        <div class="info">
            <p><strong>原因</strong>：后端未配置CORS或配置不正确</p>
            <p><strong>解决</strong>：</p>
            <ul>
                <li>在后端添加CORS中间件</li>
                <li>允许前端域名访问</li>
                <li>配置正确的请求头</li>
            </ul>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        function addTestResult(message, isSuccess = true) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
        
        async function testHealthCheck() {
            clearResults();
            addTestResult('🔍 正在测试健康检查接口...', true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    const data = await response.text();
                    addTestResult(`✅ 健康检查成功: ${data}`, true);
                } else {
                    addTestResult(`❌ 健康检查失败: HTTP ${response.status}`, false);
                }
            } catch (error) {
                addTestResult(`❌ 健康检查失败: ${error.message}`, false);
                addTestResult('💡 请确保后端服务已启动在端口8000', false);
            }
        }
        
        async function testLockersDistribution() {
            addTestResult('🔍 正在测试寄存点分布接口...', true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/lockers/distribution`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city: '郑州',
                        longitude: 113.6253,
                        latitude: 34.7466,
                        radius: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addTestResult(`✅ 寄存点分布接口成功: 返回${data.lockers ? data.lockers.length : 0}个寄存点`, true);
                } else {
                    addTestResult(`❌ 寄存点分布接口失败: HTTP ${response.status}`, false);
                }
            } catch (error) {
                addTestResult(`❌ 寄存点分布接口失败: ${error.message}`, false);
            }
        }
        
        async function testNearbySearch() {
            addTestResult('🔍 正在测试附近搜索接口...', true);
            
            try {
                const params = new URLSearchParams({
                    city_name: '郑州',
                    keyword: '火车站',
                    page: '1',
                    page_size: '10'
                });
                
                const response = await fetch(`${API_BASE_URL}/api/nearby/city/search?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addTestResult(`✅ 附近搜索接口成功: 找到相关结果`, true);
                } else {
                    addTestResult(`❌ 附近搜索接口失败: HTTP ${response.status}`, false);
                }
            } catch (error) {
                addTestResult(`❌ 附近搜索接口失败: ${error.message}`, false);
            }
        }
        
        async function testCitiesList() {
            addTestResult('🔍 正在测试城市列表接口...', true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/cities`);
                
                if (response.ok) {
                    const data = await response.json();
                    addTestResult(`✅ 城市列表接口成功: 返回城市数据`, true);
                } else {
                    addTestResult(`❌ 城市列表接口失败: HTTP ${response.status}`, false);
                }
            } catch (error) {
                addTestResult(`❌ 城市列表接口失败: ${error.message}`, false);
            }
        }
        
        async function testAllApis() {
            clearResults();
            addTestResult('🚀 开始测试所有API接口...', true);
            
            await testHealthCheck();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testLockersDistribution();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testNearbySearch();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCitiesList();
            
            addTestResult('✅ 所有接口测试完成！', true);
        }
        
        // 页面加载时自动进行健康检查
        window.onload = function() {
            setTimeout(testHealthCheck, 1000);
        };
    </script>
</body>
</html>